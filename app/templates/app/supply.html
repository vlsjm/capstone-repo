{% load static %}
{% load currency_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Supply List</title>
  <!-- jQuery first -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <!-- Select2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="stylesheet" href="{% static 'css/barcode.css' %}">
  {% csrf_token %}
  <style>
    


    .close {
      position: absolute;
      top: 15px;
      right: 25px;
      font-size: 28px;
      font-weight: bold;
      color: #888;
      cursor: pointer;
      z-index: 1001;
    }

    .close:hover {
      color: #152d64;
    }

    /* Form Controls */
    .form-control {
      display: block;
      width: 100%;
      padding: 0.375rem 0.75rem;
      font-size: 1rem;
      font-weight: 400;
      line-height: 1.5;
      color: #212529;
      background-color: #fff;
      background-clip: padding-box;
      border: 1px solid #ced4da;
      border-radius: 0.25rem;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .form-control:focus {
      color: #212529;
      background-color: #fff;
      border-color: #86b7fe;
      outline: 0;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    /* Custom Select Styles */
    .custom-select {
      background-color: #fff;
      border: 1px solid #ced4da;
      border-radius: 0.25rem;
    }

    .custom-select .select2-selection {
      border: none !important;
      background-color: transparent !important;
      height: auto !important;
      min-height: 38px;
    }

    .custom-select .select2-selection__rendered {
      line-height: 38px !important;
      padding-left: 12px !important;
    }

    .custom-select .select2-selection__arrow {
      height: 38px !important;
    }

    /* Form Groups */
    form p {
      margin-bottom: 1rem;
    }

    form label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #212529;
    }

    /* Help Text */
    form .helptext {
      display: block;
      margin-top: 0.25rem;
      font-size: 0.875em;
      color: #6c757d;
    }

    /* Submit Button */
    .submit-btn {
      display: inline-block;
      font-weight: 400;
      text-align: center;
      vertical-align: middle;
      cursor: pointer;
      padding: 0.375rem 0.75rem;
      font-size: 1rem;
      border-radius: 0.25rem;
      color: #fff;
      background-color: #152d64;
      border: 1px solid #152d64;
      transition: all 0.15s ease-in-out;
    }

    .submit-btn:hover {
      background-color: #0d1b3e;
      border-color: #0d1b3e;
    }

    /* History Modal Styles */
.history-modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
}

.history-modal-content {
  background-color: #fff;
  margin: 2% auto;
  padding: 25px;
  border: 1px solid #888;
  width: 90%;
  max-width: 1400px;
  border-radius: 12px;
  position: relative;
  max-height: 90vh;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #e9ecef;
}

.history-header h3 {
  color: #152d64;
  margin: 0;
  font-size: 24px;
  font-weight: 600;
}

.history-filter-controls {
  display: flex;
  gap: 15px;
  align-items: center;
}

.history-search-input {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
  width: 250px;
  transition: all 0.3s ease;
}

.history-search-input:focus {
  outline: none;
  border-color: #152d64;
  box-shadow: 0 0 5px rgba(21, 45, 100, 0.2);
}

.history-filter-select {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
  background-color: white;
  cursor: pointer;
  min-width: 150px;
}

.history-filter-select:focus {
  outline: none;
  border-color: #152d64;
  box-shadow: 0 0 5px rgba(21, 45, 100, 0.2);
}

.history-summary {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 15px;
  background-color: #f8f9fa;
  border-radius: 6px;
  margin-bottom: 15px;
  font-size: 14px;
  color: #495057;
}

.history-count, .history-filtered-count {
  display: flex;
  align-items: center;
  gap: 5px;
}

#historyContent {
  max-height: 650px;
  overflow-y: auto;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  background-color: #fff;
}

.history-table {
  width: 100%;
  border-collapse: collapse;
  margin: 0;
  table-layout: fixed;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.history-table th {
  background-color: #152d64;
  color: white;
  padding: 12px 10px;
  text-align: left;
  font-size: 13px;
  font-weight: 600;
  border-bottom: 2px solid #1a3a7a;
  position: sticky;
  top: 0;
  z-index: 10;
}

.history-table td {
  padding: 12px 10px;
  border-bottom: 1px solid #e9ecef;
  font-size: 13px;
  line-height: 1.5;
  vertical-align: top;
  word-wrap: break-word;
}

/* Enhanced column widths for better information display */
.history-table .col-datetime { width: 12%; }
.history-table .col-action { width: 12%; }
.history-table .col-description { width: 30%; }
.history-table .col-values { width: 28%; }
.history-table .col-user { width: 10%; }
.history-table .col-remarks { width: 8%; }

/* Action type badges */
.action-badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.action-badge.create {
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.action-badge.update {
  background-color: #cce7ff;
  color: #004085;
  border: 1px solid #b3d7ff;
}

.action-badge.quantity_update {
  background-color: #fff3cd;
  color: #856404;
  border: 1px solid #ffeaa7;
}

/* Value change styling */
.value-change {
  font-family: 'Courier New', monospace;
  font-size: 12px;
  padding: 4px 6px;
  background-color: #f8f9fa;
  border-radius: 4px;
  border-left: 3px solid #007bff;
}

.value-old {
  color: #dc3545;
  text-decoration: line-through;
}

.value-new {
  color: #28a745;
  font-weight: 600;
}

.value-arrow {
  color: #6c757d;
  margin: 0 6px;
}

/* Row hover effects */
.history-table tbody tr:hover {
  background-color: #f8f9fa;
}

.history-table tbody tr:nth-child(even) {
  background-color: #fbfbfb;
}

.history-table tbody tr:nth-child(even):hover {
  background-color: #f0f0f0;
}

/* No results styling */
.history-no-results {
  text-align: center;
  padding: 40px;
  color: #6c757d;
}

.history-no-results i {
  font-size: 48px;
  margin-bottom: 15px;
  opacity: 0.5;
}

.history-no-results p {
  font-size: 16px;
  margin: 0;
}

/* Responsive adjustments */
@media (max-width: 1200px) {
  .history-modal-content {
    width: 95%;
    margin: 1% auto;
  }
  
  .history-filter-controls {
    flex-direction: column;
    gap: 10px;
  }
  
  .history-search-input {
    width: 200px;
  }
}

/* Custom scrollbar styling for history section */
#historyContent::-webkit-scrollbar {
  width: 8px;
}

#historyContent::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

#historyContent::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 4px;
}

#historyContent::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* Fix Select2 text weight */
.select2-container--default .select2-selection--single,
.select2-container--default .select2-results__option {
  font-weight: normal !important;
}

/* Optional: also fix placeholder */
.select2-container--default .select2-selection__placeholder {
  font-weight: normal !important;
  color: #888; /* lighter placeholder color */
}

/* Style Select2 dropdown in modify modal */
.select2-container--default .select2-selection--single {
  height: 38px;
  padding: 5px;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.select2-container--default .select2-selection--single .select2-selection__arrow {
  height: 36px;
}

.select2-container--default .select2-search--dropdown .select2-search__field {
  padding: 8px;
  border: 1px solid #ddd;
}

.select2-dropdown {
  border: 1px solid #ddd;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.select2-container--default .select2-results__option--highlighted[aria-selected] {
  background-color: #152d64;
}

/* Ensure Select2 dropdown is above modal */
.select2-dropdown {
  z-index: 1051;
}

/* Add these new styles */
.search-container {
  margin: 20px 0;
  display: flex;
  justify-content: flex-end;
}

.search-input {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  width: 300px;
  font-size: 14px;
}

.search-input:focus {
  outline: none;
  border-color: #152d64;
  box-shadow: 0 0 5px rgba(21, 45, 100, 0.2);
}

/* Hide rows that don't match search */
tr.hidden {
  display: none;
}

/* Update search container styles */
.top-controls {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 15px;
  margin-bottom: 20px;
  justify-content: space-between;
}

.top-controls .search-container {
  flex: 0 0 auto;
}

.top-controls .simple-filter-container {
  flex: 0 0 auto;
}

/* Simple Filter Styles */
.simple-filter-container {
  position: relative;
  display: inline-block;
  margin-right: 10px;
}

.simple-filter-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: #f8f9fa;
  border: 2px solid #e1e5e9;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  color: #495057;
  transition: all 0.3s ease;
  position: relative;
}

.simple-filter-toggle:hover {
  background: #fff;
  border-color: #152d64;
  color: #152d64;
}

.simple-filter-toggle.active {
  background: #152d64;
  border-color: #152d64;
  color: white;
}

.filter-count {
  background: #dc3545;
  color: white;
  border-radius: 50%;
  padding: 2px 6px;
  font-size: 11px;
  font-weight: 600;
  min-width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 4px;
}

.filter-count:empty {
  display: none;
}

.filter-chevron {
  font-size: 12px;
  transition: transform 0.3s ease;
}

.simple-filter-toggle.active .filter-chevron {
  transform: rotate(180deg);
}

.simple-filter-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  background: white;
  border: 2px solid #e1e5e9;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  min-width: 650px;
  max-width: 800px;
  display: none;
  margin-top: 4px;
  padding: 24px;
}

.simple-filter-dropdown.show {
  display: block;
}

.simple-filter-group {
  border-bottom: 1px solid #f1f3f4;
}

.simple-filter-group:last-child {
  border-bottom: none;
}

.simple-filter-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  background: #f8f9fa;
  font-weight: 600;
  font-size: 13px;
  color: #495057;
  border-bottom: 1px solid #e9ecef;
}

.simple-filter-options {
  padding: 8px 0;
}

.simple-filter-option {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 16px;
  cursor: pointer;
  transition: background-color 0.2s ease;
  margin: 0;
  font-weight: normal;
}

.simple-filter-option:hover {
  background: #f8f9fa;
}

.simple-filter-option input[type="checkbox"],
.simple-filter-option input[type="radio"] {
  margin: 0;
  cursor: pointer;
}

.filter-text {
  font-size: 14px;
  color: #495057;
  user-select: none;
}

/* Filter Grid Layout */
.filter-grid-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  align-items: start;
}

.filter-column {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* Category Filter Scrollable */
.category-filter-options {
  max-height: 600px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: #cbd5e0 #f7fafc;
}

.category-filter-options::-webkit-scrollbar {
  width: 6px;
}

.category-filter-options::-webkit-scrollbar-track {
  background: #f7fafc;
  border-radius: 6px;
}

.category-filter-options::-webkit-scrollbar-thumb {
  background: #cbd5e0;
  border-radius: 6px;
}

.category-filter-options::-webkit-scrollbar-thumb:hover {
  background: #a0aec0;
}

.button-container {
  display: flex;
  gap: 10px;
}

.search-container {
  position: relative;
  flex-grow: 1;
  max-width: 400px;
  background: #f8f9fa;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  transition: all 0.3s ease;
  border: 2px solid transparent;
  overflow: hidden;
}

.search-container:hover {
  background: #fff;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
}

.search-container:focus-within {
  background: #fff;
  box-shadow: 0 4px 12px rgba(21, 45, 100, 0.15);
  border-color: #152d64;
}

.search-icon {
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: #152d64;
  font-size: 15px;
  transition: color 0.3s ease;
  z-index: 1;
}

.search-container:focus-within .search-icon {
  color: #1e3d8a;
}

.search-input {
  width: 100%;
  padding: 12px 16px 12px 45px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  background: transparent;
  transition: all 0.3s ease;
}

.search-input:focus {
  outline: none;
}

.search-input::placeholder {
  color: #6c757d;
  opacity: 0.8;
  font-weight: 400;
}

.search-container:focus-within .search-input::placeholder {
  opacity: 0.6;
}

/* Hide rows that don't match search */
tr.hidden {
  display: none;
}

/* Print Barcode Button */
.print-barcodes-btn {
    background-color: #152d64;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    margin: 10px 0;
    transition: background-color 0.3s;
}

.print-barcodes-btn:hover {
    background-color: #1e3d8a;
}

.print-btn {
    width: 35px;
    height: 35px;
    border-radius: 4px;
    border: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background-color: #28a745;
    color: white;
    text-decoration: none;
}

.print-btn:hover {
    background-color: #218838;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transform: none !important;
}

.print-btn i {
    font-size: 1.2em;
}
.cancel-btn {
  background-color: #878c99;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s;
  height: 50px;
  margin-top: 20px;
}


@media print {
    body * {
        visibility: hidden;
    }
    .barcode-container, .barcode-container * {
        visibility: visible;
    }
    .barcode-container {
        position: relative;
        left: 0;
        top: 0;
    }
    .print-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        padding: 20px;
    }
}

/* Inside the supply form */
.input-group {
  display: flex;
  gap: 10px;
  align-items: start;
}

.input-group select {
  flex: 1;
}

.input-group button {
  white-space: nowrap;
}

/* Add these new styles */
.filter-container {
  display: flex;
  gap: 10px;
  margin-right: 10px;
}

.filter-select {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  background-color: white;
  min-width: 180px;
  cursor: pointer;
  font-size: 14px;
}

.filter-select:focus {
  outline: none;
  border-color: #152d64;
  box-shadow: 0 0 5px rgba(21, 45, 100, 0.2);
}

.filter-select option {
  padding: 8px;
}

/* Checkbox styling for forms */
.form-check {
  display: flex;
  align-items: center;
  margin-top: 5px;
}

.form-check-input {
  width: 18px !important;
  height: 18px !important;
  margin-right: 8px;
  cursor: pointer;
}

.form-check-label {
  cursor: pointer;
  font-size: 14px;
  color: #555;
}

/* Add Supply Modal specific styles */
#addSupplyModal .modal-content {
  padding: 40px;
}

#addSupplyModal form {
  flex-direction: column;
  gap: 20px;
}

#addSupplyModal .form-group {
  margin-bottom: 15px;
}

#addSupplyModal label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  color: #333;
}

#addSupplyModal input[type="text"],
#addSupplyModal input[type="number"],
#addSupplyModal input[type="date"],
#addSupplyModal input[type="checkbox"],
#addSupplyModal textarea,
#addSupplyModal select {
  width: 95%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

#addSupplyModal input:focus,
#addSupplyModal textarea:focus,
#addSupplyModal select:focus {
  outline: none;
  border-color: #152d64;
  box-shadow: 0 0 0 2px rgba(21, 45, 100, 0.1);
}

#addSupplyModal .submit-btn {
  margin-top: 20px;
  padding: 10px 20px;
}

/* Ensure Select2 dropdowns appear above the modal */
.select2-container {
  z-index: 1051;
}

/* Checkbox group styles */
.checkbox-group {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin: 15px 0;
  padding: 15px;
  background-color: #f8f9fa;
  border-radius: 8px;
}

.checkbox-group label {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  font-weight: normal;
}

.checkbox-group input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

/* Export button styles */
#openExportModalBtn {
  background-color: #28a745;
  border-color: #28a745;
}

#openExportModalBtn:hover {
  background-color: #218838;
  border-color: #218838;
}

/* Action button hover effects */
.action-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.action-btn.primary-btn:hover {
  background-color: #1e3d8a !important;
}

.action-btn.secondary-btn:hover {
  background-color: #5a6779 !important;
}

.action-btn.success-btn:hover {
  background-color: #218838 !important;
}

/* Button group layout */
.button-group {
  display: flex;
  gap: 8px;
  align-items: center;
}

/* Action buttons base styles */
.action-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  border: none;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
}

/* Table action buttons */
.action-btn.edit-btn,
.action-btn.history-btn,
.action-btn.print-btn {
  width: 32px;
  height: 32px;
  justify-content: center;
}

.action-btn.edit-btn { background-color: #152d64; }
.action-btn.history-btn { background-color: #4a5568; }
.action-btn.print-btn { background-color: #28a745; }

/* Common styles for all action buttons */
.action-btn {
  color: white;
  font-weight: 500;
}

/* Remove form margins in button groups */
.button-group form {
  margin: 0;
}

/* Actions Dropdown Styles */
.actions-dropdown {
  position: relative;
  display: inline-block;
}

.actions-dropdown-toggle {
  background-color: #152d64;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 40px;
  height: 36px;
}

.actions-dropdown-toggle:hover {
  background-color: #1a3a7a;
  transform: translateY(-1px);
}

.actions-dropdown-menu {
  position: absolute;
  top: 100%;
  right: 0;
  background: white;
  border: 1px solid #ddd;
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  min-width: 200px;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.2s ease;
  margin-top: 5px;
}

.actions-dropdown-menu.show {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.actions-dropdown-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  color: #333;
  text-decoration: none;
  font-size: 14px;
  border: none;
  background: none;
  width: 100%;
  text-align: left;
  cursor: pointer;
  transition: background-color 0.2s;
}

.actions-dropdown-item:hover {
  background-color: #f8f9fa;
}

.actions-dropdown-item.success:hover {
  background-color: #218838;
  color: white;
}

.actions-dropdown-item:first-child {
  border-radius: 6px 6px 0 0;
}

.actions-dropdown-item:last-child {
  border-radius: 0 0 6px 6px;
}

.actions-dropdown-item i {
  width: 16px;
  text-align: center;
}

/* Different colors for different action types */
.actions-dropdown-item.primary { color: #152d64; }
.actions-dropdown-item.secondary { color: #4a5568; }
.actions-dropdown-item.success { 
  color: white; 
  font-weight: 700; 
  background-color: #28a745;
}

/* Table Actions Dropdown - Smaller version */
.table-actions-dropdown {
  position: relative;
  display: inline-block;
}

.table-actions-dropdown-toggle {
  background-color: #6c757d;
  color: white;
  border: none;
  padding: 6px 8px;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
}

.table-actions-dropdown-toggle:hover {
  background-color: #5a6268;
}

.table-actions-dropdown-menu {
  position: absolute;
  top: 100%;
  right: 0;
  background: white;
  border: 1px solid #ddd;
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  min-width: 150px;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.2s ease;
  margin-top: 5px;
}

.table-actions-dropdown-menu.show {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.table-actions-dropdown-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  color: #333;
  text-decoration: none;
  font-size: 13px;
  border: none;
  background: none;
  width: 100%;
  text-align: left;
  cursor: pointer;
  transition: background-color 0.2s;
}

.table-actions-dropdown-item:hover {
  background-color: #f8f9fa;
}

.table-actions-dropdown-item:first-child {
  border-radius: 6px 6px 0 0;
}

.table-actions-dropdown-item:last-child {
  border-radius: 0 0 6px 6px;
}

.table-actions-dropdown-item i {
  width: 14px;
  text-align: center;
}

.table-actions-dropdown-item.edit { color: #152d64; }
.table-actions-dropdown-item.history { color: #4a5568; }
.table-actions-dropdown-item.print { color: #28a745; }
.table-actions-dropdown-item.modify { color: #28a745; }

/* Supply Inventory Modal Enhancements */
.input-method-btn.active {
  background-color: #152d64 !important;
  color: white !important;
  border: 2px solid #152d64 !important;
}
.input-method-btn {
  background-color: #e9ecef;
  color: #333;
  transition: all 0.1s ease;
}
.input-method-btn:hover {
  background-color: #152d64;
  color: white;
  border: 2px solid #152d64;
}

/* Enhanced Button Styles for Supply Modal */
#clearAllItems:hover:not(:disabled) {
  background-color: #dc3545 !important;
  color: white !important;
}
#cancelInventory:hover {
  background-color: #5a6268 !important;
}
#submitInventory:hover:not(:disabled) {
  background-color: #0d1f4b !important;
}

/* Input Focus Styles for Supply Modal */
#barcode_input:focus {
  border-color: #152d64 !important;
  box-shadow: 0 0 0 3px rgba(21, 45, 100, 0.1) !important;
  outline: none;
}
#manual_supply_select:focus {
  border-color: #152d64 !important;
  box-shadow: 0 0 0 3px rgba(21, 45, 100, 0.1) !important;
  outline: none;
}

/* Supply Scanned Items Styles */
.scanned-item {
  transition: all 0.2s ease;
  position: relative;
}

.scanned-item:hover {
  background-color: #f8f9fa !important;
  border-left: 4px solid #152d64;
  padding-left: 16px !important;
}

.scanned-item:first-child {
  border-top: 1px solid #eee;
}

.scanned-item:last-child {
  border-bottom: none;
}

/* Supply item quantity controls hover effects */
.scanned-item button:hover {
  transform: scale(1.05);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.scanned-item input[type="number"]:focus {
  outline: none;
  border-color: #152d64;
  box-shadow: 0 0 0 2px rgba(21, 45, 100, 0.1);
}
  </style>
</head>
<body>
  {% include 'app/navbar.html' %}
  {% block content %}
    {% csrf_token %}

    {% if messages %}
      {% for message in messages %}
        {% if message.tags == 'success' %}
        <div class="success-container">
          <div class="success-message">
            <i class="fas fa-check"></i>
            <p class="success-text">{{ message }}</p>
          </div>
        </div>
        {% endif %}
      {% endfor %}
    {% endif %}

    <div class="parent">
      <div class="div1">
        <h2>Supplies</h2>
      </div>

      <div class="content">
        <!-- Add search input above the buttons -->
        <div class="top-controls">
          <div class="search-filter-group" style="display: flex; align-items: center; gap: 8px;">
            <!-- Main Search Bar -->
            <div class="search-container">
              <div style="position: relative; display: inline-block; width: 100%; max-width: 420px;">
                <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6c757d; font-size: 14px;"></i>
                <input type="text" id="searchInput" placeholder="Search supplies..." 
                       style="width: 100%; padding: 10px 16px 10px 40px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 14px; transition: border-color 0.3s ease;">
              </div>
            </div>
            
            <div class="simple-filter-container">
              <button id="filterToggleBtn" class="simple-filter-toggle" type="button">
                <i class="fas fa-filter"></i> Filters 
                <span id="activeFilterCount" class="filter-count">0</span>
                <i class="fas fa-chevron-down filter-chevron"></i>
              </button>
              <div id="filterDropdown" class="simple-filter-dropdown">
                <div class="filter-grid-container">
                  
                  <!-- Left Column -->
                  <div class="filter-column">
                    <!-- Category Filter -->
                    <div class="simple-filter-group">
                      <div class="simple-filter-header">
                        <i class="fas fa-tags"></i> Category
                      </div>
                      <div class="simple-filter-options category-filter-options">
                        <label class="simple-filter-option">
                          <input type="checkbox" name="category" value="" checked>
                          <span class="filter-text">All Categories</span>
                        </label>
                        {% for category in categories %}
                        <label class="simple-filter-option">
                          <input type="checkbox" name="category" value="{{ category.name }}">
                          <span class="filter-text">{{ category.name }}</span>
                        </label>
                        {% endfor %}
                      </div>
                    </div>
                  </div>

                  <!-- Right Column -->
                  <div class="filter-column">
                    <!-- Status Filter -->
                    <div class="simple-filter-group">
                      <div class="simple-filter-header">
                        <i class="fas fa-circle"></i> Status
                      </div>
                      <div class="simple-filter-options">
                        <label class="simple-filter-option">
                          <input type="checkbox" name="status" value="" checked>
                          <span class="filter-text">All Status</span>
                        </label>
                        <label class="simple-filter-option">
                          <input type="checkbox" name="status" value="available">
                          <span class="filter-text">Available</span>
                        </label>
                        <label class="simple-filter-option">
                          <input type="checkbox" name="status" value="low_stock">
                          <span class="filter-text">Low Stock</span>
                        </label>
                        <label class="simple-filter-option">
                          <input type="checkbox" name="status" value="out_of_stock">
                          <span class="filter-text">Out of Stock</span>
                        </label>
                      </div>
                    </div>

                    <!-- Availability Filter -->
                    <div class="simple-filter-group">
                      <div class="simple-filter-header">
                        <i class="fas fa-check-circle"></i> Availability
                      </div>
                      <div class="simple-filter-options">
                        <label class="simple-filter-option">
                          <input type="checkbox" name="availability" value="" checked>
                          <span class="filter-text">All Availability</span>
                        </label>
                        <label class="simple-filter-option">
                          <input type="checkbox" name="availability" value="Yes">
                          <span class="filter-text">Available for Request</span>
                        </label>
                        <label class="simple-filter-option">
                          <input type="checkbox" name="availability" value="No">
                          <span class="filter-text">Not Available for Request</span>
                        </label>
                      </div>
                    </div>

                    <!-- Expiry Filter -->
                    <div class="simple-filter-group">
                      <div class="simple-filter-header">
                        <i class="fas fa-clock"></i> Expiry
                      </div>
                      <div class="simple-filter-options">
                        <label class="simple-filter-option">
                          <input type="checkbox" name="expiry" value="" checked>
                          <span class="filter-text">All Expiry</span>
                        </label>
                        <label class="simple-filter-option">
                          <input type="checkbox" name="expiry" value="expired">
                          <span class="filter-text">Expired</span>
                        </label>
                        <label class="simple-filter-option">
                          <input type="checkbox" name="expiry" value="expiring_soon">
                          <span class="filter-text">Expiring Soon (30 days)</span>
                        </label>
                        <label class="simple-filter-option">
                          <input type="checkbox" name="expiry" value="not_expired">
                          <span class="filter-text">Not Expired</span>
                        </label>
                        <label class="simple-filter-option">
                          <input type="checkbox" name="expiry" value="no_expiry">
                          <span class="filter-text">No Expiry Date</span>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Filter Actions -->
                <div class="simple-filter-actions">
                  <button id="clearFiltersBtn" class="simple-btn clear-btn" type="button">
                    <i class="fas fa-times"></i> Clear All
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="button-group" style="display: flex; gap: 8px; align-items: center;">
            <button id="openModalBtn" class="action-btn primary-btn" style="display: flex; align-items: center; gap: 6px; background-color: #152d64; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 14px; cursor: pointer; transition: all 0.2s;">
              <i class="fas fa-plus"></i> Add Supply
            </button>
            <button id="openModifyQuantityModalBtn" class="action-btn secondary-btn" style="display: flex; align-items: center; gap: 6px; background-color: #4a5568; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 14px; cursor: pointer; transition: all 0.2s;">
              <i class="fas fa-edit"></i> Manage Stocks
            </button>
            
            <div class="actions-dropdown">
              <button class="actions-dropdown-toggle" type="button" id="actionsDropdownToggle">
                <i class="fas fa-ellipsis-h"></i>
              </button>
              <div class="actions-dropdown-menu" id="actionsDropdownMenu">
                <button id="openCategoryModalBtn" class="actions-dropdown-item primary" onclick="openCategoryModal()">
                  <i class="fas fa-folder-plus"></i> Add Category
                </button>
                <button id="openSubcategoryModalBtn" class="actions-dropdown-item primary" onclick="openSubcategoryModal()">
                  <i class="fas fa-folder-tree"></i> Add Subcategory
                </button>
                <button id="openExportModalBtn" class="actions-dropdown-item success">
                  <i class="fas fa-file-excel"></i> Export to Excel
                </button>
                <button onclick="openBarcodeSelectionModal()" class="actions-dropdown-item primary">
                  <i class="fas fa-print"></i> Print Barcodes
                </button>
              </div>
            </div>
          </div>
        </div>

    {% if page_obj %}
      <table border="1" class="searchable-table supply-table">
        <thead>
          <tr>
            <th>No.</th>
            <th>Supply Name</th>
            <th>Description</th>
            <th>Category</th>
            <th>Sub Category</th>
            <th>Current Quantity</th>
            <th>Expiration Date</th>
            <th>Min. Threshold</th>
            <th>Status</th>
            <th>Available for Request</th>
            <th>Barcode</th>
            <th>Date Received</th>
            <th>Last Updated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="supply-table-body">
          {% for supply in page_obj %}
          <tr data-category="{{ supply.category.name }}">
            <td class="row-number">{{ page_obj.start_index|add:forloop.counter0 }}</td>
            <td>{{ supply.supply_name|default:"----" }}</td>
            <td>{{ supply.description|default:"----" }}</td>
            <td><strong>{{ supply.category.name|default:"----" }}</strong></td>
            <td><strong>{{ supply.subcategory.name|default:"----" }}</strong></td>
            <td>{{ supply.quantity_info.current_quantity|default:"----" }}</td>
            <td>
              {% if supply.expiration_date %}
                <div class="expiration-badge 
                  {% if supply.days_until_expiration < 0 %}expired
                  {% elif supply.days_until_expiration <= 30 %}nearly-expired
                  {% else %}not-expired{% endif %}">
                  {% if supply.days_until_expiration < 0 %}
                    <i class="fas fa-exclamation-triangle"></i> Expired
                  {% elif supply.days_until_expiration <= 30 %}
                    <i class="fas fa-clock"></i> Expires in {{ supply.days_until_expiration }} days
                  {% else %}
                    <i class="fas fa-check"></i> {{ supply.expiration_date|date:"M d, Y" }}
                  {% endif %}
                </div>
              {% else %}
                N/A
              {% endif %}
            </td>
            <td>{{ supply.quantity_info.minimum_threshold|default:"----" }}</td>
            <td>
              <span class="status-badge status-{{ supply.status }}">
                {% if supply.status == 'available' %}
                  <i class="fas fa-check-circle"></i>
                {% elif supply.status == 'low_stock' %}
                  <i class="fas fa-exclamation-circle"></i>
                {% elif supply.status == 'out_of_stock' %}
                  <i class="fas fa-times-circle"></i>
                {% endif %}
                {{ supply.get_status_display }}
              </span>
            </td>
            <td>
              {% if supply.is_expired %}
                Not Available
              {% else %}
                {{ supply.available_for_request|yesno:"Yes,No" }}
              {% endif %}
            </td>
             <td>
                  <div class="barcode-container">
                    {% if supply.barcode_image %}
                      <img src="{{ supply.barcode_image.url }}" alt="Barcode for {{ supply.supply_name }}" class="barcode-image">
                    {% else %}
                      <span>{{ supply.barcode|default:"No barcode" }}</span>
                    {% endif %}
                  </div>
                </td>
            <td>{{ supply.date_received|default:"----" }}</td>
            <td>{{ supply.last_updated|default:"----" }}</td>
            <td>
              <div class="table-actions-dropdown">
                <button class="table-actions-dropdown-toggle" type="button">
                  <i class="fas fa-ellipsis-h"></i>
                </button>
                <div class="table-actions-dropdown-menu">
                  <button class="table-actions-dropdown-item edit edit-btn" 
                    data-id="{{ supply.id }}"
                    data-name="{{ supply.supply_name }}"
                    data-current-quantity="{{ supply.quantity_info.current_quantity }}"
                    data-minimum-threshold="{{ supply.quantity_info.minimum_threshold }}"
                    data-category="{{ supply.category.id }}"
                    data-subcategory="{{ supply.subcategory.id }}"
                    data-description="{{ supply.description|default:'' }}"
                    data-available-for-request="{{ supply.available_for_request|yesno:'true,false' }}"
                    data-date="{{ supply.date_received|date:'Y-m-d' }}"
                    data-expiration-date="{{ supply.expiration_date|date:'Y-m-d'|default:'' }}">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  
                  <button class="table-actions-dropdown-item history history-btn" 
                    data-id="{{ supply.id }}">
                    <i class="fas fa-history"></i> View History
                  </button>
                  
                  <button class="table-actions-dropdown-item print print-btn" 
                    onclick="printSingleBarcode(this)" 
                    data-barcode="{% if supply.barcode_image %}{{ supply.barcode_image.url }}{% else %}{{ supply.barcode }}{% endif %}"
                    data-name="{{ supply.supply_name }}">
                    <i class="fas fa-print"></i> Print Barcode
                  </button>
                  
                  <form method="post" action="{% url 'archive_supply' supply.id %}" style="display: contents;">
                    {% csrf_token %}
                    <button type="submit" class="table-actions-dropdown-item archive" 
                      onclick="return confirm('{% if supply.is_expired %}Are you sure you want to archive this expired supply? This action is allowed even if the quantity is not zero.{% else %}Are you sure you want to archive this supply? This will only be possible if the quantity is zero.{% endif %}');"
                      {% if not supply.is_expired and supply.quantity_info.current_quantity > 0 %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>
                      <i class="fas fa-archive"></i> Archive
                    </button>
                  </form>
                </div>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="14">No supplies available.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      
      <!-- Pagination -->
      <div class="actlog-pagination" style="margin-top: 20px;">
        <span class="step-links">
          {% if page_obj.has_previous %}
            <a href="#" data-page="1" class="pagination-link">&laquo; first</a>
            <a href="#" data-page="{{ page_obj.previous_page_number }}" class="pagination-link">previous</a>
          {% endif %}

          <span class="current">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
            <span style="margin-left: 10px; color: #666; font-size: 0.9em;">
              (Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }} items)
            </span>
          </span>

          {% if page_obj.has_next %}
            <a href="#" data-page="{{ page_obj.next_page_number }}" class="pagination-link">next</a>
            <a href="#" data-page="{{ page_obj.paginator.num_pages }}" class="pagination-link">last &raquo;</a>
          {% endif %}
        </span>
      </div>
    {% else %}
      <p>No supplies available.</p>
    {% endif %}
  </div>

  <!-- Add Supply Modal -->
  <div id="addSupplyModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Add New Supply</h3>
      <form method="POST" action="{% url 'add_supply' %}" id="addSupplyForm">
        {% csrf_token %}
        
        <!-- Custom form fields with required asterisks -->
        <div class="form-group">
          <label for="{{ form.supply_name.id_for_label }}">
            <i class="fas fa-box"></i> Supply Name
            <span class="required-asterisk">*</span>
          </label>
          {{ form.supply_name }}
        </div>

        <div class="form-group">
          <label for="{{ form.category.id_for_label }}">
            <i class="fas fa-folder"></i> Category
            <span class="required-asterisk">*</span>
          </label>
          {{ form.category }}
        </div>

        <div class="form-group">
          <label for="{{ form.subcategory.id_for_label }}">
            <i class="fas fa-folder-tree"></i> Subcategory
            <span class="required-asterisk">*</span>
          </label>
          {{ form.subcategory }}
        </div>

        <div class="form-group">
          <label for="{{ form.description.id_for_label }}">
            <i class="fas fa-align-left"></i> Description
          </label>
          {{ form.description }}
        </div>

        <div class="form-group">
          <label for="{{ form.available_for_request.id_for_label }}">
            <i class="fas fa-check-circle"></i> Available for Request
          </label>
          <div class="form-check">
            {{ form.available_for_request }}
            <label for="{{ form.available_for_request.id_for_label }}" class="form-check-label">
              Allow this supply to be requested by users
            </label>
          </div>
        </div>

        <div class="form-group">
          <label for="{{ form.date_received.id_for_label }}">
            <i class="fas fa-calendar"></i> Date Received
            <span class="required-asterisk">*</span>
          </label>
          {{ form.date_received }}
        </div>

        <div class="form-group">
          <label for="{{ form.expiration_date.id_for_label }}">
            <i class="fas fa-clock"></i> Expiration Date
          </label>
          {{ form.expiration_date }}
          <small class="help-text">{{ form.expiration_date.help_text }}</small>
        </div>

        <div class="form-group">
          <label for="{{ form.current_quantity.id_for_label }}">
            <i class="fas fa-boxes"></i> Current Quantity
            <span class="required-asterisk">*</span>
          </label>
          {{ form.current_quantity }}
        </div>

        <div class="form-group">
          <label for="{{ form.minimum_threshold.id_for_label }}">
            <i class="fas fa-exclamation-triangle"></i> Minimum Threshold
            <span class="required-asterisk">*</span>
          </label>
          {{ form.minimum_threshold }}
        </div>

        <button type="submit" class="submit-btn">Submit</button>
      </form>
    </div>
  </div>

  <!-- Edit Supply Modal -->
  <div id="editSupplyModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeEditModalBtn">&times;</span>
      <h3>Edit Supply</h3>
      <form method="POST" action="{% url 'edit_supply' %}">
        {% csrf_token %}
        <input type="hidden" name="id" id="edit_id" />
        
        <div class="form-group">
          <label>
            <i class="fas fa-box"></i> Supply Name
            <span class="required-asterisk">*</span>
          </label>
          <input type="text" name="supply_name" id="edit_name" required />
        </div>

        <div class="form-group">
          <label>
            <i class="fas fa-exclamation-triangle"></i> Minimum Threshold
            <span class="required-asterisk">*</span>
          </label>
          <input type="number" name="minimum_threshold" id="edit_minimum_threshold" required min="0" />
        </div>

        <div class="form-group">
          <label for="edit_category">
            <i class="fas fa-folder"></i> Category
            <span class="required-asterisk">*</span>
          </label>
          <select name="category" id="edit_category" class="form-select" required>
            <option value="">Select a category</option>
            {% for category in form.fields.category.queryset %}
              <option value="{{ category.id }}">{{ category.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label for="edit_subcategory">
            <i class="fas fa-folder-tree"></i> Subcategory
            <span class="required-asterisk">*</span>
          </label>
          <select name="subcategory" id="edit_subcategory" class="form-select" required>
            <option value="">Select a subcategory</option>
            {% for subcategory in form.fields.subcategory.queryset %}
              <option value="{{ subcategory.id }}">{{ subcategory.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label>
            <i class="fas fa-align-left"></i> Description
          </label>
          <textarea name="description" id="edit_description" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label>
            <i class="fas fa-check-circle"></i> Available for Request
          </label>
          <div class="form-check">
            <input type="checkbox" name="available_for_request" id="edit_available_for_request" class="form-check-input" />
            <label for="edit_available_for_request" class="form-check-label">
              Allow this supply to be requested by users
            </label>
          </div>
        </div>

        <div class="form-group">
          <label>
            <i class="fas fa-calendar"></i> Date Received
            <span class="required-asterisk">*</span>
          </label>
          <input type="date" name="date_received" id="edit_date" required />
        </div>

        <div class="form-group">
          <label>
            <i class="fas fa-clock"></i> Expiration Date
          </label>
          <input type="date" name="expiration_date" id="edit_expiration_date" />
          <small class="help-text">Leave empty if the supply does not expire.</small>
        </div>

        <button type="submit" class="submit-btn">Update</button>
      </form>
    </div>
  </div>

  <!-- Enhanced Supply Stocks Management Modal -->
  <div id="modifyQuantityModal" class="modal">
    <div class="modal-content" style="width: 95%; max-width: 1200px; height: 85vh; margin: 5vh auto; display: flex; flex-direction: column;">
      
      <!-- Modal Header -->
      <div style="display: flex; justify-content: center; align-items: center; padding: 20px; background: #152d64; color: white; border-radius: 8px 8px 0 0; position: relative;">
        <div style="text-align: center;">
          <h2 style="margin: 0; font-size: 22px; font-weight: 600; color: #fbff00;">Supply Stocks Management</h2>
        </div>
        <span class="close" id="closeModifyQuantityModalBtn" style="color: white; font-size: 28px; cursor: pointer; padding: 5px; position: absolute; right: 20px;">&times;</span>
      </div>

      <div style="display: flex; flex: 1; overflow: hidden;">
        
        <!-- Left Panel - Input Controls -->
        <div style="width: 320px; padding: 20px; border-right: 1px solid #eee; background: #fafafa; position: relative; z-index: 5;">
          
          <!-- Mode Toggle -->
          <div style="margin-bottom: 15px; position: relative; z-index: 6;">
            <div style="display: flex; border-radius: 4px; overflow: hidden; border: 1px solid #ddd;">
              <button type="button" id="barcodeModeBtn" class="input-method-btn active" data-method="barcode" style="flex: 1; padding: 8px; background: #152d64; color: white; border: none; font-size: 13px; position: relative; z-index: 7;">
                Scan Mode
              </button>
              <button type="button" id="manualModeBtn" class="input-method-btn" data-method="manual" style="flex: 1; padding: 8px; background: white; color: #666; border: none; font-size: 13px; position: relative; z-index: 7;">
                Select Mode
              </button>
            </div>
          </div>

          <!-- Barcode Input -->
          <div id="barcodeInputGroup" style="position: relative; z-index: 10;">
            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 14px;">Barcode Scanner</label>
            <input type="text" id="barcode_input" placeholder="Scan here..." autofocus 
                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; margin-bottom: 8px; position: relative; z-index: 11; background: white; box-sizing: border-box;">
            <div style="font-size: 11px; color: #666; background: #f0f8ff; padding: 6px; border-radius: 4px; position: relative; z-index: 10;">
              Position cursor here and scan barcode
            </div>
          </div>

          <!-- Manual Input -->
          <div id="manualInputGroup" style="display: none; position: relative; z-index: 10;">
            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 14px;">Select Supply</label>
            <select id="manual_supply_select" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px; position: relative; z-index: 11; background: white; box-sizing: border-box;">
              <option value="">Choose supply...</option>
              {% for supply in all_supplies %}
                <option value="{{ supply.id }}" data-name="{{ supply.supply_name }}" data-quantity="{{ supply.quantity_info.current_quantity }}" data-description="{{ supply.description|default:''|escapejs }}" data-barcode="{{ supply.barcode|default:'' }}">
                  {{ supply.supply_name }}
                </option>
              {% endfor %}
            </select>
            <button type="button" id="addManualItem" style="width: 100%; padding: 10px; background: #152d64; color: white; border: none; border-radius: 4px; position: relative; z-index: 11; box-sizing: border-box; margin-top: 5px;">
              Add Selected Item
            </button>
          </div>

          <!-- Quick Stats -->
          <div style="margin-top: 20px; padding: 12px; background: white; border-radius: 4px; border: 1px solid #eee;">
            <div style="text-align: center;">
              <div style="font-size: 20px; font-weight: bold; color: #152d64;"><span id="itemCount">0</span></div>
              <div style="font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 1px;">Items Ready</div>
            </div>
          </div>

        </div>

        <!-- Right Panel - Items List -->
        <div style="flex: 1; display: flex; flex-direction: column; background: white;">
          
          <!-- Items Header -->
          <div style="padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #eee;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h4 style="margin: 0; font-size: 16px; color: #333;">Items to Process</h4>
              <button type="button" id="clearAllItems" disabled 
                      style="padding: 6px 12px; background: transparent; color: #dc3545; border: 1px solid #dc3545; border-radius: 4px; font-size: 12px; cursor: pointer;">
                Clear All
              </button>
            </div>
          </div>

          <!-- Items Container -->
          <div id="itemsContainer" style="flex: 1; overflow-y: auto; background: #fafafa; display: flex; flex-direction: column;">
            <div id="noItemsMessage" style="display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; text-align: center; color: #999;">
              <div style="font-size: 48px; margin-bottom: 15px;"></div>
              <div style="font-size: 16px; margin-bottom: 5px;">No items scanned</div>
              <div style="font-size: 14px;">Start scanning to add supplies</div>
            </div>
          </div>

          <!-- Action Footer -->
          <div style="padding: 15px 20px; background: #f8f9fa; border-top: 1px solid #eee;">
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button type="button" id="cancelInventory" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px;">
                Cancel
              </button>
              <button type="button" id="submitInventory" disabled 
                      style="padding: 10px 20px; background: #152d64; color: white; border: none; border-radius: 4px; font-weight: 500;">
                Update Inventory (<span id="totalItemsCount">0</span>)
              </button>
            </div>
          </div>

        </div>
      </div>

      <!-- Hidden Form for Submission -->
      <form method="post" action="{% url 'modify_supply_quantity_generic' %}" id="modifyQuantityForm" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="supply_id" id="supply_id">
        <input type="hidden" name="amount" id="amount">
      </form>
    </div>
  </div>

  <!-- History Modal -->
  <div id="historyModal" class="history-modal">
    <div class="history-modal-content">
      <span class="close" id="closeHistoryModalBtn">&times;</span>
      <div class="history-header">
        <h3>Supply History</h3>
        <div class="history-filter-controls">
          <input type="text" id="historySearchInput" placeholder="Search history..." class="history-search-input">
          <select id="historyActionFilter" class="history-filter-select">
            <option value="">All Actions</option>
            <option value="create">Created</option>
            <option value="update">Updated</option>
            <option value="quantity_update">Quantity Changes</option>
          </select>
        </div>
      </div>
      
      <div id="historyContent">
        <div class="history-summary" id="historySummary">
          <span class="history-count">Total entries: <strong id="historyTotalCount">0</strong></span>
          <span class="history-filtered-count" id="historyFilteredCount" style="display: none;">Showing: <strong id="historyVisibleCount">0</strong></span>
        </div>
        <table class="history-table">
          <thead>
            <tr>
              <th class="col-datetime">Date & Time</th>
              <th class="col-action">Action Type</th>
              <th class="col-description">Change Description</th>
              <th class="col-values">Value Changes</th>
              <th class="col-user">User</th>
              <th class="col-remarks">Remarks</th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
            <!-- History data will be populated here -->
          </tbody>
        </table>
        <div id="historyNoResults" class="history-no-results" style="display: none;">
          <i class="fas fa-search"></i>
          <p>No history entries match your search criteria.</p>
        </div>
      </div>
    </div>
  </div>

   <!-- Category Modal -->
   <div id="categoryModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <span class="close" onclick="closeCategoryModal()">&times;</span>
      <h2 style="color: #152d64; margin-bottom: 25px;">Manage Categories</h2>
     
      <!-- Add Category Form -->
      <form id="categoryForm" method="POST" action="{% url 'add_category' %}"
            style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid #eee;">
        {% csrf_token %}
        <div style="display: flex; gap: 15px; align-items: flex-end;">
          <div style="flex: 1;">
            <label for="categoryName" style="display: block; margin-bottom: 8px; color: #444; font-weight: 500;">
              Category Name:
            </label>
            <input type="text" id="categoryName" name="name" required class="form-control">
          </div>
          <button type="submit" class="submit-btn"
                  style="background-color: #152d64; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-left:15px; transition: background-color 0.3s ease;">
            Add Category
          </button>
        </div>
      </form>


      <!-- Categories Table -->
      <div class="table-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px;">
        <table style="width: 100%; border-collapse: collapse; background: white;">
          <thead style="position: sticky; top: 0; z-index: 1;">
            <tr>
              <th style="background-color: #152d64; color: white; padding: 12px 15px; text-align: left; font-weight: 500;">No.</th>
              <th style="background-color: #152d64; color: white; padding: 12px 15px; text-align: left; font-weight: 500;">Category Name</th>
              <th style="background-color: #152d64; color: white; padding: 12px 15px; text-align: center; font-weight: 500;">Supplies Count</th>
              <th style="background-color: #152d64; color: white; padding: 12px 15px; text-align: center; font-weight: 500;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for category in categories %}
            <tr style="transition: background-color 0.2s ease;">
              <td style="padding: 12px 15px; border-bottom: 1px solid #eee;">{{ forloop.counter }}</td>
              <td style="padding: 12px 15px; border-bottom: 1px solid #eee;">
                <span class="category-name" style="font-weight: 500;">{{ category.name }}</span>
              </td>
              <td style="padding: 12px 15px; border-bottom: 1px solid #eee; text-align: center;">
                <span class="badge {% if category.supply_set.count > 0 %}badge-active{% else %}badge-inactive{% endif %}">
                  {{ category.supply_set.count }}
                </span>
              </td>
              <td style="padding: 12px 15px; border-bottom: 1px solid #eee; text-align: center;">
                <div class="button-group" style="display: flex; gap: 8px; justify-content: center;">
                  <button type="button" class="category-edit-btn"
                          data-id="{{ category.id }}"
                          data-name="{{ category.name|escapejs }}"
                          onclick="editCategory(this.dataset.id, this.dataset.name)"
                          style="background-color: #152d64; color: white; border: none; width: 32px; height: 32px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-edit"></i>
                  </button>
                  <form method="POST" action="{% url 'delete_supply_category' category.id %}"
                        style="display: inline;"
                        data-count="{{ category.supply_set.count }}"
                        onsubmit="return validateDelete(this.dataset.count)">
                    {% csrf_token %}
                    <button type="submit" class="del-btn"
                            style="background-color: #dc3545; color: white; border: none; width: 32px; height: 32px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; display: flex; align-items: center; justify-content: center;">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" style="padding: 20px; text-align: center; color: #666;">
                No categories available.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>


  <!-- Category Edit Modal -->
  <div id="categoryEditModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <span class="close" id="closeCategoryEditModalBtn">&times;</span>
      <h2 style="color: #152d64; margin-bottom: 20px;">Edit Category</h2>
      <form id="categoryEditForm" method="POST" action="{% url 'update_supply_category' %}" style="margin-top: 20px;">
        {% csrf_token %}
        <input type="hidden" id="categoryEditId" name="id">
        <div style="margin-bottom: 20px;">
          <label for="categoryEditName" style="display: block; margin-bottom: 8px; color: #444; font-weight: 500;">
            Category Name:
          </label>
          <input type="text" id="categoryEditName" name="name" required
                 style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; transition: border-color 0.3s ease;"
                 placeholder="Enter category name">
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
          <button type="button" class="cancel-btn" onclick="closeCategoryEditModal()">
            Cancel
          </button>
          <button type="submit" class="submit-btn"
                  style="padding: 8px 16px; background-color: #152d64; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>


  <!-- Subcategory Modal -->
  <div id="subcategoryModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <span class="close" onclick="closeSubcategoryModal()">&times;</span>
      <h2 style="color: #152d64; margin-bottom: 25px;">Manage Subcategories</h2>
     
      <!-- Add Subcategory Form -->
      <form id="subcategoryForm" method="POST" action="{% url 'add_subcategory' %}"
            style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid #eee;">
        {% csrf_token %}
        <div style="display: flex; gap: 15px; align-items: flex-end;">
          <div style="flex: 1;">
            <label for="subcategoryName" style="display: block; margin-bottom: 8px; color: #444; font-weight: 500;">
              Subcategory Name:
            </label>
            <input type="text" id="subcategoryName" name="name" required class="form-control">
          </div>
          <button type="submit" class="submit-btn"
                  style="background-color: #152d64; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-left:15px; transition: background-color 0.3s ease;">
            Add Subcategory
          </button>
        </div>
      </form>


      <!-- Subcategories Table -->
      <div class="table-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px;">
        <table style="width: 100%; border-collapse: collapse; background: white;">
          <thead style="position: sticky; top: 0; z-index: 1;">
            <tr>
              <th style="background-color: #152d64; color: white; padding: 12px 15px; text-align: left; font-weight: 500;">No.</th>
              <th style="background-color: #152d64; color: white; padding: 12px 15px; text-align: left; font-weight: 500;">Subcategory Name</th>
              <th style="background-color: #152d64; color: white; padding: 12px 15px; text-align: center; font-weight: 500;">Supplies Count</th>
              <th style="background-color: #152d64; color: white; padding: 12px 15px; text-align: center; font-weight: 500;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for subcategory in subcategories %}
            <tr style="transition: background-color 0.2s ease;">
              <td style="padding: 12px 15px; border-bottom: 1px solid #eee;">{{ forloop.counter }}</td>
              <td style="padding: 12px 15px; border-bottom: 1px solid #eee;">
                <span class="subcategory-name" style="font-weight: 500;">{{ subcategory.name }}</span>
              </td>
              <td style="padding: 12px 15px; border-bottom: 1px solid #eee; text-align: center;">
                <span class="badge {% if subcategory.supply_set.count > 0 %}badge-active{% else %}badge-inactive{% endif %}">
                  {{ subcategory.supply_set.count }}
                </span>
              </td>
              <td style="padding: 12px 15px; border-bottom: 1px solid #eee; text-align: center;">
                <div class="button-group" style="display: flex; gap: 8px; justify-content: center;">
                  <button type="button" class="subcategory-edit-btn"
                          data-id="{{ subcategory.id }}"
                          data-name="{{ subcategory.name|escapejs }}"
                          onclick="editSubcategory(this.dataset.id, this.dataset.name)"
                          style="background-color: #152d64; color: white; border: none; width: 32px; height: 32px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-edit"></i>
                  </button>
                  <form method="POST" action="{% url 'delete_supply_subcategory' subcategory.id %}"
                        style="display: inline;"
                        data-count="{{ subcategory.supply_set.count }}"
                        onsubmit="return validateDeleteSubcategory(this.dataset.count)">
                    {% csrf_token %}
                    <button type="submit" class="del-btn"
                            style="background-color: #dc3545; color: white; border: none; width: 32px; height: 32px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; display: flex; align-items: center; justify-content: center;">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" style="padding: 20px; text-align: center; color: #666;">
                No subcategories available.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>


  <!-- Subcategory Edit Modal -->
  <div id="subcategoryEditModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <span class="close" id="closeSubcategoryEditModalBtn">&times;</span>
      <h2 style="color: #152d64; margin-bottom: 20px;">Edit Subcategory</h2>
      <form id="subcategoryEditForm" method="POST" action="{% url 'update_supply_subcategory' %}" style="margin-top: 20px;">
        {% csrf_token %}
        <input type="hidden" id="subcategoryEditId" name="id">
        <div style="margin-bottom: 20px;">
          <label for="subcategoryEditName" style="display: block; margin-bottom: 8px; color: #444; font-weight: 500;">
            Subcategory Name:
          </label>
          <input type="text" id="subcategoryEditName" name="name" required
                 style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; transition: border-color 0.3s ease;"
                 placeholder="Enter subcategory name">
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
          <button type="button" class="cancel-btn" onclick="closeSubcategoryEditModal()">
            Cancel
          </button>
          <button type="submit" class="submit-btn"
                  style="padding: 8px 16px; background-color: #152d64; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>


  <!-- Export Modal -->
  <div id="exportModal" class="modal">
    <div class="modal-content" style="max-width: 350px; width: auto; padding: 20px;">
      <span class="close" id="closeExportModalBtn" style="position: absolute; right: 15px; top: 10px;">&times;</span>
      <h3 style="font-size: 18px; margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid #dee2e6;">Export Supply Inventory</h3>
      <form method="POST" action="{% url 'export_supply' %}" id="exportForm">
        {% csrf_token %}
        <div class="form-group">
          <p style="margin: 0 0 10px 0; font-size: 14px;">Select fields to include in the report:</p>
          <div class="checkbox-group" style="background-color: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
            <label style="font-size: 13px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" name="fields" value="supply_name" checked style="margin: 0; width: 16px; height: 16px;"> Supply Name
            </label>
            <label style="font-size: 13px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" name="fields" value="description" checked style="margin: 0; width: 16px; height: 16px;"> Description
            </label>
            <label style="font-size: 13px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" name="fields" value="category" checked style="margin: 0; width: 16px; height: 16px;"> Category
            </label>
            <label style="font-size: 13px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" name="fields" value="subcategory" checked style="margin: 0; width: 16px; height: 16px;"> Sub Category
            </label>
            <label style="font-size: 13px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" name="fields" value="current_quantity" checked style="margin: 0; width: 16px; height: 16px;"> Current Quantity
            </label>
            <label style="font-size: 13px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" name="fields" value="date_received" checked style="margin: 0; width: 16px; height: 16px;"> Date Received
            </label>
            <label style="font-size: 13px; margin-bottom: 0; display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" name="fields" value="expiration_date" checked style="margin: 0; width: 16px; height: 16px;"> Expiration Date
            </label>
          </div>
          <div style="text-align: left;">
            <button type="submit" class="submit-btn" style="background-color: #0A2647; padding: 8px 16px; font-size: 14px; border-radius: 4px;">Generate Report</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>


    // Make modal functions globally accessible
    window.openCategoryModal = function() {
        document.getElementById('categoryModal').style.display = 'block';
    };

    window.closeCategoryModal = function() {
        document.getElementById('categoryModal').style.display = 'none';
    };

    window.openSubcategoryModal = function() {
        document.getElementById('subcategoryModal').style.display = 'block';
    };

    window.closeSubcategoryModal = function() {
        document.getElementById('subcategoryModal').style.display = 'none';
    };

    function validateDelete(supplyCount) {
      supplyCount = parseInt(supplyCount, 10);
      if (supplyCount > 0) {
        alert('Cannot delete this category. Please remove or reassign all supplies in this category first.');
        return false;
      }
      return confirm('Are you sure you want to delete this category?');
    }


    function editCategory(categoryId, categoryName) {
      event.preventDefault();
      event.stopPropagation();
     
      const editModal = document.getElementById('categoryEditModal');
      const idInput = document.getElementById('categoryEditId');
      const nameInput = document.getElementById('categoryEditName');


      if (editModal && idInput && nameInput) {
        idInput.value = categoryId;
        nameInput.value = categoryName;
        editModal.style.display = 'block';
      }
    }


    function closeCategoryEditModal() {
      const editModal = document.getElementById('categoryEditModal');
      const editForm = document.getElementById('categoryEditForm');
      if (editModal) {
        editModal.style.display = 'none';
      }
      if (editForm) {
        editForm.reset();
      }
    }


    function editSubcategory(subcategoryId, subcategoryName) {
      event.preventDefault();
      event.stopPropagation();
     
      const editModal = document.getElementById('subcategoryEditModal');
      const idInput = document.getElementById('subcategoryEditId');
      const nameInput = document.getElementById('subcategoryEditName');


      if (editModal && idInput && nameInput) {
        idInput.value = subcategoryId;
        nameInput.value = subcategoryName;
        editModal.style.display = 'block';
      }
    }


    function closeSubcategoryEditModal() {
      const editModal = document.getElementById('subcategoryEditModal');
      const editForm = document.getElementById('subcategoryEditForm');
      if (editModal) {
        editModal.style.display = 'none';
      }
      if (editForm) {
        editForm.reset();
      }
    }


    function validateDeleteSubcategory(supplyCount) {
      supplyCount = parseInt(supplyCount, 10);
      console.log('Validating delete subcategory with supply count:', supplyCount);
      if (supplyCount > 0) {
        alert('Cannot delete this subcategory. Please remove or reassign all supplies in this subcategory first.');
        return false;
      }
      return confirm('Are you sure you want to delete this subcategory?');
    }

    // Function to delete category via AJAX
    function deleteCategory(categoryId) {
      if (!confirm('Are you sure you want to delete this category?')) {
        return;
      }
      
      $.ajax({
        url: '/delete-supply-category/',
        type: 'POST',
        data: {
          'id': categoryId,
          'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        success: function(response) {
          if (response.success) {
            alert('Category deleted successfully!');
            // Remove the row from the table - improved logic
            const rows = document.querySelectorAll('#categoryModal tbody tr');
            rows.forEach(row => {
              // Check for edit button with data-id attribute or onclick with categoryId
              const editButton = row.querySelector('button[data-id="' + categoryId + '"], button.category-edit-btn[data-id="' + categoryId + '"]');
              const deleteButton = row.querySelector('button[onclick*="deleteCategory(' + categoryId + ')"]');
              
              if (editButton || deleteButton) {
                row.remove();
                return;
              }
            });
            
            // Also update the dropdowns by removing the option
            $('#id_category option[value="' + categoryId + '"]').remove();
            $('#edit_category option[value="' + categoryId + '"]').remove();
          } else {
            alert('Error: ' + response.error);
          }
        },
        error: function() {
          alert('Error deleting category. Please try again.');
        }
      });
    }

    // Function to delete subcategory via AJAX
    function deleteSubcategory(subcategoryId) {
      if (!confirm('Are you sure you want to delete this subcategory?')) {
        return;
      }
      
      $.ajax({
        url: '/delete-supply-subcategory/',
        type: 'POST',
        data: {
          'id': subcategoryId,
          'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        success: function(response) {
          if (response.success) {
            alert('Subcategory deleted successfully!');
            // Remove the row from the table - improved logic
            const rows = document.querySelectorAll('#subcategoryModal tbody tr');
            rows.forEach(row => {
              // Check for edit button with data-id attribute or onclick with subcategoryId
              const editButton = row.querySelector('button[data-id="' + subcategoryId + '"], button.subcategory-edit-btn[data-id="' + subcategoryId + '"]');
              const deleteButton = row.querySelector('button[onclick*="deleteSubcategory(' + subcategoryId + ')"]');
              
              if (editButton || deleteButton) {
                row.remove();
                return;
              }
            });
            
            // Also update the dropdowns by removing the option
            $('#id_subcategory option[value="' + subcategoryId + '"]').remove();
            $('#edit_subcategory option[value="' + subcategoryId + '"]').remove();
          } else {
            alert('Error: ' + response.error);
          }
        },
        error: function() {
          alert('Error deleting subcategory. Please try again.');
        }
      });
    }


    document.addEventListener('DOMContentLoaded', function() {
      // Actions Dropdown Functionality
      const dropdownToggle = document.getElementById('actionsDropdownToggle');
      const dropdownMenu = document.getElementById('actionsDropdownMenu');

      if (dropdownToggle && dropdownMenu) {
        dropdownToggle.addEventListener('click', function(e) {
          e.stopPropagation();
          dropdownMenu.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
          if (!dropdownToggle.contains(e.target) && !dropdownMenu.contains(e.target)) {
            dropdownMenu.classList.remove('show');
          }
        });

        // Close dropdown when an item is clicked
        const dropdownItems = dropdownMenu.querySelectorAll('.actions-dropdown-item');
        dropdownItems.forEach(item => {
          item.addEventListener('click', function() {
            dropdownMenu.classList.remove('show');
          });
        });
      }

      // Table Actions Dropdown Functionality
      document.addEventListener('click', function(e) {
        // Handle table dropdown toggles
        if (e.target.closest('.table-actions-dropdown-toggle')) {
          e.stopPropagation();
          const toggle = e.target.closest('.table-actions-dropdown-toggle');
          const menu = toggle.nextElementSibling;
          
          // Close all other table dropdowns
          document.querySelectorAll('.table-actions-dropdown-menu.show').forEach(otherMenu => {
            if (otherMenu !== menu) {
              otherMenu.classList.remove('show');
            }
          });
          
          // Toggle current dropdown
          menu.classList.toggle('show');
        }
        // Close table dropdowns when clicking outside
        else if (!e.target.closest('.table-actions-dropdown')) {
          document.querySelectorAll('.table-actions-dropdown-menu.show').forEach(menu => {
            menu.classList.remove('show');
          });
        }
      });

      // Modal Elements
      const addModal = document.getElementById("addSupplyModal");
      const editModal = document.getElementById("editSupplyModal");
      const modifyQuantityModal = document.getElementById("modifyQuantityModal");
      const historyModal = document.getElementById("historyModal");
      const categoryModal = document.getElementById("categoryModal");
      const categoryEditModal = document.getElementById("categoryEditModal");
      const subcategoryModal = document.getElementById("subcategoryModal");
      const exportModal = document.getElementById("exportModal");

       // Get form and button elements for category
       const categoryEditForm = document.getElementById('categoryEditForm');
      const closeCategoryEditModalBtn = document.getElementById('closeCategoryEditModalBtn');


      // Close modal with X button
      if (closeCategoryEditModalBtn) {
        closeCategoryEditModalBtn.onclick = function(e) {
          e.preventDefault();
          closeCategoryEditModal();
        };
      }


      // Close modal when clicking outside
      window.addEventListener('click', function(event) {
        // Handle category edit modal
        if (event.target === categoryEditModal) {
          closeCategoryEditModal();
        }
        // Handle subcategory edit modal
        else if (event.target === subcategoryEditModal) {
          closeSubcategoryEditModal();
        }
        // Handle subcategory modal
        else if (event.target === subcategoryModal) {
          closeSubcategoryModal();
        }
        // Handle general modals
        else if (event.target.classList.contains('modal')) {
          event.target.style.display = "none";
          destroySelect2Instances();
        }
      });


      // Handle category edit form submission
      if (categoryEditForm) {
        categoryEditForm.onsubmit = function(e) {
          e.preventDefault();
          e.stopPropagation();
         
          const formData = new FormData(this);


          // Convert FormData to URL-encoded string
          const data = new URLSearchParams();
          data.append('id', formData.get('id'));
          data.append('name', formData.get('name'));


          fetch(this.action, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: data.toString()
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Find and update the category in the table
              const categoryId = formData.get('id');
              const newName = formData.get('name');
              const editButton = document.querySelector(`button.category-edit-btn[data-id="${categoryId}"]`);
             
              if (editButton) {
                const row = editButton.closest('tr');
                if (row) {
                  // Update the name in the table
                  const nameSpan = row.querySelector('.category-name');
                  if (nameSpan) {
                    nameSpan.textContent = newName;
                  }
                 
                  // Update the edit button's data
                  editButton.setAttribute('data-name', newName);
                }


                // Update category in dropdowns
                const categorySelects = document.querySelectorAll('select[name="category"]');
                categorySelects.forEach(select => {
                  const option = select.querySelector(`option[value="${categoryId}"]`);
                  if (option) {
                    option.textContent = newName;
                  }
                });


                // Show success message
                alert('Category updated successfully');


                // Close modal
                closeCategoryEditModal();
              }
            } else {
              alert('Error updating category: ' + (data.error || 'Unknown error'));
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error updating category. Please try again.');
          });
         
          return false; // Prevent form submission
        };
      }


      // Remove any other event listeners that might be attached to the form
      categoryEditForm.removeEventListener('submit', function() {});


      // Handle subcategory edit form submission
      const subcategoryEditForm = document.getElementById('subcategoryEditForm');
      const closeSubcategoryEditModalBtn = document.getElementById('closeSubcategoryEditModalBtn');
      const subcategoryEditModal = document.getElementById('subcategoryEditModal');


      // Close modal with X button
      if (closeSubcategoryEditModalBtn) {
        closeSubcategoryEditModalBtn.onclick = function(e) {
          e.preventDefault();
          closeSubcategoryEditModal();
        };
      }





      // Handle subcategory edit form submission
      if (subcategoryEditForm) {
        subcategoryEditForm.onsubmit = function(e) {
          e.preventDefault();
          e.stopPropagation();
         
          const formData = new FormData(this);


          // Convert FormData to URL-encoded string
          const data = new URLSearchParams();
          data.append('id', formData.get('id'));
          data.append('name', formData.get('name'));


          fetch(this.action, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: data.toString()
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Find and update the subcategory in the table
              const subcategoryId = formData.get('id');
              const newName = formData.get('name');
              const editButton = document.querySelector(`button.subcategory-edit-btn[data-id="${subcategoryId}"]`);
             
              if (editButton) {
                const row = editButton.closest('tr');
                if (row) {
                  // Update the name in the table
                  const nameSpan = row.querySelector('.subcategory-name');
                  if (nameSpan) {
                    nameSpan.textContent = newName;
                  }
                 
                  // Update the edit button's data
                  editButton.setAttribute('data-name', newName);
                }


                // Update subcategory in dropdowns
                const subcategorySelects = document.querySelectorAll('select[name="subcategory"]');
                subcategorySelects.forEach(select => {
                  const option = select.querySelector(`option[value="${subcategoryId}"]`);
                  if (option) {
                    option.textContent = newName;
                  }
                });


                // Show success message
                alert('Subcategory updated successfully');


                // Close modal
                closeSubcategoryEditModal();
              }
            } else {
              alert('Error updating subcategory: ' + (data.error || 'Unknown error'));
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error updating subcategory. Please try again.');
          });
         
          return false; // Prevent form submission
        };
      }


      // Remove any other event listeners that might be attached to the form
      subcategoryEditForm && subcategoryEditForm.removeEventListener('submit', function() {});


      // Button Elements
      const openAddBtn = document.getElementById("openModalBtn");
      const closeAddBtn = document.getElementById("closeModalBtn");
      const closeEditBtn = document.getElementById("closeEditModalBtn");
      const openModifyQuantityBtn = document.getElementById("openModifyQuantityModalBtn");
      const closeModifyQuantityBtn = document.getElementById("closeModifyQuantityModalBtn");
      const closeHistoryBtn = document.getElementById("closeHistoryModalBtn");
      const openExportBtn = document.getElementById("openExportModalBtn");
      const closeExportBtn = document.getElementById("closeExportModalBtn");

      // Filter and Search Elements
      const searchInput = document.getElementById('searchInput');
      const tableBody = document.getElementById('supply-table-body');
      
      // Simple Filter Elements
      const filterToggleBtn = document.getElementById('filterToggleBtn');
      const filterDropdown = document.getElementById('filterDropdown');
      const activeFilterCount = document.getElementById('activeFilterCount');

      // Function to close all modals
      function closeAllModals() {
        const modals = [addModal, editModal, modifyQuantityModal, historyModal, categoryModal, subcategoryModal, exportModal];
        modals.forEach(modal => {
          if (modal) modal.style.display = "none";
        });
      }

      // Function to destroy all Select2 instances
      function destroySelect2Instances() {
        ['#id_category', '#id_subcategory', '#edit_category', '#edit_subcategory', '#supply_id'].forEach(selector => {
          const element = $(selector);
          if (element.length && element.hasClass("select2-hidden-accessible")) {
            element.select2('destroy');
          }
        });
      }

      // Simple Filter System
      let activeFilters = {
        category: [],
        status: [],
        availability: [],
        expiry: []
      };

      // Toggle filter dropdown
      if (filterToggleBtn) {
        filterToggleBtn.addEventListener('click', function() {
          filterDropdown.classList.toggle('show');
          filterToggleBtn.classList.toggle('active');
        });
      }

      // Close filter dropdown when clicking outside
      document.addEventListener('click', function(event) {
        if (!event.target.closest('.simple-filter-container')) {
          filterDropdown.classList.remove('show');
          filterToggleBtn.classList.remove('active');
        }
      });

      // Handle filter changes
      document.addEventListener('change', function(event) {
        if (event.target.matches('.simple-filter-option input')) {
          const filterType = event.target.name;
          const filterValue = event.target.value.trim(); // Trim whitespace
          const isChecked = event.target.checked;

          // Handle "All" options
          if (filterValue === '') {
            if (isChecked) {
              // Uncheck all other options in this group
              document.querySelectorAll(`input[name="${filterType}"]:not([value=""])`).forEach(input => {
                input.checked = false;
              });
              activeFilters[filterType] = [];
            }
          } else {
            // Uncheck "All" option when selecting specific filters
            const allOption = document.querySelector(`input[name="${filterType}"][value=""]`);
            if (allOption) allOption.checked = false;

            if (isChecked) {
              if (!activeFilters[filterType].includes(filterValue)) {
                activeFilters[filterType].push(filterValue);
              }
            } else {
              activeFilters[filterType] = activeFilters[filterType].filter(val => val !== filterValue);
            }

            // If no specific filters selected, check "All"
            if (activeFilters[filterType].length === 0) {
              const allOption = document.querySelector(`input[name="${filterType}"][value=""]`);
              if (allOption) allOption.checked = true;
            }
          }

          updateActiveFilterCount();
          applyFilters();
        }
      });

      // Update active filter count
      function updateActiveFilterCount() {
        const totalActiveFilters = Object.values(activeFilters).reduce((sum, filters) => sum + filters.length, 0);
        activeFilterCount.textContent = totalActiveFilters;
        activeFilterCount.style.display = totalActiveFilters > 0 ? 'flex' : 'none';
      }

      // Server-side Filter and Search functionality
      function applyFilters() {
        const params = new URLSearchParams();
        
        // Add search parameter
        const searchTerm = searchInput ? searchInput.value.trim() : '';
        if (searchTerm) {
          params.append('search', searchTerm);
        }
        
        // Add category filters
        activeFilters.category.forEach(category => {
          params.append('category', category);
        });
        
        // Add status filters
        activeFilters.status.forEach(status => {
          params.append('status', status);
        });
        
        // Add availability filters
        activeFilters.availability.forEach(availability => {
          params.append('availability', availability);
        });
        
        // Add expiry filters
        activeFilters.expiry.forEach(expiry => {
          params.append('expiry', expiry);
        });
        
        // Reload page with new parameters
        const baseUrl = window.location.pathname;
        const newUrl = params.toString() ? `${baseUrl}?${params.toString()}` : baseUrl;
        window.location.href = newUrl;
      }
      
      // Debounced search function
      let searchTimeout;
      function debouncedSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          applyFilters();
        }, 500); // 500ms delay
      }

      // Add event listeners for search with debounce
      if (searchInput) {
        searchInput.addEventListener('input', debouncedSearch);
      }

      // Load filter values from URL parameters on page load
      function loadFiltersFromURL() {
        const params = new URLSearchParams(window.location.search);
        
        // Load search value
        const searchQuery = params.get('search');
        if (searchQuery && searchInput) {
          searchInput.value = searchQuery;
        }
        
        // Load category filters
        const categoryFilters = params.getAll('category');
        categoryFilters.forEach(category => {
          const checkbox = document.querySelector(`input[name="category"][value="${category}"]`);
          if (checkbox) {
            checkbox.checked = true;
            if (!activeFilters.category.includes(category)) {
              activeFilters.category.push(category);
            }
          }
        });
        
        // Load status filters
        const statusFilters = params.getAll('status');
        statusFilters.forEach(status => {
          const checkbox = document.querySelector(`input[name="status"][value="${status}"]`);
          if (checkbox) {
            checkbox.checked = true;
            if (!activeFilters.status.includes(status)) {
              activeFilters.status.push(status);
            }
          }
        });
        
        // Load availability filters
        const availabilityFilters = params.getAll('availability');
        availabilityFilters.forEach(availability => {
          const checkbox = document.querySelector(`input[name="availability"][value="${availability}"]`);
          if (checkbox) {
            checkbox.checked = true;
            if (!activeFilters.availability.includes(availability)) {
              activeFilters.availability.push(availability);
            }
          }
        });
        
        // Load expiry filters
        const expiryFilters = params.getAll('expiry');
        expiryFilters.forEach(expiry => {
          const checkbox = document.querySelector(`input[name="expiry"][value="${expiry}"]`);
          if (checkbox) {
            checkbox.checked = true;
            if (!activeFilters.expiry.includes(expiry)) {
              activeFilters.expiry.push(expiry);
            }
          }
        });
        
        updateActiveFilterCount();
      }

      // Function to handle pagination while preserving filters
      window.goToPage = function(pageNumber) {
        const params = new URLSearchParams(window.location.search);
        params.set('page', pageNumber);
        window.location.href = `${window.location.pathname}?${params.toString()}`;
      };

      // Handle pagination link clicks
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('pagination-link')) {
          e.preventDefault();
          const pageNumber = e.target.getAttribute('data-page');
          if (pageNumber) {
            goToPage(pageNumber);
          }
        }
      });

      // Clear filters functionality
      const clearFiltersBtn = document.getElementById('clearFiltersBtn');
      if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
          // Clear search input
          if (searchInput) {
            searchInput.value = '';
          }
          
          // Clear all filter checkboxes
          document.querySelectorAll('.simple-filter-option input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
          });
          
          // Check all "All" options
          document.querySelectorAll('input[name="category"][value=""], input[name="status"][value=""], input[name="availability"][value=""], input[name="expiry"][value=""]').forEach(checkbox => {
            checkbox.checked = true;
          });
          
          // Reset active filters
          activeFilters = {
            category: [],
            status: [],
            availability: [],
            expiry: []
          };
          
          updateActiveFilterCount();
          
          // Navigate to base URL without any parameters
          window.location.href = window.location.pathname;
        });
      }

      // Initialize filtering
      loadFiltersFromURL();

      // Add Supply Modal Handling
      if (openAddBtn) {
        openAddBtn.onclick = function(e) {
          e.preventDefault();
          closeAllModals();
          destroySelect2Instances();
          addModal.style.display = "block";
          
          // Initialize Select2 for category and subcategory in add form
          $('#id_category').select2({
            dropdownParent: $('#addSupplyModal'),
            width: '100%',
            placeholder: 'Select a category'
          });

          $('#id_subcategory').select2({
            dropdownParent: $('#addSupplyModal'),
            width: '100%',
            placeholder: 'Select a subcategory'
          });
        };
      }

      if (closeAddBtn) {
        closeAddBtn.onclick = function() {
          addModal.style.display = "none";
          destroySelect2Instances();
        };
      }

      // Modify Quantity Modal Handling
      if (openModifyQuantityBtn) {
        openModifyQuantityBtn.onclick = function() {
          closeAllModals();
          destroySelect2Instances();
          modifyQuantityModal.style.display = "block";
          
          // Initialize Select2 for manual supply selection
          $('#manual_supply_select').select2({
            dropdownParent: $('#modifyQuantityModal'),
            width: '100%',
            placeholder: 'Select a supply'
          });
          
          document.getElementById('barcode_input').focus();
        };
      }


      if (closeModifyQuantityBtn) {
        closeModifyQuantityBtn.onclick = function() {
          modifyQuantityModal.style.display = "none";
          resetModifyQuantityForm();
        };
      }

      // Handle input method switching
      document.querySelectorAll('.input-method-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          // Update button styles
          document.querySelectorAll('.input-method-btn').forEach(b => {
            b.classList.remove('active');
            b.style.background = '#f8f9fa';
            b.style.color = '#333';
          });
          this.classList.add('active');
          this.style.background = '#152d64';
          this.style.color = 'white';

          // Show/hide appropriate input section
          const method = this.dataset.method;
          document.getElementById('barcode-input-section').style.display = 
            method === 'barcode' ? 'block' : 'none';
          document.getElementById('manual-input-section').style.display = 
            method === 'manual' ? 'block' : 'none';

          // Reset form
          resetModifyQuantityForm();

          // Focus appropriate input
          if (method === 'barcode') {
            document.getElementById('barcode_input').focus();
          } else {
            $('#manual_supply_select').select2('focus');
          }
        });
      });

      // Handle manual supply selection
      $('#manual_supply_select').on('change', function() {
        const selectedOption = $(this).find(':selected');
        const supplyId = selectedOption.val();
        const supplyName = selectedOption.text();
        const currentQuantity = selectedOption.data('quantity');
        const description = selectedOption.data('description');

        if (supplyId) {
          $('#supply_info').show();
          $('#scanned_supply_name').text(supplyName);
          $('#scanned_supply_quantity').text(currentQuantity);
          $('#scanned_supply_description').text(description);
          $('#supply_id').val(supplyId);
          $('#modifyQuantitySubmitBtn').prop('disabled', false);
          
          // Set initial quantity to 1
          $('#amount').val(0);
        } else {
          resetModifyQuantityForm();
        }
      });

      // Handle barcode scanning
      let barcodeBuffer = '';
      let barcodeTimeout;
      let lastScannedSupplyId = null;

      // Prevent form submission on Enter key
      document.getElementById('modifyQuantityForm').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault(); // Prevent form submission
          return false;
        }
      });

      // Prevent form submission on Enter key in barcode input
      document.getElementById('barcode_input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault(); // Prevent form submission
          return false;
        }
      });

      $('#barcode_input').on('input', function() {
        let barcode = $(this).val();
        if (barcode) {
            $.get(`/get_supply_by_barcode/${barcode}/`, function(response) {
                if (response.success) {
                    // Clear any previous error message
                    $('#barcode_error').remove();
                    
                    $('#supply_info').show();
                    $('#scanned_supply_name').text(response.supply.name);
                    $('#scanned_supply_quantity').text(response.supply.current_quantity);
                    $('#scanned_supply_description').text(response.supply.description);
                    $('#supply_id').val(response.supply.id);
                    $('#modifyQuantitySubmitBtn').prop('disabled', false);
                    
                    // Increment quantity instead of clearing it
                    let currentQty = parseInt($('#amount').val()) || 0;
                    $('#amount').val(currentQty + 1);
                    
                    // Clear the barcode input for next scan
                    $('#barcode_input').val('');
                } else {
                    $('#supply_info').hide();
                    $('#supply_id').val('');
                    $('#modifyQuantitySubmitBtn').prop('disabled', true);
                    
                    // Remove any existing error message first
                    $('#barcode_error').remove();
                    
                    // Add error message below the barcode input
                    const errorDiv = $('<div id="barcode_error" style="color: #dc3545; font-size: 0.875rem; margin-top: 0.25rem;">Invalid barcode or supply not found in records</div>');
                    $('#barcode_input').after(errorDiv);
                    
                    // Clear the barcode input after a short delay
                    setTimeout(() => {
                        $('#barcode_input').val('');
                        // Remove error message after 3 seconds
                        setTimeout(() => {
                            $('#barcode_error').fadeOut('slow', function() {
                                $(this).remove();
                            });
                        }, 3000);
                    }, 1000);
                }
            });
        }
    });

      // Handle form submission ONLY when submit button is clicked
      document.getElementById('modifyQuantitySubmitBtn').addEventListener('click', function(e) {
        e.preventDefault();
        const form = document.getElementById('modifyQuantityForm');
        
        const supplyId = document.getElementById('supply_id').value;
        const amount = parseInt(document.getElementById('amount').value);
        
        if (!supplyId) {
          alert('Please scan a valid supply barcode first.');
          return;
        }
        
        if (!amount || amount < 1) {
          alert('Please enter a valid quantity (minimum 1).');
          return;
        }

        // Get CSRF token from the form
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Submit the form using fetch
        fetch(form.action, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: new URLSearchParams({
            'supply_id': supplyId,
            'amount': amount,
            'csrfmiddlewaretoken': csrfToken
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Quantity updated successfully!');
            // Reset form and close modal
            resetModifyQuantityForm();
            document.getElementById('modifyQuantityModal').style.display = 'none';
            // Reload page to show updated quantities
            window.location.reload();
          } else {
            alert(data.error || 'Error updating quantity.');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error updating quantity. Please try again.');
        });
      });

      // Function to reset the modify quantity form
      function resetModifyQuantityForm() {
        document.getElementById('barcode_input').value = '';
        document.getElementById('supply_id').value = '';
        document.getElementById('supply_info').style.display = 'none';
        document.getElementById('scanned_supply_name').textContent = '';
        document.getElementById('scanned_supply_quantity').textContent = '';
        document.getElementById('scanned_supply_description').textContent = '';
        document.getElementById('amount').value = '1';
        document.getElementById('modifyQuantitySubmitBtn').disabled = true;
        barcodeBuffer = '';
        lastScannedSupplyId = null; // Reset the last scanned supply ID
        // Focus back on barcode input
        document.getElementById('barcode_input').focus();
      }

      // Edit Supply Modal Handling
      document.querySelectorAll(".edit-btn").forEach(button => {
        button.addEventListener("click", () => {
          closeAllModals();
          destroySelect2Instances();
          
          const categoryId = button.dataset.category;
          const subcategoryId = button.dataset.subcategory;

          // Set form values
          document.getElementById("edit_id").value = button.dataset.id;
          document.getElementById("edit_name").value = button.dataset.name;
          document.getElementById("edit_minimum_threshold").value = button.dataset.minimumThreshold;
          document.getElementById("edit_description").value = button.dataset.description || '';
          document.getElementById("edit_available_for_request").checked = button.dataset.availableForRequest === 'true';
          document.getElementById("edit_date").value = button.dataset.date;
          document.getElementById("edit_expiration_date").value = button.dataset.expirationDate || '';

          // Show modal
          editModal.style.display = "block";

          // Initialize Select2 dropdowns
          $('#edit_category').select2({
            dropdownParent: $('#editSupplyModal'),
            width: '100%',
            placeholder: 'Select a category'
          });

          $('#edit_subcategory').select2({
            dropdownParent: $('#editSupplyModal'),
            width: '100%',
            placeholder: 'Select a subcategory'
          });

          // Set selected values
          if (categoryId) {
            $('#edit_category').val(categoryId).trigger('change');
          }
          if (subcategoryId) {
            $('#edit_subcategory').val(subcategoryId).trigger('change');
          }
        });
      });

      if (closeEditBtn) {
        closeEditBtn.onclick = function() {
          editModal.style.display = "none";
          destroySelect2Instances();
        };
      }



      // Auto-hide success messages
      const successMessage = document.querySelector('.success-container');
      if (successMessage) {
        setTimeout(function() {
          successMessage.style.opacity = '0';
          successMessage.style.transition = 'opacity 0.3s ease-out';
          setTimeout(function() {
            successMessage.remove();
          }, 300);
        }, 2000);
      }

      // History Modal functionality
      const historyBtns = document.querySelectorAll('.history-btn');
      const historySearchInput = document.getElementById('historySearchInput');
      const historyActionFilter = document.getElementById('historyActionFilter');
      let currentHistoryData = [];

      if (!historyModal || !historyBtns.length || !closeHistoryBtn) {
        console.error('History modal elements not found');
      } else {
        // Function to filter and display history
        function filterAndDisplayHistory() {
          const searchTerm = historySearchInput ? historySearchInput.value.toLowerCase() : '';
          const actionFilter = historyActionFilter ? historyActionFilter.value : '';
          const tableBody = document.getElementById('historyTableBody');
          const noResults = document.getElementById('historyNoResults');
          const totalCount = document.getElementById('historyTotalCount');
          const visibleCount = document.getElementById('historyVisibleCount');
          const filteredCountContainer = document.getElementById('historyFilteredCount');

          if (!tableBody) {
            console.error('History table body not found');
            return;
          }

          let filteredData = [...currentHistoryData]; // Create a copy

          // Apply action filter
          if (actionFilter) {
            filteredData = filteredData.filter(entry => entry.action === actionFilter);
          }

          // Apply search filter
          if (searchTerm) {
            filteredData = filteredData.filter(entry => {
              const searchFields = [
                entry.change_description || '',
                entry.field_display || '',
                entry.user || '',
                entry.value_change || '',
                entry.remarks || ''
              ];
              return searchFields.some(field => 
                field.toLowerCase().includes(searchTerm)
              );
            });
          }

          // Update counts safely
          if (totalCount) totalCount.textContent = currentHistoryData.length;
          if (visibleCount) visibleCount.textContent = filteredData.length;
          
          if (filteredCountContainer) {
            if (filteredData.length !== currentHistoryData.length) {
              filteredCountContainer.style.display = 'inline';
            } else {
              filteredCountContainer.style.display = 'none';
            }
          }

          // Clear table body
          tableBody.innerHTML = '';

          if (filteredData.length === 0) {
            if (noResults) noResults.style.display = 'block';
            tableBody.style.display = 'none';
          } else {
            if (noResults) noResults.style.display = 'none';
            tableBody.style.display = 'table-row-group';

            // Populate table with filtered data
            filteredData.forEach(entry => {
              const row = document.createElement('tr');
              
              // Create action badge
              const actionBadge = `<span class="action-badge ${entry.action || 'update'}">${entry.action_display || 'Updated'}</span>`;
              
              // Format value change with styling and escape HTML
              let valueChange = entry.value_change || 'No change';
              if (valueChange.includes('')) {
                valueChange = valueChange.replace('', '<span class="value-arrow"></span>');
              }
              const valueChangeDiv = `<div class="value-change">${valueChange}</div>`;

              row.innerHTML = `
                <td class="col-datetime">${entry.datetime || '-'}</td>
                <td class="col-action">${actionBadge}</td>
                <td class="col-description">${entry.change_description || '-'}</td>
                <td class="col-values">${valueChangeDiv}</td>
                <td class="col-user">${entry.user || 'Unknown'}</td>
                <td class="col-remarks">${entry.remarks || '-'}</td>
              `;

              tableBody.appendChild(row);
            });
          }
        }

        // Add search and filter event listeners
        if (historySearchInput) {
          let searchTimeout;
          historySearchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterAndDisplayHistory, 300);
          });
        }

        if (historyActionFilter) {
          historyActionFilter.addEventListener('change', filterAndDisplayHistory);
        }

        historyBtns.forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Get supply ID from data-id attribute
            const supplyId = this.getAttribute('data-id') || this.dataset.id;
            
            console.log('History button clicked, supply ID:', supplyId);
            
            if (!supplyId) {
              console.error('Supply ID not found. Button element:', this);
              alert('Error: Supply ID not found. Please refresh the page and try again.');
              return;
            }

            // Clear previous data
            currentHistoryData = [];
            const tableBody = document.getElementById('historyTableBody');
            if (tableBody) {
              tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading history...</td></tr>';
            }

            // Reset filters
            if (historySearchInput) historySearchInput.value = '';
            if (historyActionFilter) historyActionFilter.value = '';

            // Show modal
            historyModal.style.display = 'block';

            // Fetch history data
            console.log('Fetching history for supply ID:', supplyId);
            fetch(`/get_supply_history/${supplyId}/`)
              .then(response => {
                console.log('History response status:', response.status);
                if (!response.ok) {
                  throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
              })
              .then(data => {
                console.log('History data received:', data);
                
                // Check if the response indicates success
                if (data.success === false) {
                  throw new Error(data.error || 'Failed to fetch history data');
                }
                
                // Validate that history data exists
                if (!data.history || !Array.isArray(data.history)) {
                  throw new Error('Invalid history data received from server');
                }
                
                currentHistoryData = data.history;
                
                // Update modal title with supply info
                const modalTitle = historyModal.querySelector('h3');
                if (modalTitle && data.supply_name) {
                  modalTitle.textContent = `Supply History - ${data.supply_name}`;
                  if (data.supply_id) {
                    modalTitle.textContent += ` (ID: ${data.supply_id})`;
                  }
                }

                // Display the data
                filterAndDisplayHistory();
              })
              .catch(error => {
                console.error('Error fetching history:', error);
                if (tableBody) {
                  tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px; color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> Error loading history: ${error.message}</td></tr>`;
                }
              });
          });
        });

        // Close history modal when clicking the close button
        closeHistoryBtn.addEventListener('click', function() {
          historyModal.style.display = 'none';
        });

        // Close history modal when clicking outside
        window.addEventListener('click', function(event) {
          if (event.target === historyModal) {
            historyModal.style.display = 'none';
          }
        });
      }

      // Handle category form submission
      $('#categoryForm').on('submit', function(e) {
        e.preventDefault();
        $.ajax({
          url: $(this).attr('action'),
          type: 'POST',
          data: $(this).serialize(),
          success: function(response) {
            if (response.success) {
              // Add the new category to both edit and add form dropdowns
              let newOption = new Option(response.category.name, response.category.id, true, true);
              $('#edit_category').append(newOption).trigger('change');
              $('#id_category').append(newOption.cloneNode(true)).trigger('change');
              
              // Reset form but keep modal open
              $('#categoryForm')[0].reset();
              
              // Show success message
              alert('Category added successfully! You can add another category or close the modal.');
              
              // Dynamically add the new category to the table in the modal
              const categoryTable = document.querySelector('#categoryModal tbody');
              if (categoryTable && response.category) {
                // Remove "No categories available" row if it exists
                const noDataRow = categoryTable.querySelector('td[colspan="4"]');
                if (noDataRow) {
                  noDataRow.closest('tr').remove();
                }
                
                // Get the current row count for numbering
                const currentRows = categoryTable.querySelectorAll('tr').length;
                const rowNumber = currentRows + 1;
                
                const newRow = document.createElement('tr');
                newRow.style.transition = 'background-color 0.2s ease';
                newRow.innerHTML = `
                  <td style="padding: 12px 15px; border-bottom: 1px solid #eee;">${rowNumber}</td>
                  <td style="padding: 12px 15px; border-bottom: 1px solid #eee;">
                    <span class="category-name" style="font-weight: 500;">${response.category.name}</span>
                  </td>
                  <td style="padding: 12px 15px; border-bottom: 1px solid #eee; text-align: center;">
                    <span class="badge badge-inactive">0</span>
                  </td>
                  <td style="padding: 12px 15px; border-bottom: 1px solid #eee; text-align: center;">
                    <div class="button-group" style="display: flex; gap: 8px; justify-content: center;">
                      <button type="button" class="category-edit-btn"
                              data-id="${response.category.id}"
                              data-name="${response.category.name}"
                              onclick="editCategory(this.dataset.id, this.dataset.name)"
                              style="background-color: #152d64; color: white; border: none; width: 32px; height: 32px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button type="button" class="del-btn"
                              onclick="deleteCategory(${response.category.id})"
                              style="background-color: #dc3545; color: white; border: none; width: 32px; height: 32px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-trash-alt"></i>
                      </button>
                    </div>
                  </td>
                `;
                categoryTable.appendChild(newRow);
              }
            } else {
              alert('Error: ' + response.error);
            }
          },
          error: function() {
            alert('Error adding category. Please try again.');
          }
        });
      });

     // Handle subcategory form submission
     const subcategoryForm = document.getElementById('subcategoryForm');
      const closeSubcategoryModalBtn = document.querySelector('#subcategoryModal .close');


      // Close subcategory modal with X button
      if (closeSubcategoryModalBtn) {
        closeSubcategoryModalBtn.onclick = function(e) {
          e.preventDefault();
          closeSubcategoryModal();
        };
      }





      // Handle subcategory form submission
      if (subcategoryForm) {
        subcategoryForm.onsubmit = function(e) {
          e.preventDefault();
          e.stopPropagation();
         
          const formData = new FormData(this);


          // Convert FormData to URL-encoded string
          const data = new URLSearchParams();
          for (let pair of formData.entries()) {
            data.append(pair[0], pair[1]);
          }


          fetch(this.action, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: data.toString()
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Add the new subcategory to both edit and add form dropdowns
              let newOption = new Option(data.subcategory.name, data.subcategory.id, true, true);
              $('#edit_subcategory').append(newOption).trigger('change');
              $('#id_subcategory').append(newOption.cloneNode(true)).trigger('change');
             
              // Show success message
              alert('Subcategory added successfully! You can add another subcategory or close the modal.');
             
              // Reset form but keep modal open
              subcategoryForm.reset();
              
              // Dynamically add the new subcategory to the table in the modal
              const subcategoryTable = document.querySelector('#subcategoryModal tbody');
              if (subcategoryTable && data.subcategory) {
                // Remove "No subcategories available" row if it exists
                const noDataRow = subcategoryTable.querySelector('td[colspan="4"]');
                if (noDataRow) {
                  noDataRow.closest('tr').remove();
                }
                
                // Get the current row count for numbering
                const currentRows = subcategoryTable.querySelectorAll('tr').length;
                const rowNumber = currentRows + 1;
                
                const newRow = document.createElement('tr');
                newRow.style.transition = 'background-color 0.2s ease';
                newRow.innerHTML = `
                  <td style="padding: 12px 15px; border-bottom: 1px solid #eee;">${rowNumber}</td>
                  <td style="padding: 12px 15px; border-bottom: 1px solid #eee;">
                    <span class="subcategory-name" style="font-weight: 500;">${data.subcategory.name}</span>
                  </td>
                  <td style="padding: 12px 15px; border-bottom: 1px solid #eee; text-align: center;">
                    <span class="badge badge-inactive">0</span>
                  </td>
                  <td style="padding: 12px 15px; border-bottom: 1px solid #eee; text-align: center;">
                    <div class="button-group" style="display: flex; gap: 8px; justify-content: center;">
                      <button type="button" class="subcategory-edit-btn"
                              data-id="${data.subcategory.id}"
                              data-name="${data.subcategory.name}"
                              onclick="editSubcategory(this.dataset.id, this.dataset.name)"
                              style="background-color: #152d64; color: white; border: none; width: 32px; height: 32px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button type="button" class="del-btn"
                              onclick="deleteSubcategory(${data.subcategory.id})"
                              style="background-color: #dc3545; color: white; border: none; width: 32px; height: 32px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-trash-alt"></i>
                      </button>
                    </div>
                  </td>
                `;
                subcategoryTable.appendChild(newRow);
              }
            } else {
              alert('Error: ' + (data.error || 'Unknown error'));
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error adding subcategory. Please try again.');
          });
         
          return false; // Prevent form submission
        };
      }


      // Remove any other event listeners that might be attached to the form
      subcategoryForm && subcategoryForm.removeEventListener('submit', function() {});


      // Remove the old subcategory form handler
      $('#subcategoryForm').off('submit');



      // Add event listeners for closing modals when clicking outside
      [addModal, editModal, modifyQuantityModal, historyModal, categoryModal, subcategoryModal, exportModal].forEach(modal => {
        if (modal) {
          modal.addEventListener('click', function(event) {
            if (event.target === modal) {
              modal.style.display = 'none';
              destroySelect2Instances();
            }
          });
        }
      });

      // Add event listeners for close buttons
      document.querySelectorAll('.close').forEach(closeBtn => {
        closeBtn.addEventListener('click', function() {
          const modal = this.closest('.modal');
          if (modal) {
            modal.style.display = 'none';
            destroySelect2Instances();
          }
        });
      });

      // Export Modal Handling
      if (openExportBtn) {
        openExportBtn.onclick = function() {
          exportModal.style.display = "block";
        }
      }

      if (closeExportBtn) {
        closeExportBtn.onclick = function() {
          exportModal.style.display = "none";
        }
      }

      // Ensure at least one checkbox is selected
      document.getElementById('exportForm').addEventListener('submit', function(e) {
        const checkboxes = this.querySelectorAll('input[type="checkbox"]:checked');
        if (checkboxes.length === 0) {
          e.preventDefault();
          alert('Please select at least one field to include in the report.');
        }
      });
    });
   function printBarcodes() {
        // Create a new window for printing
        let printWindow = window.open('', '_blank');
        
        // Get all supply rows to extract barcode and name data
        let supplyRows = document.querySelectorAll('tbody tr');
        
        // Create print content
        let content = `
            <html>
            <head>
                <title>Print Supply Barcodes</title>
                <link rel="stylesheet" href="{% static 'css/barcode.css' %}">
                <style>
                    body { margin: 0; padding: 20px; }
                    .print-grid {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 20px;
                        padding: 20px;
                    }
                    .barcode-container {
                        background: white;
                        padding: 15px;
                        border: 1px solid #ddd;
                        text-align: center;
                    }
                    .barcode-image {
                        max-width: 100%;
                        height: auto;
                        margin-bottom: 10px;
                    }
                    .barcode-name {
                        font-weight: bold;
                        font-size: 14px;
                        color: #333;
                        margin-top: 8px;
                        word-wrap: break-word;
                    }
                </style>
            </head>
            <body>
                <div class="print-grid">
        `;
        
        // Add each barcode with its name to the content
        supplyRows.forEach((row, index) => {
            const barcodeImg = row.querySelector('.barcode-container img');
            const supplyNameCell = row.cells[1]; // Supply name is in the second column
            
            if (barcodeImg && supplyNameCell) {
                const supplyName = supplyNameCell.textContent.trim();
                const barcodeSrc = barcodeImg.src;
                
                content += `
                    <div class="barcode-container">
                        <img src="${barcodeSrc}" alt="Barcode for ${supplyName}" class="barcode-image">
                        <div class="barcode-name">${supplyName}</div>
                    </div>
                `;
            }
        });
        
        content += `
                </div>
            </body>
            </html>
        `;
        
        // Write content to new window and print
        printWindow.document.write(content);
        printWindow.document.close();
        printWindow.onload = function() {
            printWindow.print();
            printWindow.onafterprint = function() {
                printWindow.close();
            };
        };
    }

    function printSingleBarcode(button) {
        // Create a new window for printing
        let printWindow = window.open('', '_blank');
        
        // Get the barcode data and name from the button's data attributes
        let barcode = button.getAttribute('data-barcode');
        let name = button.getAttribute('data-name');
        
        // Create print content
        let content = `
            <html>
            <head>
                <title>Print Barcode - ${name}</title>
                <link rel="stylesheet" href="{% static 'css/barcode.css' %}">
                <style>
                    body { margin: 0; padding: 20px; }
                    .barcode-container {
                        background: white;
                        padding: 15px;
                        border: 1px solid #ddd;
                        margin: 20px auto;
                        max-width: 300px;
                    }
                    .barcode-title {
                        text-align: center;
                        margin-bottom: 10px;
                        font-family: Arial, sans-serif;
                        font-size: 14px;
                        color: #333;
                    }
                </style>
            </head>
            <body>
                <div class="barcode-container">
                    <div class="barcode-title">${name}</div>
                    <img src="${barcode}" alt="Barcode for ${name}" class="barcode-image">
                </div>
            </body>
            </html>
        `;
        
        // Write content to new window and print
        printWindow.document.write(content);
        printWindow.document.close();
        printWindow.onload = function() {
            printWindow.print();
            printWindow.onafterprint = function() {
                printWindow.close();
            };
        };
    }
  </script>
  {% endblock %}

<!-- Enhanced Barcode Selection JavaScript -->
<script>
// Enhanced Barcode Selection Functionality
function openBarcodeSelectionModal() {
    const modal = document.getElementById('barcodeSelectionModal');
    const tableBody = document.getElementById('barcodeSelectionTableBody');
    
    // Clear existing content and show loading message
    tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px;"><i class="fas fa-spinner fa-spin"></i> Loading all supplies...</td></tr>';
    
    // Show modal immediately
    modal.style.display = 'block';
    
    // Fetch all supply barcodes from server
    fetch('{% url "get_all_supply_barcodes" %}')
        .then(response => response.json())
        .then(data => {
            // Clear loading message
            tableBody.innerHTML = '';
            
            if (!data.success) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #dc3545;"><i class="fas fa-exclamation-circle"></i> Error loading supplies: ' + (data.error || 'Unknown error') + '</td></tr>';
                return;
            }
            
            if (data.barcodes.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #6c757d;"><i class="fas fa-info-circle"></i> No supplies found.</td></tr>';
                return;
            }
            
            console.log(`Loaded ${data.count} supplies from server`);
            
            // Populate table with all supplies
            data.barcodes.forEach((item, index) => {
                const tableRow = document.createElement('tr');
                tableRow.style.transition = 'background-color 0.2s ease';
                tableRow.className = 'barcode-row'; // Add class for search filtering
                tableRow.innerHTML = `
                    <td style="padding: 12px 15px; border-bottom: 1px solid #eee; text-align: center;">
                        <input type="checkbox" class="barcode-checkbox" data-index="${index}" 
                               style="width: 18px; height: 18px; cursor: pointer;">
                    </td>
                    <td style="padding: 12px 15px; border-bottom: 1px solid #eee; font-weight: 500;" class="supply-name-cell">
                        ${item.supply_name}
                    </td>
                    <td style="padding: 12px 15px; border-bottom: 1px solid #eee; text-align: center;" class="category-cell">
                        ${item.category}
                    </td>
                    <td style="padding: 12px 15px; border-bottom: 1px solid #eee; text-align: center;">
                        <input type="number" class="quantity-input" data-index="${index}" 
                               value="1" min="1" max="100" disabled
                               style="width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 4px; text-align: center; background-color: #f8f9fa;">
                    </td>
                `;
                
                // Store barcode data for later use
                tableRow.dataset.barcodeSrc = item.barcode;
                tableRow.dataset.supplyName = item.supply_name;
                tableRow.dataset.category = item.category;
                
                tableBody.appendChild(tableRow);
            });
            
            // Reset modal state
            document.getElementById('selectAllBarcodes').checked = false;
            document.getElementById('defaultQuantity').value = 1;
            document.getElementById('barcodeSearchInput').value = ''; // Clear search
            updateSelectionSummary();
        })
        .catch(error => {
            console.error('Error fetching supplies:', error);
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #dc3545;"><i class="fas fa-exclamation-circle"></i> Error loading supplies: ' + error.message + '</td></tr>';
        });
}

// Search functionality for supply barcode selection modal
function filterBarcodeTable() {
    const searchInput = document.getElementById('barcodeSearchInput');
    const searchTerm = searchInput.value.toLowerCase().trim();
    const rows = document.querySelectorAll('#barcodeSelectionTableBody .barcode-row');
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        const supplyName = row.querySelector('.supply-name-cell').textContent.toLowerCase();
        const category = row.querySelector('.category-cell').textContent.toLowerCase();
        const barcodeSrc = row.dataset.barcodeSrc.toLowerCase();
        
        // Check if search term matches supply name, category, or barcode
        const matches = searchTerm === '' || 
                       supplyName.includes(searchTerm) || 
                       category.includes(searchTerm) || 
                       barcodeSrc.includes(searchTerm);
        
        if (matches) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
            // Keep hidden rows checked if they were selected
            // This preserves user selections across searches
        }
    });
    
    // Update selection summary and select all state
    updateSelectionSummary();
    updateSelectAllState();
    
    // Show no results message if needed
    const tableBody = document.getElementById('barcodeSelectionTableBody');
    let noResultsRow = document.getElementById('noResultsRow');
    
    if (visibleCount === 0 && searchTerm !== '') {
        if (!noResultsRow) {
            noResultsRow = document.createElement('tr');
            noResultsRow.id = 'noResultsRow';
            noResultsRow.innerHTML = `
                <td colspan="4" style="padding: 20px; text-align: center; color: #6c757d; font-style: italic;">
                    No barcodes found matching "${searchTerm}"
                </td>
            `;
            tableBody.appendChild(noResultsRow);
        }
    } else if (noResultsRow) {
        noResultsRow.remove();
    }
}

// Handle checkbox changes
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('barcode-checkbox')) {
        const index = e.target.dataset.index;
        const quantityInput = document.querySelector(`.quantity-input[data-index="${index}"]`);
        
        if (e.target.checked) {
            quantityInput.disabled = false;
            quantityInput.style.backgroundColor = 'white';
        } else {
            quantityInput.disabled = true;
            quantityInput.style.backgroundColor = '#f8f9fa';
        }
        
        updateSelectionSummary();
        updateSelectAllState();
    }
    
    if (e.target.classList.contains('quantity-input')) {
        updateSelectionSummary();
    }
});

// Handle Select All checkbox and other event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Add search input event listener
    const barcodeSearchInput = document.getElementById('barcodeSearchInput');
    if (barcodeSearchInput) {
        barcodeSearchInput.addEventListener('input', filterBarcodeTable);
        
        // Add search input focus styling
        barcodeSearchInput.addEventListener('focus', function() {
            this.style.borderColor = '#152d64';
            this.style.boxShadow = '0 0 5px rgba(21, 45, 100, 0.2)';
        });
        
        barcodeSearchInput.addEventListener('blur', function() {
            this.style.borderColor = '#ddd';
            this.style.boxShadow = 'none';
        });
    }
    
    const selectAllCheckbox = document.getElementById('selectAllBarcodes');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            // Only affect visible checkboxes
            const visibleCheckboxes = document.querySelectorAll('.barcode-row:not([style*="display: none"]) .barcode-checkbox');
            const visibleQuantityInputs = document.querySelectorAll('.barcode-row:not([style*="display: none"]) .quantity-input');
            
            visibleCheckboxes.forEach((checkbox, index) => {
                checkbox.checked = this.checked;
                const quantityInput = visibleQuantityInputs[index];
                
                if (this.checked) {
                    quantityInput.disabled = false;
                    quantityInput.style.backgroundColor = 'white';
                } else {
                    quantityInput.disabled = true;
                    quantityInput.style.backgroundColor = '#f8f9fa';
                }
            });
            
            updateSelectionSummary();
        });
    }
    
    // Apply default quantity to selected items
    const applyDefaultBtn = document.getElementById('applyDefaultQuantity');
    if (applyDefaultBtn) {
        applyDefaultBtn.addEventListener('click', function() {
            const defaultQuantity = document.getElementById('defaultQuantity').value;
            const selectedQuantityInputs = document.querySelectorAll('.quantity-input:not([disabled])');
            
            selectedQuantityInputs.forEach(input => {
                input.value = defaultQuantity;
            });
            
            updateSelectionSummary();
        });
    }
    
    // Print selected barcodes
    const printBtn = document.getElementById('printSelectedBarcodes');
    if (printBtn) {
        printBtn.addEventListener('click', function() {
            const selectedCheckboxes = document.querySelectorAll('.barcode-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('Please select at least one barcode to print.');
                return;
            }
            
            printSelectedBarcodesFunction(selectedCheckboxes);
            document.getElementById('barcodeSelectionModal').style.display = 'none';
        });
    }
    

    
    // Close modal functionality
    const closeBtn = document.getElementById('closeBarcodeSelectionBtn');
    if (closeBtn) {
        closeBtn.addEventListener('click', function() {
            document.getElementById('barcodeSelectionModal').style.display = 'none';
        });
    }
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('barcodeSelectionModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
});

// Update selection summary
function updateSelectionSummary() {
    const selectedCheckboxes = document.querySelectorAll('.barcode-checkbox:checked');
    const selectedCount = selectedCheckboxes.length;
    
    let totalCopies = 0;
    selectedCheckboxes.forEach(checkbox => {
        const index = checkbox.dataset.index;
        const quantityInput = document.querySelector(`.quantity-input[data-index="${index}"]`);
        totalCopies += parseInt(quantityInput.value) || 0;
    });
    
    const selectedCountEl = document.getElementById('selectedCount');
    const totalCopiesEl = document.getElementById('totalCopies');
    
    if (selectedCountEl) selectedCountEl.textContent = selectedCount;
    if (totalCopiesEl) totalCopiesEl.textContent = totalCopies;
}

// Update Select All state based on individual selections
function updateSelectAllState() {
    const visibleCheckboxes = document.querySelectorAll('.barcode-row:not([style*="display: none"]) .barcode-checkbox');
    const checkedVisibleCheckboxes = document.querySelectorAll('.barcode-row:not([style*="display: none"]) .barcode-checkbox:checked');
    const selectAllCheckbox = document.getElementById('selectAllBarcodes');
    
    if (!selectAllCheckbox) return;
    
    if (checkedVisibleCheckboxes.length === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (checkedVisibleCheckboxes.length === visibleCheckboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
    }
}

// Function to print selected barcodes
function printSelectedBarcodesFunction(selectedCheckboxes) {
    let printWindow = window.open('', '_blank');
    
    let content = `
        <html>
        <head>
            <title>Print Selected Supply Barcodes</title>
            <link rel="stylesheet" href="{% static 'css/barcode.css' %}">
            <style>
                body { margin: 0; padding: 20px; }
                .print-grid {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 20px;
                    padding: 20px;
                }
                .barcode-container {
                    background: white;
                    padding: 15px;
                    border: 1px solid #ddd;
                    text-align: center;
                    page-break-inside: avoid;
                }
                .barcode-image {
                    max-width: 100%;
                    height: auto;
                    margin-bottom: 10px;
                }
                .barcode-name {
                    font-weight: bold;
                    font-size: 14px;
                    color: #333;
                    margin-top: 8px;
                    word-wrap: break-word;
                }
                .barcode-category {
                    font-size: 12px;
                    color: #666;
                    margin-top: 4px;
                }
            </style>
        </head>
        <body>
            <div class="print-grid">
    `;
    
    selectedCheckboxes.forEach(checkbox => {
        const index = checkbox.dataset.index;
        const quantityInput = document.querySelector(`.quantity-input[data-index="${index}"]`);
        const quantity = parseInt(quantityInput.value) || 1;
        const row = checkbox.closest('tr');
        
        const barcodeSrc = row.dataset.barcodeSrc;
        const supplyName = row.dataset.supplyName;
        const category = row.dataset.category;
        
        // Add multiple copies based on quantity
        for (let i = 0; i < quantity; i++) {
            content += `
                <div class="barcode-container">
                    <img src="${barcodeSrc}" alt="Barcode for ${supplyName}" class="barcode-image">
                    <div class="barcode-name">${supplyName}</div>
                </div>
            `;
        }
    });
    
    content += `
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(content);
    printWindow.document.close();
    printWindow.onload = function() {
        printWindow.print();
        printWindow.onafterprint = function() {
            printWindow.close();
        };
    };
}

// Enhanced Supply Inventory Modal JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Modal Elements
    const modifyQuantityModal = document.getElementById('modifyQuantityModal');
    const closeModifyQuantityModalBtn = document.getElementById('closeModifyQuantityModalBtn');
    const cancelInventory = document.getElementById('cancelInventory');
    const submitInventory = document.getElementById('submitInventory');
    
    // Input Elements
    const barcodeInput = document.getElementById('barcode_input');
    const manualSupplySelect = document.getElementById('manual_supply_select');
    const barcodeInputGroup = document.getElementById('barcodeInputGroup');
    const manualInputGroup = document.getElementById('manualInputGroup');
    const addManualItem = document.getElementById('addManualItem');
    
    // Mode Toggle Buttons
    const barcodeModeBtn = document.getElementById('barcodeModeBtn');
    const manualModeBtn = document.getElementById('manualModeBtn');
    
    // Display Elements
    const itemsContainer = document.getElementById('itemsContainer');
    const noItemsMessage = document.getElementById('noItemsMessage');
    const itemCount = document.getElementById('itemCount');
    const totalItemsCount = document.getElementById('totalItemsCount');
    const clearAllItems = document.getElementById('clearAllItems');
    
    // Data
    let scannedItems = [];
    let currentMode = 'barcode';

    // Initialize modal
    function initializeModal() {
        scannedItems = [];
        updateDisplay();
        setMode('barcode');
        if (barcodeInput) {
            barcodeInput.value = '';
            barcodeInput.focus();
        }
        if (manualSupplySelect) {
            manualSupplySelect.value = '';
        }
    }

    // Set input mode
    function setMode(mode) {
        currentMode = mode;
        
        if (mode === 'barcode') {
            barcodeInputGroup.style.display = 'block';
            manualInputGroup.style.display = 'none';
            barcodeModeBtn.classList.add('active');
            manualModeBtn.classList.remove('active');
            barcodeModeBtn.style.backgroundColor = '#152d64';
            barcodeModeBtn.style.color = 'white';
            manualModeBtn.style.backgroundColor = '#e9ecef';
            manualModeBtn.style.color = '#333';
            if (barcodeInput) barcodeInput.focus();
        } else {
            barcodeInputGroup.style.display = 'none';
            manualInputGroup.style.display = 'block';
            barcodeModeBtn.classList.remove('active');
            manualModeBtn.classList.add('active');
            manualModeBtn.style.backgroundColor = '#152d64';
            manualModeBtn.style.color = 'white';
            barcodeModeBtn.style.backgroundColor = '#e9ecef';
            barcodeModeBtn.style.color = '#333';
        }
    }

    // Process barcode input
    function processBarcode(barcode) {
        if (!barcode.trim()) return;
        
        // Look for supplies by barcode
        const options = manualSupplySelect.querySelectorAll('option');
        let foundSupply = null;
        
        for (let option of options) {
            if (option.value) {
                const optionBarcode = option.getAttribute('data-barcode');
                // Match against barcode first, then fallback to name matching
                if (optionBarcode && optionBarcode.toLowerCase() === barcode.toLowerCase()) {
                    foundSupply = {
                        id: option.value,
                        name: option.getAttribute('data-name'),
                        currentQuantity: option.getAttribute('data-quantity'),
                        description: option.getAttribute('data-description') || 'N/A',
                        source: 'barcode'
                    };
                    break;
                } else if (option.textContent.toLowerCase().includes(barcode.toLowerCase()) || 
                          option.getAttribute('data-name').toLowerCase().includes(barcode.toLowerCase())) {
                    foundSupply = {
                        id: option.value,
                        name: option.getAttribute('data-name'),
                        currentQuantity: option.getAttribute('data-quantity'),
                        description: option.getAttribute('data-description') || 'N/A',
                        source: 'barcode'
                    };
                    break;
                }
            }
        }
        
        if (foundSupply) {
            addItemToList(foundSupply);
        } else {
            showErrorMessage('Supply not found for barcode: ' + barcode);
        }
        
        // Clear and refocus barcode input
        barcodeInput.value = '';
        barcodeInput.focus();
    }

    // Add item to list
    function addItemToList(itemData) {
        const existingIndex = scannedItems.findIndex(item => item.id === itemData.id);
        
        if (existingIndex !== -1) {
            scannedItems[existingIndex].quantityToAdd += 1;
        } else {
            scannedItems.push({
                ...itemData,
                quantityToAdd: 1
            });
        }
        
        updateDisplay();
    }

    // Update display
    function updateDisplay() {
        const totalItems = scannedItems.length;
        const totalQuantity = scannedItems.reduce((sum, item) => sum + item.quantityToAdd, 0);
        
        itemCount.textContent = totalItems;
        totalItemsCount.textContent = totalQuantity;
        
        clearAllItems.disabled = totalItems === 0;
        submitInventory.disabled = totalItems === 0;
        
        renderItems();
    }

    // Render items
    function renderItems() {
        itemsContainer.innerHTML = '';
        
        if (scannedItems.length === 0) {
            noItemsMessage.style.display = 'flex';
            itemsContainer.appendChild(noItemsMessage);
        } else {
            noItemsMessage.style.display = 'none';
            
            scannedItems.forEach((item, index) => {
                const itemElement = createSupplyItemElement(item, index);
                itemsContainer.appendChild(itemElement);
            });
        }
    }
    
    // Create supply item element with improved layout
    function createSupplyItemElement(item, index) {
        const div = document.createElement('div');
        div.className = 'scanned-item';
        div.style.cssText = 'display: flex; align-items: center; padding: 12px 20px; background: white; border-bottom: 1px solid #eee; width: 100%; box-sizing: border-box; flex-shrink: 0;';
        
        div.innerHTML = `
            <div style="flex: 1; min-width: 0; margin-right: 15px;">
                <div style="font-weight: 500; font-size: 14px; color: #333; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.name}</div>
                <div style="font-size: 12px; color: #666; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                    <span>Current Stock: <strong>${item.currentQuantity}</strong></span>
                    <span style="color: ${item.source === 'barcode' ? '#28a745' : '#007bff'};">${item.source === 'barcode' ? ' Scanned' : ' Manual'}</span>
                    ${item.description ? `<span style="color: #6c757d; font-style: italic;">${item.description}</span>` : ''}
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                <button type="button" onclick="updateSupplyQuantity(${index}, -1)" style="width: 28px; height: 28px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; display: flex; align-items: center; justify-content: center;">-</button>
                <input type="number" value="${item.quantityToAdd}" min="1" max="999" onchange="setSupplyQuantity(${index}, this.value)" style="width: 60px; text-align: center; border: 1px solid #ddd; border-radius: 4px; padding: 6px 4px; font-size: 14px; font-weight: 500;">
                <button type="button" onclick="updateSupplyQuantity(${index}, 1)" style="width: 28px; height: 28px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; display: flex; align-items: center; justify-content: center;">+</button>
                <button type="button" onclick="removeItem(${index})" style="width: 28px; height: 28px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 8px; display: flex; align-items: center; justify-content: center;"></button>
            </div>
        `;
        
        return div;
    }

    // Update supply quantity with +/- buttons
    window.updateSupplyQuantity = function(index, change) {
        if (index >= 0 && index < scannedItems.length) {
            const newQuantity = Math.max(1, scannedItems[index].quantityToAdd + change);
            scannedItems[index].quantityToAdd = newQuantity;
            updateDisplay();
        }
    };
    
    // Set supply quantity directly from input
    window.setSupplyQuantity = function(index, value) {
        if (index >= 0 && index < scannedItems.length) {
            const newQuantity = Math.max(1, parseInt(value) || 1);
            scannedItems[index].quantityToAdd = newQuantity;
            updateDisplay();
        }
    };

    // Remove item
    window.removeItem = function(index) {
        scannedItems.splice(index, 1);
        updateDisplay();
    };

    // Show error message
    function showErrorMessage(message) {
        // Create temporary error message
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            background: #dc3545; color: white; padding: 12px 16px;
            border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        errorDiv.textContent = message;
        document.body.appendChild(errorDiv);
        
        setTimeout(() => {
            errorDiv.remove();
        }, 3000);
    }

    // Event Listeners
    if (barcodeModeBtn) {
        barcodeModeBtn.addEventListener('click', () => setMode('barcode'));
    }
    
    if (manualModeBtn) {
        manualModeBtn.addEventListener('click', () => setMode('manual'));
    }
    
    if (barcodeInput) {
        barcodeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                processBarcode(this.value);
            }
        });
    }
    
    if (addManualItem) {
        addManualItem.addEventListener('click', function() {
            const selectedOption = manualSupplySelect.options[manualSupplySelect.selectedIndex];
            if (selectedOption.value) {
                const itemData = {
                    id: selectedOption.value,
                    name: selectedOption.getAttribute('data-name'),
                    currentQuantity: selectedOption.getAttribute('data-quantity'),
                    description: selectedOption.getAttribute('data-description') || 'N/A',
                    source: 'manual'
                };
                addItemToList(itemData);
                manualSupplySelect.value = '';
            }
        });
    }
    
    if (clearAllItems) {
        clearAllItems.addEventListener('click', function() {
            scannedItems = [];
            updateDisplay();
        });
    }
    
    if (cancelInventory) {
        cancelInventory.addEventListener('click', function() {
            modifyQuantityModal.style.display = 'none';
            initializeModal();
        });
    }
    
    if (closeModifyQuantityModalBtn) {
        closeModifyQuantityModalBtn.addEventListener('click', function() {
            modifyQuantityModal.style.display = 'none';
            initializeModal();
        });
    }
    
    if (submitInventory) {
        submitInventory.addEventListener('click', function() {
            if (scannedItems.length === 0) return;
            
            // Submit each item individually for now
            // You can modify this to batch submit if you have a batch endpoint
            let itemsProcessed = 0;
            const totalItems = scannedItems.length;
            
            scannedItems.forEach((item, index) => {
                const form = document.getElementById('modifyQuantityForm');
                const supplyIdInput = document.getElementById('supply_id');
                const amountInput = document.getElementById('amount');
                
                supplyIdInput.value = item.id;
                amountInput.value = item.quantityToAdd;
                
                // Submit form via fetch to avoid page reload
                const formData = new FormData(form);
                
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => {
                    itemsProcessed++;
                    if (itemsProcessed === totalItems) {
                        // All items processed, close modal and refresh page
                        modifyQuantityModal.style.display = 'none';
                        initializeModal();
                        window.location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error updating supply:', error);
                    showErrorMessage('Error updating supply: ' + item.name);
                });
            });
        });
    }
    
    // Handle quantity input changes
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('supply-quantity-input')) {
            const index = parseInt(e.target.dataset.index);
            const newQuantity = Math.max(1, parseInt(e.target.value) || 1);
            scannedItems[index].quantityToAdd = newQuantity;
            e.target.value = newQuantity;
            updateDisplay();
        }
    });
    
    // Initialize when modal opens
    const openModifyQuantityModalBtn = document.getElementById('openModifyQuantityModalBtn');
    if (openModifyQuantityModalBtn) {
        openModifyQuantityModalBtn.addEventListener('click', function() {
            modifyQuantityModal.style.display = 'block';
            initializeModal();
        });
    }
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === modifyQuantityModal) {
            modifyQuantityModal.style.display = 'none';
            initializeModal();
        }
    });
});

</script>

<!-- Barcode Selection Modal -->
<div id="barcodeSelectionModal" class="modal" style="display: none;">
  <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
    <span class="close" id="closeBarcodeSelectionBtn">&times;</span>
    <h2 style="color: #152d64; margin-bottom: 25px;">Select Barcodes to Print</h2>
    
    <!-- Search Input -->
    <div style="margin-bottom: 20px;">
      <div style="position: relative; max-width: 400px;">
        <input type="text" id="barcodeSearchInput" placeholder="Search by supply name, category, or barcode..." 
               style="width: 100%; padding: 10px 40px 10px 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; transition: border-color 0.3s ease;">
        <i class="fas fa-search" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #6c757d; pointer-events: none;"></i>
      </div>
    </div>
    
    <!-- Select All and Default Quantity Controls -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 6px;">
      <div style="display: flex; align-items: center; gap: 15px;">
        <label style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
          <input type="checkbox" id="selectAllBarcodes" style="width: 18px; height: 18px;">
          Select All
        </label>
        <div style="display: flex; align-items: center; gap: 8px;">
          <label for="defaultQuantity" style="font-weight: 500;">Default Quantity:</label>
          <input type="number" id="defaultQuantity" value="1" min="1" max="100" 
                 style="width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
          <button id="applyDefaultQuantity" class="action-btn" 
                  style="background-color: #4a5568; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
            Apply to Selected
          </button>
        </div>
      </div>
      <div style="display: flex; gap: 10px;">
        <button id="printSelectedBarcodes" class="action-btn primary-btn" 
                style="background-color: #152d64; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
          <i class="fas fa-print"></i> Print Selected
        </button>
      </div>
    </div>
    
    <!-- Barcode Selection Table -->
    <div class="table-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px;">
      <table id="barcodeSelectionTable" style="width: 100%; border-collapse: collapse; background: white;">
        <thead style="position: sticky; top: 0; z-index: 1;">
          <tr>
            <th style="background-color: #152d64; color: white; padding: 12px 15px; text-align: center; width: 60px;">Select</th>
            <th style="background-color: #152d64; color: white; padding: 12px 15px; text-align: left;">Supply Name</th>
            <th style="background-color: #152d64; color: white; padding: 12px 15px; text-align: center;">Category</th>
            <th style="background-color: #152d64; color: white; padding: 12px 15px; text-align: center; width: 120px;">Quantity</th>
          </tr>
        </thead>
        <tbody id="barcodeSelectionTableBody">
          <!-- Dynamic content will be inserted here -->
        </tbody>
      </table>
    </div>
    
    <!-- Summary -->
    <div id="selectionSummary" style="margin-top: 15px; padding: 10px; background-color: #e9ecef; border-radius: 4px; font-weight: 500;">
      Selected: <span id="selectedCount">0</span> items | Total copies: <span id="totalCopies">0</span>
    </div>
  </div>
</div>

</body>
</html>