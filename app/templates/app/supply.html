{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Supply List</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    .history-btn {
      background-color: #152d64;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      cursor: pointer;
      margin: 0 2px;
      transition: background-color 0.3s;
    }

    .history-btn:hover {
      background-color: #1e3d8a;
    }

    /* History Modal Styles */
    .history-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .history-modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 800px;
      border-radius: 8px;
      position: relative;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .history-table th {
      background-color: #152d64;
      color: white;
      padding: 12px;
      text-align: left;
    }

    .history-table td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }

    .history-table tr:hover {
      background-color: #f5f5f5;
    }

    .close {
      color: #152d64;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: #1e3d8a;
    }
  </style>
</head>
<body>
  {% include 'app/navbar.html' %}
  {% block content %}

    {% if messages %}
      {% for message in messages %}
        {% if message.tags == 'success' %}
        <div class="success-container">
          <div class="success-message">
            <i class="fas fa-check"></i>
            <p class="success-text">{{ message }}</p>
          </div>
        </div>
        {% endif %}
      {% endfor %}
    {% endif %}

    <div class="parent">
      <div class="div1">
        <h2>Supplies</h2>
      </div>

  <div class="content">
    <!-- Add Supply Button -->
    <div class="add-property-container">
      <button id="openModalBtn" class="add-btn">+ Add Supply</button>
    </div>

    {% if grouped_supplies %}
      {% for category, page_obj in grouped_supplies.items %}
        <h3>{{ category }}</h3>
        <table border="1">
          <thead>
            <tr>
              <th>No.</th>
              <th>Supply Name</th>
              <th>Description</th>
              <th>Sub Category</th>
              <th>Current Quantity</th>
              <th>Min. Threshold</th>
              <th>Status</th>
              <th>Available</th>
              <th>Barcode</th>
              <th>Date Received</th>
              <th>Expiration Date</th>
              <th>Last Updated</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for supply in page_obj %}
            <tr>
              <td>{{ page_obj.start_index|add:forloop.counter0 }}</td>
              <td>{{ supply.supply_name|default:"N/A" }}</td>
              <td>{{ supply.description|default:"N/A" }}</td>
              <td><strong>{{ supply.get_subcategory_display|default:"N/A" }}</strong></td>
              <td>{{ supply.quantity_info.current_quantity|default:"N/A" }}</td>
              <td>{{ supply.quantity_info.minimum_threshold|default:"N/A" }}</td>
              <td>
                <span class="status-badge status-{{ supply.status }}">
                  {% if supply.status == 'available' %}
                    <i class="fas fa-check-circle"></i>
                  {% elif supply.status == 'low_stock' %}
                    <i class="fas fa-exclamation-circle"></i>
                  {% elif supply.status == 'out_of_stock' %}
                    <i class="fas fa-times-circle"></i>
                  {% endif %}
                  {{ supply.get_status_display }}
                </span>
              </td>
              <td>{{ supply.available_for_request|yesno:"Yes,No" }}</td>
              <td>{{ supply.barcode|default:"N/A" }}</td>
              <td>{{ supply.date_received|default:"N/A" }}</td>
              <td>
                {% if supply.expiration_date %}
                  <div class="expiration-badge 
                    {% if supply.days_until_expiration < 0 %}expired
                    {% elif supply.days_until_expiration <= 30 %}nearly-expired
                    {% else %}not-expired{% endif %}">
                    {% if supply.days_until_expiration < 0 %}
                      <i class="fas fa-exclamation-triangle"></i> Expired
                    {% elif supply.days_until_expiration <= 30 %}
                      <i class="fas fa-clock"></i> Expires in {{ supply.days_until_expiration }} days
                    {% else %}
                      <i class="fas fa-check"></i> {{ supply.expiration_date|date:"M d, Y" }}
                    {% endif %}
                  </div>
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>{{ supply.last_updated|default:"N/A" }}</td>
              <td>
                <div class="button-group">
                  <button class="edit-btn" 
                  data-id="{{ supply.id }}"
                  data-name="{{ supply.supply_name }}"
                  data-current-quantity="{{ supply.quantity_info.current_quantity }}"
                  data-minimum-threshold="{{ supply.quantity_info.minimum_threshold }}"
                  data-category="{{ supply.category }}"
                  data-subcategory="{{ supply.subcategory }}"
                  data-description="{{ supply.description }}"
                  data-date="{{ supply.date_received|date:'Y-m-d' }}"
                  data-expiration-date="{{ supply.expiration_date|date:'Y-m-d' }}"
                  data-barcode="{{ supply.barcode }}"
                  title="Edit">
                    <i class="fas fa-edit"></i>
                  </button>

                  <button class="history-btn" 
                  data-id="{{ supply.id }}"
                  title="View History">
                    <i class="fas fa-history"></i>
                  </button>

                  <form method="POST" action="{% url 'delete_supply' supply.id %}">
                    {% csrf_token %}
                    <button type="submit" class="del-btn" onclick="return confirm('Are you sure you want to delete this supply?');" title="Delete">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="12">No supplies available in this category.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% with category=category %}
          {% include 'app/includes/pagination.html' %}
        {% endwith %}
      {% endfor %}
    {% else %}
      <p>No supplies available.</p>
    {% endif %}
  </div>

  <!-- Add Supply Modal -->
  <div id="addSupplyModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModalBtn">&times;</span>
      <h3>Add New Supply</h3>
      <form method="POST" action="{% url 'add_supply' %}">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="submit-btn">Submit</button>
      </form>
    </div>
  </div>

  <!-- Edit Supply Modal -->
  <div id="editSupplyModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeEditModalBtn">&times;</span>
      <h3>Edit Supply</h3>
      <form method="POST" action="{% url 'edit_supply' %}">
        {% csrf_token %}
        <input type="hidden" name="id" id="edit_id" />
        
        <div class="form-group">
          <label>Supply Name</label>
          <input type="text" name="supply_name" id="edit_name" required />
        </div>

        <div class="form-group">
          <label>Current Quantity</label>
          <input type="number" name="current_quantity" id="edit_current_quantity" required min="0" />
        </div>

        <div class="form-group">
          <label>Minimum Threshold</label>
          <input type="number" name="minimum_threshold" id="edit_minimum_threshold" required min="0" />
        </div>

        <div class="form-group">
          <label>Category</label>
          <select name="category" id="edit_category" required>
            {% for value, label in form.fields.category.choices %}
              <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label>Sub Category</label>
          <select name="subcategory" id="edit_subcategory" required>
            {% for value, label in form.fields.subcategory.choices %}
              <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea name="description" id="edit_description" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label>Date Received</label>
          <input type="date" name="date_received" id="edit_date" required />
        </div>

        <div class="form-group">
          <label>Expiration Date (Optional)</label>
          <input type="date" name="expiration_date" id="edit_expiration_date" />
          <small class="help-text">Leave empty if the supply does not expire.</small>
        </div>

        <div class="form-group">
          <label>Barcode</label>
          <input type="text" name="barcode" id="edit_barcode" required />
        </div>

        <button type="submit" class="submit-btn">Update</button>
      </form>
    </div>
  </div>

  <script src="{% static 'scripts/supplyModal.js' %}"></script>

  <!-- History Modal -->
  <div id="historyModal" class="history-modal">
    <div class="history-modal-content">
      <span class="close" id="closeHistoryModalBtn">&times;</span>
      <h3>Supply History</h3>
      <div id="historyContent">
        <table class="history-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Action</th>
              <th>Previous Value</th>
              <th>New Value</th>
              <th>Changed By</th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
            <!-- History data will be populated here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Auto-hide success messages after 2 seconds
    document.addEventListener('DOMContentLoaded', function() {
      const successMessage = document.querySelector('.success-container');
      if (successMessage) {
        setTimeout(function() {
          successMessage.style.opacity = '0';
          successMessage.style.transition = 'opacity 0.3s ease-out';
          setTimeout(function() {
            successMessage.remove();
          }, 300);
        }, 2000);
      }

      // History Modal functionality
      const historyModal = document.getElementById('historyModal');
      const historyBtns = document.querySelectorAll('.history-btn');
      const closeHistoryModalBtn = document.getElementById('closeHistoryModalBtn');

      historyBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const supplyId = this.getAttribute('data-id');
          historyModal.style.display = 'block';
          
          // Fetch history data from the backend
          fetch(`/api/supply/${supplyId}/history/`)
            .then(response => response.json())
            .then(data => {
              // Populate the history table
              const tbody = document.getElementById('historyTableBody');
              if (data.history && data.history.length > 0) {
                tbody.innerHTML = data.history.map(item => `
                  <tr>
                    <td>${item.date}</td>
                    <td>${item.action} - ${item.field}</td>
                    <td>${item.previous_value}</td>
                    <td>${item.new_value}</td>
                    <td>${item.changed_by}</td>
                  </tr>
                `).join('');
              } else {
                tbody.innerHTML = `
                  <tr>
                    <td colspan="5" class="text-center">No history or changes yet.</td>
                  </tr>
                `;
              }
            })
            .catch(error => {
              console.error('Error fetching history:', error);
              document.getElementById('historyTableBody').innerHTML = `
                <tr>
                  <td colspan="5" class="text-center">Error loading history data</td>
                </tr>
              `;
            });
        });
      });

      closeHistoryModalBtn.addEventListener('click', function() {
        historyModal.style.display = 'none';
      });

      window.addEventListener('click', function(event) {
        if (event.target == historyModal) {
          historyModal.style.display = 'none';
        }
      });
    });
  </script>

  {% endblock %}
</body>
</html>