{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Supply Request {{ batch_request.id|stringformat:"03d" }} Details</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    /* Main container matching system theme */
    .batch-details {
      padding: 20px;
      margin-left: 270px;
      background-color: #f5f6fa;
      min-height: 100vh;
    }
    
    .page-title {
      color: #152d64;
      margin-bottom: 30px;
      font-size: 32px;
      font-weight: 600;
      text-align: center;
    }
    
    /* Header card with system styling */
    .batch-header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(21, 45, 100, 0.1);
    }
    
    .batch-header h1 {
      color: #152d64;
      margin: 0 0 20px 0;
      font-size: 28px;
      font-weight: 600;
    }
    
    .batch-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .info-item {
      display: flex;
      flex-direction: column;
    }
    
    .info-item strong {
      color: #152d64;
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .info-item span {
      color: #495057;
      font-size: 16px;
    }
    
    /* Status badge matching system theme */
    .batch-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 10px;
    }
    
    .batch-status.status-pending {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      color: #856404;
      border: 2px solid #ffeaa7;
    }
    
    .batch-status.status-approved {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724;
      border: 2px solid #c3e6cb;
    }
    
    .batch-status.status-rejected {
      background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      color: #721c24;
      border: 2px solid #f5c6cb;
    }
    
    .batch-status.status-partial {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      color: #856404;
      border: 2px solid #ffeaa7;
    }
    
    .batch-status.status-for_claiming {
      background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
      color: #0c5460;
      border: 2px solid #bee5eb;
    }
    
    /* Table-based layout for better scalability */
    .items-container {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(21, 45, 100, 0.1);
      margin-bottom: 30px;
    }
    
    .items-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .items-table thead {
      background: linear-gradient(135deg, #152d64 0%, #1e3a8a 100%);
      color: white;
    }
    
    .items-table th {
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 15px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .items-table th:last-child {
      border-right: none;
    }
    
    .items-table tbody tr {
      border-bottom: 1px solid #e9ecef;
      transition: background-color 0.2s ease;
    }
    
    .items-table tbody tr:hover {
      background-color: #f8f9fa;
    }
    
    .items-table tbody tr:last-child {
      border-bottom: none;
    }
    
    .items-table td {
      padding: 16px 12px;
      vertical-align: middle;
      font-size: 16px;
      color: #495057;
    }
    
    .item-name {
      font-weight: 600;
      color: #152d64;
      display: flex;
      align-items: flex-start;
      text-align: left;
    }
    
    .category-badge {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      color: #1565c0;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    
    .quantity-cell {
      text-align: center;
      font-weight: 600;
    }
    
    .stock-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .stock-available {
      font-weight: 600;
      color: #28a745;
    }
    
    .stock-approved {
      font-size: 12px;
      color: #6c757d;
    }
    
    .approve-input-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .approve-input {
      width: 60px;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
      font-weight: 600;
      font-size: 15px;
    }
    
    .approve-input:focus {
      outline: none;
      border-color: #152d64;
      box-shadow: 0 0 0 2px rgba(21, 45, 100, 0.1);
    }
    
    .qty-indicator {
      font-size: 13px;
      color: #6c757d;
    }
    
    .status-cell {
      text-align: center;
    }
    
    .actions-cell {
      text-align: center;
    }
    
    .action-buttons-inline {
      display: flex;
      gap: 6px;
      justify-content: center;
    }
    
    .btn-table {
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    
    .btn-table:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    .btn-approve-table {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
    }
    
    .btn-reject-table {
      background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
      color: white;
    }
    
    /* Compact remarks section */
    .remarks-row {
      background: #f8f9fa;
    }
    
    .remarks-container {
      padding: 12px;
    }
    
    .remarks-input {
      width: 100%;
      min-height: 40px;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
      resize: vertical;
      font-family: inherit;
    }
    
    .remarks-input:focus {
      outline: none;
      border-color: #152d64;
      box-shadow: 0 0 0 2px rgba(21, 45, 100, 0.1);
    }
    
    .remarks-label {
      font-size: 11px;
      font-weight: 600;
      color: #152d64;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    
    /* Status badge adjustments for table */
    .status-badge {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    
    .item-actions {
      padding: 20px;
      background: white;
    }
    
    /* Enhanced action buttons */
    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .btn-approve {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      border: 2px solid transparent;
    }
    
    .btn-approve:hover {
      background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
      color: white;
      text-decoration: none;
    }
    
    .btn-reject {
      background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
      color: white;
      border: 2px solid transparent;
    }
    
    .btn-reject:hover {
      background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
      color: white;
      text-decoration: none;
    }
    
    .btn-back {
      background: #152d64;
      color: white;
      border: 2px solid #152d64;
    }
    
    .btn-back:hover {
      background: white;
      color: #152d64;
      text-decoration: none;
    }
    
    /* Status badges for individual items */
    .status-approved {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-rejected {
      background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status-pending {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    /* Approved quantity styling */
    .approved-quantity {
      color: #28a745;
      font-weight: 600;
      font-size: 16px;
    }
    
    /* Enhanced remarks section */
    .remarks-section {
      margin-top: 15px;
      padding: 15px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 8px;
    }
    
    .remarks-section h4 {
      color: #152d64;
      margin: 0 0 10px 0;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .remarks-section textarea {
      width: 100%;
      min-height: 50px;
      padding: 10px;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      resize: vertical;
      font-family: inherit;
      font-size: 13px;
      transition: border-color 0.2s ease;
      background: white;
    }
    
    .remarks-section textarea:focus {
      outline: none;
      border-color: #152d64;
      box-shadow: 0 0 0 2px rgba(21, 45, 100, 0.1);
    }
    
    .remarks-section textarea::placeholder {
      color: #adb5bd;
      font-style: italic;
    }
    
    /* Approved quantity section */
    .approve-quantity-section {
      margin-top: 20px;
      padding: 20px;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      border-radius: 8px;
    }
    
    .approve-quantity-section h4 {
      color: #152d64;
      margin: 0 0 15px 0;
      font-size: 16px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .quantity-input-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    
    .quantity-input {
      width: 120px;
      padding: 10px 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      background: white;
      transition: all 0.2s ease;
    }
    
    .quantity-input:focus {
      outline: none;
      border-color: #152d64;
      box-shadow: 0 0 0 3px rgba(21, 45, 100, 0.1);
    }
    
    .quantity-max {
      color: #6c757d;
      font-size: 14px;
      font-weight: 500;
    }
    
    .quantity-note {
      color: #6c757d;
      font-size: 12px;
      font-style: italic;
    }
    
    /* Back button enhancement */
    .back-button-container {
      margin-bottom: 30px;
    }
    
    /* Claiming and completed sections */
    .claiming-section, .completed-section {
      margin-top: 20px;
      padding: 20px;
      border-radius: 8px;
    }
    
    .claiming-section {
      background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
    }
    
    .completed-section {
      background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
    }
    
    .claiming-section h4, .completed-section h4 {
      color: #152d64;
      margin: 0 0 15px 0;
      font-size: 16px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn-claim {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      border: 2px solid transparent;
    }
    
    .btn-claim:hover {
      background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
      color: white;
      text-decoration: none;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    /* Full-screen loading overlay */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(3px);
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-content {
      text-align: center;
      background: white;
      padding: 40px 50px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #152d64;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      color: #152d64;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .loading-subtext {
      color: #666;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">Processing Request...</div>
      <div class="loading-subtext">Please wait while we process your action</div>
    </div>
  </div>
  {% include 'app/navbar.html' %}

  <div class="batch-details">
    <div class="back-button-container">
      <a href="{% url 'user_supply_requests' %}" class="btn btn-back">
        <i class="fas fa-arrow-left"></i> Back to Requests
      </a>
    </div>
    
    <div class="batch-header">
      <h1>
        <i class="fas fa-file-alt"></i> 
        Supply Request {{ batch_request.id|stringformat:"03d" }}
      </h1>
      
      <div class="batch-info">
        <div class="info-item">
          <strong>Requester</strong>
          <span>
            {% if batch_request.user.first_name or batch_request.user.last_name %}
              {{ batch_request.user.first_name }} {{ batch_request.user.last_name }}
            {% else %}
              {{ batch_request.user.username }}
            {% endif %}
          </span>
        </div>
        
        <div class="info-item">
          <strong>Department</strong>
          <span>{{ batch_request.user.userprofile.department }}</span>
        </div>
        
        <div class="info-item">
          <strong>Request Date</strong>
          <span>{{ batch_request.request_date|date:"M d, Y H:i" }}</span>
        </div>
        
        <div class="info-item">
          <strong>Purpose</strong>
          <span>{{ batch_request.purpose }}</span>
        </div>
        
        {% if batch_request.claimed_by %}
        <div class="info-item">
          <strong>Released By</strong>
          <span>
            {% if batch_request.claimed_by.first_name or batch_request.claimed_by.last_name %}
              {{ batch_request.claimed_by.first_name }} {{ batch_request.claimed_by.last_name }}
            {% else %}
              {{ batch_request.claimed_by.username }}
            {% endif %}
          </span>
        </div>
        {% endif %}
        
        {% if batch_request.claimed_date %}
        <div class="info-item">
          <strong>Claimed Date</strong>
          <span>{{ batch_request.claimed_date|date:"M d, Y H:i" }}</span>
        </div>
        {% endif %}
      </div>
      
      <div class="batch-status status-{{ batch_request.status|lower }}">
        {% if batch_request.status == 'pending' %}
          <i class="fas fa-clock"></i>
        {% elif batch_request.status == 'approved' %}
          <i class="fas fa-check-circle"></i>
        {% elif batch_request.status == 'rejected' %}
          <i class="fas fa-times-circle"></i>
        {% elif batch_request.status == 'partially_approved' %}
          <i class="fas fa-exclamation-triangle"></i>
        {% elif batch_request.status == 'for_claiming' %}
          <i class="fas fa-hand-paper"></i>
        {% elif batch_request.status == 'completed' %}
          <i class="fas fa-check-circle"></i>
        {% endif %}
        {{ batch_request.get_status_display }}
      </div>
      
      {% if batch_request.status == 'for_claiming' %}
      <div style="margin-top: 20px;">
        <form method="post" action="{% url 'claim_batch_items' batch_request.id %}" style="display: inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-claim" onclick="return confirm('Are you sure you want to claim all approved items in this request? This will deduct stock quantities.');" style="font-size: 16px; padding: 12px 24px;">
            <i class="fas fa-shopping-cart"></i> Claim All Items
          </button>
        </form>
      </div>
      {% endif %}
      
      <!-- Requisition Slip Download Section -->
      {% if batch_request.status in 'approved,partially_approved,for_claiming,completed' %}
      <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 8px;">
        <h4 style="color: #152d64; margin: 0 0 15px 0; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
          <i class="fas fa-file-pdf"></i> Requisition & Issue Slip
        </h4>
        <p style="margin: 0 0 15px 0; font-size: 12px; color: #495057; line-height: 1.4;">
          Download or view the official requisition and issue slip for this approved supply request. This document serves as a receipt and record of the transaction.
        </p>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <a href="{% url 'download_requisition_slip' batch_request.id %}" 
             class="btn" 
             style="background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%); color: white; font-size: 12px; padding: 8px 16px; text-decoration: none;">
            <i class="fas fa-download"></i> Download PDF
          </a>
          <a href="{% url 'view_requisition_slip' batch_request.id %}" 
             target="_blank"
             class="btn" 
             style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; font-size: 12px; padding: 8px 16px; text-decoration: none;">
            <i class="fas fa-eye"></i> View PDF
          </a>
        </div>
      </div>
      {% endif %}
    </div>

    <h2 style="color: #152d64; font-size: 24px; font-weight: 600; margin: 30px 0 20px 0; padding-bottom: 10px; border-bottom: 3px solid #28a745; display: inline-block;">
      <i class="fas fa-list"></i> Request Items ({{ items.count }} item{{ items.count|pluralize }})
    </h2>
    
    <div class="items-container">
      <table class="items-table">
        <thead>
          <tr>
            <th style="width: 25%;"><i class="fas fa-box"></i> Item & Category</th>
            <th style="width: 10%;" class="quantity-cell"><i class="fas fa-hashtag"></i> Requested</th>
            <th style="width: 12%;" class="quantity-cell"><i class="fas fa-warehouse"></i> Stock</th>
            <th style="width: 12%;" class="quantity-cell"><i class="fas fa-edit"></i> Approve</th>
            <th style="width: 15%;" class="status-cell"><i class="fas fa-flag"></i> Status</th>
            <th style="width: 16%;" class="actions-cell"><i class="fas fa-cogs"></i> Actions</th>
            <th style="width: 10%;" class="actions-cell"><i class="fas fa-comment"></i> Notes</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
          <tr id="item-row-{{ item.id }}" data-item-status="{{ item.status }}">
            <td>
              <div class="item-name">
                <div>
                  <div style="font-weight: 600; color: #152d64; margin-bottom: 4px; font-size: 16px;">{{ item.supply.supply_name }}</div>
                  <span class="category-badge">{{ item.supply.category.name }}</span>
                </div>
              </div>
            </td>
            
            <td class="quantity-cell">
              <strong>{{ item.quantity }}</strong>
            </td>
            
            <td class="quantity-cell">
              <div class="stock-info">
                <span class="stock-available">{{ item.supply.quantity_info.current_quantity|default:"N/A" }}</span>
              </div>
            </td>
            
            <td class="quantity-cell">
              {% if item.status == 'pending' and batch_request.status in 'pending,partially_approved' %}
                <div class="approve-input-container">
                  <input type="number" 
                         id="approved-quantity-{{ item.id }}" 
                         min="1" 
                         max="{{ item.quantity }}" 
                         value="{{ item.quantity }}" 
                         class="approve-input"
                         data-max-quantity="{{ item.quantity }}">
                  <span class="qty-indicator">/ {{ item.quantity }}</span>
                </div>
              {% elif item.status == 'approved' or item.status == 'completed' %}
                <strong style="color: #28a745;">{{ item.approved_quantity|default:item.quantity }}</strong>
              {% else %}
                <span style="color: #6c757d;">—</span>
              {% endif %}
            </td>
            
            <td class="status-cell">
              {% if item.status == 'approved' %}
                <span class="status-badge status-approved">
                  <i class="fas fa-check"></i> Approved
                </span>
              {% elif item.status == 'rejected' %}
                <span class="status-badge status-rejected">
                  <i class="fas fa-times"></i> Rejected
                </span>
              {% elif item.status == 'completed' %}
                <span class="status-badge status-approved" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                  <i class="fas fa-check-circle"></i> Completed
                </span>
              {% else %}
                <span class="status-badge status-pending">
                  <i class="fas fa-clock"></i> Pending
                </span>
              {% endif %}
            </td>
            
            <td class="actions-cell">
              {% if item.status == 'pending' and batch_request.status in 'pending,partially_approved' %}
                <div class="action-buttons-inline">
                  <form method="post" action="{% url 'approve_batch_item' batch_request.id item.id %}" style="display: inline;" id="approve-form-{{ item.id }}">
                    {% csrf_token %}
                    <input type="hidden" name="approved_quantity" id="hidden-quantity-{{ item.id }}" value="{{ item.quantity }}">
                    <input type="hidden" name="remarks" id="hidden-remarks-{{ item.id }}" value="">
                    <button type="submit" class="btn-table btn-approve-table" data-item-id="{{ item.id }}">
                      <i class="fas fa-check"></i> Approve
                    </button>
                  </form>
                  
                  <form method="post" action="{% url 'reject_batch_item' batch_request.id item.id %}" style="display: inline;" id="reject-form-{{ item.id }}">
                    {% csrf_token %}
                    <input type="hidden" name="remarks" id="hidden-reject-remarks-{{ item.id }}" value="">
                    <button type="submit" class="btn-table btn-reject-table" data-item-id="{{ item.id }}">
                      <i class="fas fa-times"></i> Reject
                    </button>
                  </form>
                </div>
              {% elif item.status == 'approved' and batch_request.status == 'for_claiming' and not item.claimed_date %}
                <form method="post" action="{% url 'claim_individual_item' batch_request.id item.id %}" style="display: inline;">
                  {% csrf_token %}
                  <button type="submit" class="btn-table" style="background: #28a745; color: white;" onclick="return confirm('Claim this item?');">
                    <i class="fas fa-shopping-cart"></i> Claim
                  </button>
                </form>
              {% elif item.status == 'completed' %}
                <span style="color: #28a745; font-weight: 600; font-size: 11px;">
                  <i class="fas fa-check-circle"></i> CLAIMED
                </span>
              {% else %}
                <span style="color: #6c757d;">—</span>
              {% endif %}
            </td>
            
            <td class="actions-cell">
              {% if item.status == 'pending' and batch_request.status in 'pending,partially_approved' %}
                <button type="button" 
                        class="btn-table remarks-toggle-btn" 
                        style="background: #17a2b8; color: white;" 
                        data-item-id="{{ item.id }}"
                        title="Add remarks">
                  <i class="fas fa-comment"></i>
                </button>
              {% elif item.remarks %}
                <button type="button" 
                        class="btn-table remarks-toggle-btn" 
                        style="background: #17a2b8; color: white;" 
                        data-item-id="{{ item.id }}"
                        title="View remarks: {{ item.remarks|truncatechars:50 }}">
                  <i class="fas fa-comment-alt"></i>
                </button>
              {% else %}
                <span style="color: #6c757d;">—</span>
              {% endif %}
            </td>
          </tr>
          
          {% if item.status == 'pending' and batch_request.status in 'pending,partially_approved' or item.remarks %}
          <tr id="remarks-row-{{ item.id }}" class="remarks-row" style="display: none;">
            <td colspan="7">
              <div class="remarks-container">
                <div class="remarks-label">
                  {% if item.status == 'pending' %}
                    Remarks (Optional)
                  {% else %}
                    Remarks
                  {% endif %}
                </div>
                {% if item.status == 'pending' and batch_request.status in 'pending,partially_approved' %}
                  <textarea id="remarks-{{ item.id }}" 
                            class="remarks-input" 
                            placeholder="Add any comments or notes about this item approval/rejection...">{{ item.remarks|default:"" }}</textarea>
                {% else %}
                  <div style="padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; color: #495057;">
                    {{ item.remarks }}
                  </div>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <div style="margin-top: 30px; text-align: center;">
      <a href="{% url 'user_supply_requests' %}" class="btn btn-back">
        <i class="fas fa-arrow-left"></i> Back to Supply Requests
      </a>
    </div>
  </div>
  
  <script>
    // Loading overlay management
    function showLoading() {
      const overlay = document.getElementById('loadingOverlay');
      overlay.classList.add('active');
      
      // Safety fallback: hide loading after 15 seconds if still visible
      setTimeout(function() {
        if (overlay.classList.contains('active')) {
          overlay.classList.remove('active');
          alert('Request timeout. Please try again or contact administrator if the issue persists.');
        }
      }, 15000);
    }

    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      overlay.classList.remove('active');
    }

    // Toggle remarks functionality
    function toggleRemarks(itemId) {
      const remarksRow = document.getElementById(`remarks-row-${itemId}`);
      const isVisible = remarksRow.style.display !== 'none';
      remarksRow.style.display = isVisible ? 'none' : 'table-row';
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      // Count pending items to determine if this is the last one
      function countPendingItems() {
        const pendingRows = document.querySelectorAll('tr[data-item-status="pending"]');
        return pendingRows.length;
      }

      // Add event listeners for remarks toggle buttons
      const remarksToggleButtons = document.querySelectorAll('.remarks-toggle-btn');
      remarksToggleButtons.forEach(button => {
        button.addEventListener('click', function() {
          const itemId = this.getAttribute('data-item-id');
          toggleRemarks(itemId);
        });
      });
      
      // Add event listeners for quantity validation
      const quantityInputs = document.querySelectorAll('.approve-input');
      quantityInputs.forEach(input => {
        input.addEventListener('change', function() {
          const maxQuantity = parseInt(this.getAttribute('data-max-quantity'));
          const value = parseInt(this.value);
          if (value < 1) {
            this.value = 1;
          } else if (value > maxQuantity) {
            this.value = maxQuantity;
          }
        });
      });
      
      // Smart loading overlay: Only show on LAST pending item (triggers email)
      const actionForms = document.querySelectorAll('form[action*="approve"], form[action*="reject"]');
      actionForms.forEach(form => {
        form.addEventListener('submit', function(e) {
          // Check if this is the last pending item being processed
          const pendingCount = countPendingItems();
          
          console.log(`Form submitting - Pending items count: ${pendingCount}`);
          
          // Show loading ONLY if this is the last item (which triggers completion email)
          if (pendingCount === 1) {
            showLoading();
            console.log('✓ Last item - showing loading overlay (email will be sent)');
          } else {
            console.log(`✓ ${pendingCount} items remaining - no loading overlay, quick submit`);
          }
          
          // DO NOT prevent default - form MUST submit normally
          // The form will redirect naturally after processing
        });
      });
      
      // Add event listeners for approve buttons to transfer values
      const approveButtons = document.querySelectorAll('.btn-approve-table');
      approveButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          const itemId = this.getAttribute('data-item-id');
          const quantityInput = document.getElementById(`approved-quantity-${itemId}`);
          const remarksInput = document.getElementById(`remarks-${itemId}`);
          const hiddenQuantity = document.getElementById(`hidden-quantity-${itemId}`);
          const hiddenRemarks = document.getElementById(`hidden-remarks-${itemId}`);
          
          hiddenQuantity.value = quantityInput.value;
          hiddenRemarks.value = remarksInput ? remarksInput.value : '';
        });
      });
      
      // Add event listeners for reject buttons to transfer values
      const rejectButtons = document.querySelectorAll('.btn-reject-table');
      rejectButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          const itemId = this.getAttribute('data-item-id');
          const remarksInput = document.getElementById(`remarks-${itemId}`);
          const hiddenRemarks = document.getElementById(`hidden-reject-remarks-${itemId}`);
          
          hiddenRemarks.value = remarksInput ? remarksInput.value : '';
        });
      });
    });
  </script>
</body>
</html>
