{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Logs</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>
    {% block content %}
    {% include 'app/navbar.html' %}

    <div class="actlog-page">
        <h2 class="actlog-title">Activity Logs</h2>

        <div class="actlog-filter-section">
            <form method="get" class="actlog-filter-form">
                <div class="actlog-filter-group">
                    <label for="user">User:</label>
                    <div class="searchable-select-container">
                        <input type="text" id="user-search" class="activity-search-input" 
                               placeholder="Search users..." autocomplete="off">
                        <div class="activity-dropdown" id="user-dropdown">
                            <div class="activity-option" data-value="">All Users</div>
                            {% for user in users %}
                                <div class="activity-option" 
                                     data-value="{{ user.id }}"
                                     {% if request.GET.user|add:"0" == user.id %}data-selected="true"{% endif %}>
                                    {{ user.username }}
                                </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="user" id="user" value="{{ request.GET.user }}">
                    </div>
                </div>
                <div class="actlog-filter-group">
                    <label for="model">Model:</label>
                    <div class="searchable-select-container">
                        <input type="text" id="model-search" class="activity-search-input" 
                               placeholder="Search models..." autocomplete="off">
                        <div class="activity-dropdown" id="model-dropdown">
                            <div class="activity-option" data-value="">All Models</div>
                            {% for model in models %}
                                <div class="activity-option" 
                                     data-value="{{ model }}"
                                     {% if request.GET.model == model %}data-selected="true"{% endif %}>
                                    {{ model }}
                                </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="model" id="model" value="{{ request.GET.model }}">
                    </div>
                </div>
                <div class="actlog-filter-group">
                    <label for="start_date">Start Date:</label>
                    <input type="date" name="start_date" id="start_date" value="{{ request.GET.start_date }}">
                </div>
                <div class="actlog-filter-group">
                    <label for="end_date">End Date:</label>
                    <input type="date" name="end_date" id="end_date" value="{{ request.GET.end_date }}">
                </div>
                <div class="actlog-filter-buttons">
                    <button type="submit" class="actlog-filter-submit">Apply Filters</button>
                    <a href="{% url 'activity' %}" class="actlog-filter-reset">Reset</a>
                </div>
            </form>
        </div>

        <div class="actlog-table-container">
            <table class="actlog-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Description</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in activitylog_list %}
                    <tr>
                        <td>{{ page_obj.start_index|add:forloop.counter0 }}</td>
                        <td>{{ log.user.username }}</td>
                        <td>{{ log.get_action_display }}</td>
                        <td title="{{ log.description }}">
                            {% if log.description|length > 50 %}
                                {{ log.description|slice:':50' }}...
                            {% else %}
                                {{ log.description }}
                            {% endif %}
                        </td>
                        <td>{{ log.timestamp|date:"M d, Y - h:i A" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="actlog-empty">No activity logs available.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% if is_paginated %}
            <div class="actlog-pagination">
                {% if page_obj.has_previous %}
                    <a href="?page=1">&laquo; First</a>
                    <a href="?page={{ page_obj.previous_page_number }}">Previous</a>
                {% endif %}

                <span class="current">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                </span>

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}">Next</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}">Last &raquo;</a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endblock content %}

    <script>
    // Searchable activity dropdowns functionality
    document.addEventListener('DOMContentLoaded', function() {
        initSearchableDropdown('user');
        initSearchableDropdown('model');
        
        function initSearchableDropdown(type) {
            const searchInput = document.getElementById(type + '-search');
            const dropdown = document.getElementById(type + '-dropdown');
            const hiddenInput = document.getElementById(type);
            const options = dropdown.querySelectorAll('.activity-option');
            
            let isDropdownOpen = false;
            
            // Set initial display value
            const selectedOption = dropdown.querySelector('[data-selected="true"]');
            if (selectedOption) {
                searchInput.value = selectedOption.textContent.trim();
            } else {
                searchInput.value = type === 'user' ? 'All Users' : 'All Models';
            }
            
            // Toggle dropdown visibility
            function toggleDropdown() {
                isDropdownOpen = !isDropdownOpen;
                dropdown.style.display = isDropdownOpen ? 'block' : 'none';
                if (isDropdownOpen) {
                    searchInput.focus();
                    searchInput.select();
                }
            }
            
            // Filter options based on search
            function filterOptions() {
                const searchTerm = searchInput.value.toLowerCase();
                let hasVisibleOptions = false;
                
                // First restore all original options if they were replaced
                if (dropdown.querySelector('.no-results')) {
                    dropdown.innerHTML = '';
                    options.forEach(option => {
                        dropdown.appendChild(option.cloneNode(true));
                    });
                }
                
                // Get fresh options after potential restoration
                const currentOptions = dropdown.querySelectorAll('.activity-option');
                
                currentOptions.forEach(option => {
                    const text = option.textContent.toLowerCase();
                    const isVisible = text.includes(searchTerm);
                    option.style.display = isVisible ? 'block' : 'none';
                    if (isVisible) {
                        hasVisibleOptions = true;
                    }
                });
                
                // Show "no results" if no options are visible and there's a search term
                if (!hasVisibleOptions && searchTerm.trim() !== '') {
                    dropdown.innerHTML = '<div class="activity-option no-results">No ' + type + 's found</div>';
                }
            }
            
            // Select an option
            function selectOption(option) {
                const value = option.dataset.value;
                const text = option.textContent.trim();
                
                hiddenInput.value = value;
                searchInput.value = text;
                
                // Remove previous selection
                options.forEach(opt => opt.removeAttribute('data-selected'));
                option.setAttribute('data-selected', 'true');
                
                toggleDropdown();
                
                // Trigger form submission
                document.querySelector('.actlog-filter-form').submit();
            }
            
            // Event listeners
            searchInput.addEventListener('click', function() {
                if (!isDropdownOpen) {
                    toggleDropdown();
                }
            });
            
            searchInput.addEventListener('input', filterOptions);
            
            // Handle option clicks
            dropdown.addEventListener('click', function(e) {
                if (e.target.classList.contains('activity-option') && !e.target.classList.contains('no-results')) {
                    selectOption(e.target);
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    if (isDropdownOpen) {
                        toggleDropdown();
                    }
                }
            });
            
            // Keyboard navigation
            searchInput.addEventListener('keydown', function(e) {
                const visibleOptions = Array.from(options).filter(opt => opt.style.display !== 'none');
                
                if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (!isDropdownOpen) {
                        toggleDropdown();
                        return;
                    }
                    
                    const currentIndex = visibleOptions.findIndex(opt => opt.classList.contains('highlighted'));
                    let newIndex;
                    
                    if (e.key === 'ArrowDown') {
                        newIndex = currentIndex < visibleOptions.length - 1 ? currentIndex + 1 : 0;
                    } else {
                        newIndex = currentIndex > 0 ? currentIndex - 1 : visibleOptions.length - 1;
                    }
                    
                    visibleOptions.forEach(opt => opt.classList.remove('highlighted'));
                    if (visibleOptions[newIndex]) {
                        visibleOptions[newIndex].classList.add('highlighted');
                    }
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    const highlighted = dropdown.querySelector('.activity-option.highlighted');
                    if (highlighted && !highlighted.classList.contains('no-results')) {
                        selectOption(highlighted);
                    }
                } else if (e.key === 'Escape') {
                    if (isDropdownOpen) {
                        toggleDropdown();
                    }
                }
            });
        }
    });
    </script>

    <style>
    /* Searchable activity dropdown styles */
    .searchable-select-container {
        position: relative;
        width: 100%;
    }

    .activity-search-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        background-color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #333;
    }

    .activity-search-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
    }

    .activity-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .activity-option {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f1f1f1;
        transition: background-color 0.2s ease;
        font-size: 14px;
        color: #333;
    }

    .activity-option:hover,
    .activity-option.highlighted {
        background-color: #f8f9fa;
    }

    .activity-option[data-selected="true"] {
        background-color: #007bff;
        color: white;
    }

    .activity-option.no-results {
        color: #6c757d;
        font-style: italic;
        cursor: default;
    }

    .activity-option.no-results:hover {
        background-color: transparent;
    }

    /* Scrollbar styling for activity dropdown */
    .activity-dropdown::-webkit-scrollbar {
        width: 6px;
    }

    .activity-dropdown::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .activity-dropdown::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    .activity-dropdown::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    </style>
</body>
</html>