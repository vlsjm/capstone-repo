{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Borrow Requests</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    /* Main container styles matching system theme */
    .requests-container {
      padding: 20px;
      margin-left: 270px;
      background-color: #f5f6fa;
      min-height: 100vh;
    }
    
    .requests-title {
      color: #152d64;
      margin-bottom: 30px;
      font-size: 32px;
      font-weight: 600;
      text-align: center;
    }
    
    /* Search and filter section */
    .search-filter-section {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(21, 45, 100, 0.1);
    }
    
    .search-form {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .search-input, .filter-select, .date-input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .filter-btn, .clear-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .filter-btn {
      background: #152d64;
      color: white;
    }
    
    .filter-btn:hover {
      background: #0f1f45;
    }
    
    .clear-btn {
      background: #6c757d;
      color: white;
    }
    
    .clear-btn:hover {
      background: #5a6268;
      text-decoration: none;
      color: white;
    }
    
    /* Tab navigation */
    .tab-navigation {
      display: flex;
      background: white;
      border-radius: 12px 12px 0 0;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(21, 45, 100, 0.1);
      margin-bottom: 0;
    }
    
    .tab-button {
      flex: 1;
      padding: 15px 20px;
      border: none;
      background: #f8f9fa;
      color: #6c757d;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
    }
    
    .tab-button:hover {
      background: #e9ecef;
      color: #152d64;
    }
    
    .tab-button.active {
      background: white;
      color: #152d64;
      border-bottom-color: #152d64;
      font-weight: 600;
    }
    
    /* Tab content */
    .tab-content {
      display: none;
      background: white;
      padding: 30px;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 2px 8px rgba(21, 45, 100, 0.1);
      min-height: 400px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .tab-content h3 {
      color: #152d64;
      margin-bottom: 25px;
      font-size: 24px;
      font-weight: 600;
    }
    
    /* Request cards with system theme */
    .request {
      border: none;
      border-radius: 12px;
      margin: 20px 0;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      color: inherit;
      display: block;
      position: relative;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(21, 45, 100, 0.1);
    }
    
    .request:hover {
      background: white;
      border-color: transparent;
      box-shadow: 0 8px 25px rgba(21, 45, 100, 0.15);
      transform: translateY(-3px);
    }
    
    .request-header {
      background: #f8f9fa;
      padding: 20px;
      border-bottom: 1px solid #e9ecef;
      border-radius: 12px 12px 0 0;
      position: relative;
      user-select: none;
      transition: all 0.3s ease;
    }
    
    .request-header:hover {
      background: linear-gradient(135deg, #f8fbff 0%, #e8f4fd 100%);
    }
    
    .request-header h4 {
      margin: 0 0 15px 0;
      display: flex;
      align-items: center;
      font-size: 18px;
      font-weight: 600;
      color: #152d64;
    }
    
    .toggle-arrow {
      margin-right: 10px;
      transition: transform 0.3s ease;
      color: #152d64;
    }
    
    .toggle-arrow.rotated {
      transform: rotate(180deg);
    }
    
    .request-header p {
      margin: 5px 0;
      color: #6c757d;
      font-size: 14px;
    }
    
    .request-header strong {
      color: #152d64;
      font-weight: 600;
    }
    
    /* Status badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-partially_approved {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .status-for_claiming {
      background: #d4edda;
      color: #155724;
    }
    
    .status-active {
      background: #cce5ff;
      color: #004085;
    }
    
    .status-returned {
      background: #e2e3e5;
      color: #383d41;
    }
    
    .status-overdue {
      background: #f8d7da;
      color: #721c24;
    }
    
    .status-rejected {
      background: #f5c6cb;
      color: #721c24;
    }
    
    .status-expired {
      background: #ffe6e6;
      color: #c82333;
    }
    
    /* Resource allocation specific styles */
    .requester-info {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    
    .requester-info strong {
      font-weight: 600;
      color: #152d64;
    }
    
    .requester-info small {
      font-size: 12px;
      color: #6c757d;
    }
    
    /* Detail link and action buttons */
    .detail-link {
      color: #152d64;
      text-decoration: none;
      font-size: 12px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: color 0.2s ease;
    }
    
    .detail-link:hover {
      color: #0f1f45;
      text-decoration: none;
    }
    
    .claim-btn, .return-btn {
      padding: 6px 12px;
      border: 1px solid transparent;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s ease;
      text-decoration: none;
      text-align: center;
      white-space: nowrap;
      user-select: none;
      line-height: 1.4;
    }
    
    .claim-btn {
      background: #28a745;
      color: white;
      border-color: #28a745;
    }
    
    .claim-btn:hover {
      background: #218838;
      border-color: #218838;
      color: white;
      text-decoration: none;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
    }
    
    .return-btn {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }
    
    .return-btn:hover {
      background: #0056b3;
      border-color: #0056b3;
      color: white;
      text-decoration: none;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);
    }
    
    /* Standard button styles */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      white-space: nowrap;
      user-select: none;
      line-height: 1.4;
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
      gap: 4px;
    }
    
    .btn-primary {
      background: #152d64;
      color: white;
      border: 1px solid #152d64;
    }
    
    .btn-primary:hover {
      background: #0f1f45;
      border-color: #0f1f45;
      color: white;
      text-decoration: none;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(21, 45, 100, 0.2);
    }
    
    .btn-success {
      background: #28a745;
      color: white;
      border: 1px solid #28a745;
    }
    
    .btn-success:hover {
      background: #218838;
      border-color: #218838;
      color: white;
      text-decoration: none;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
    }
    
    .btn-warning {
      background: #ffc107;
      color: #212529;
      border: 1px solid #ffc107;
    }
    
    .btn-warning:hover {
      background: #e0a800;
      border-color: #d39e00;
      color: #212529;
      text-decoration: none;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(255, 193, 7, 0.2);
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
      border: 1px solid #dc3545;
    }
    
    .btn-danger:hover {
      background: #c82333;
      border-color: #bd2130;
      color: white;
      text-decoration: none;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
    }
    
    .btn i {
      font-size: 12px;
    }
    
    .btn-sm i {
      font-size: 10px;
    }
    
    /* Action column styling */
    .requests-table td:last-child {
      text-align: center;
      white-space: nowrap;
    }
    
    .requests-table td:last-child > div {
      display: flex;
      gap: 5px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .requests-table td:last-child > a {
      margin: 0;
    }
    
    /* Request items */
    .request-items {
      padding: 20px;
      background: #f8f9fa;
      border-top: 1px solid #e9ecef;
    }
    
    .request-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: white;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .request-item:last-child {
      margin-bottom: 0;
    }
    
    .item-info {
      flex: 1;
    }
    
    .item-info strong {
      color: #152d64;
      font-weight: 600;
    }
    
    .item-info small {
      color: #6c757d;
      font-size: 12px;
    }
    
    .item-status {
      margin-left: 15px;
    }
    
    /* No requests message */
    .no-requests {
      text-align: center;
      padding: 60px 20px;
      color: #6c757d;
    }
    
    .no-requests i {
      font-size: 48px;
      margin-bottom: 20px;
      color: #dee2e6;
    }
    
    .no-requests p {
      font-size: 16px;
      margin: 0;
    }
    
    /* Pagination */
    .pagination-container {
      margin-top: 30px;
      text-align: center;
    }
    
    .pagination {
      display: inline-flex;
      list-style: none;
      padding: 0;
      margin: 0;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .page-item {
      margin: 0;
    }
    
    .page-link {
      display: block;
      padding: 10px 15px;
      background: white;
      color: #152d64;
      text-decoration: none;
      border: 1px solid #dee2e6;
      border-right: none;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .page-item:last-child .page-link {
      border-right: 1px solid #dee2e6;
    }
    
    .page-link:hover {
      background: #e9ecef;
      color: #152d64;
      text-decoration: none;
    }
    
    .page-item.active .page-link {
      background: #152d64;
      color: white;
      border-color: #152d64;
    }
    
    /* Count Badge Styles */
    .count-badge {
      background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 8px;
      display: inline-block;
      line-height: 1.2;
      min-width: 20px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(255, 107, 53, 0.3);
      animation: subtle-pulse 2s ease-in-out infinite;
    }
    
    .tab-button.active .count-badge {
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      color: #152d64;
      box-shadow: 0 1px 3px rgba(255, 215, 0, 0.4);
    }
    
    @keyframes subtle-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    /* Table Styles - Matching Supply Requests Design */
    .requests-table {
      width: 100%;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(21, 45, 100, 0.1);
      margin: 20px 0;
    }
    
    .requests-table table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .requests-table th {
      background: #152d64;
      color: white;
      padding: 16px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #0d1f4a;
    }
    
    .requests-table th:first-child {
      padding-left: 20px;
    }
    
    .requests-table th:last-child {
      padding-right: 20px;
      text-align: center;
    }
    
    .requests-table td {
      padding: 16px 12px;
      border-bottom: 1px solid #e9ecef;
      vertical-align: middle;
    }
    
    .requests-table td:first-child {
      padding-left: 20px;
    }
    
    .requests-table td:last-child {
      padding-right: 20px;
      text-align: center;
    }
    
    .requests-table tr {
      transition: background-color 0.2s ease;
    }
    
    .requests-table tbody tr:hover {
      background-color: #f8f9fa;
    }
    
    .requests-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    /* Expandable row styles */
    .expandable-row td:not(:last-child) {
      cursor: pointer; /* Only make non-action columns clickable for expansion */
    }
    
    .expandable-row td:last-child {
      cursor: default; /* Actions column should not trigger expansion */
    }
    
    .expand-icon {
      margin-right: 8px;
      transition: transform 0.3s ease;
      color: #152d64;
      font-size: 12px;
    }
    
    .expand-icon.expanded {
      transform: rotate(90deg);
    }
    
    /* Add visual feedback for expandable areas */
    .expandable-row td:not(:last-child):hover .expand-icon {
      color: #0d1f4a;
    }
    
    .expandable-row td:first-child {
      position: relative;
    }
    
    .expandable-row td:first-child::after {
      content: "Click to expand details";
      position: absolute;
      bottom: -20px;
      left: 0;
      font-size: 10px;
      color: #6c757d;
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
      white-space: nowrap;
    }
    
    .expandable-row:hover td:first-child::after {
      opacity: 1;
    }
    
    .details-row {
      display: none;
    }
    
    .details-row.show {
      display: table-row;
    }
    
    .details-row td {
      background-color: #f8f9fa;
      padding: 20px;
      border-bottom: 2px solid #e9ecef;
    }
    
    .details-content {
      margin-bottom: 20px;
    }
    
    .details-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .detail-label {
      font-weight: 600;
      color: #152d64;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .detail-value {
      color: #495057;
      font-size: 14px;
    }
    
    .details-section h5 {
      color: #152d64;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .details-section p {
      margin: 5px 0;
      font-size: 14px;
      color: #495057;
    }
    
    .details-section strong {
      color: #152d64;
      font-weight: 600;
    }
    
    .items-list {
      margin-top: 15px;
    }
    
    .items-section {
      width: 100%;
      margin-top: 20px;
    }
    
    .items-section h4 {
      margin-bottom: 15px;
      color: #152d64;
      font-weight: 600;
    }
    
    .items-table {
      width: 100%;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      overflow: hidden;
      border-collapse: collapse;
      table-layout: auto;
    }
    
    .items-table th {
      background: #152d64;
      color: white;
      padding: 12px 15px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      text-align: left;
      border-bottom: 2px solid #0d1f4a;
    }
    
    .items-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #e9ecef;
      vertical-align: middle;
      color: #495057;
    }
    
    .items-table tr:last-child td {
      border-bottom: none;
    }
    
    .items-table tbody tr:hover {
      background-color: #f8f9fa;
    }
    
    /* Text utility classes */
    .text-muted {
      color: #6c757d !important;
    }
    
    /* Manage Users Pagination Styles */
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      margin-top: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(21, 45, 100, 0.1);
      padding: 15px 20px;
    }
    
    .pagination-info {
      color: #6c757d;
      font-size: 14px;
    }
    
    .pagination-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .pagination-btn {
      background: #152d64;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      text-decoration: none;
      font-size: 12px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .pagination-btn:hover {
      background: #0f1f45;
      color: white;
      text-decoration: none;
    }
    
    .pagination-current {
      color: #152d64;
      font-weight: 600;
      font-size: 14px;
      margin: 0 10px;
    }
    
    /* Responsive Table */
    .table-responsive {
      overflow-x: auto;
      margin-bottom: 20px;
    }
    
    @media (max-width: 768px) {
      .request-table thead th {
        padding: 10px 8px;
        font-size: 11px;
      }
      
      .request-table tbody td {
        padding: 8px;
        font-size: 13px;
      }
      
      .details-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .pagination-container {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  {% include 'app/navbar.html' %}
  <div class="requests-container">
    <!-- Page Title -->
    <h1 class="requests-title">Borrow Requests</h1>
    
    <!-- Custom Alert Modal -->
    <div id="customAlertModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
      <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3); animation: slideDown 0.3s ease;">
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
          <i id="alertIcon" class="fas" style="font-size: 32px;"></i>
          <h3 id="alertTitle" style="margin: 0; color: #152d64; font-size: 20px;"></h3>
        </div>
        <p id="alertMessage" style="color: #495057; font-size: 16px; line-height: 1.6; margin-bottom: 25px;"></p>
        <div style="text-align: right;">
          <button onclick="closeCustomAlert()" style="background: #152d64; color: white; border: none; padding: 10px 24px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
            <i class="fas fa-check"></i> OK
          </button>
        </div>
      </div>
    </div>
    
    <style>
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
    
    <!-- Search and Filter Section -->
    <div class="search-filter-section">
      <form method="get" class="search-form">
        <input type="text" name="search" placeholder="Search by borrower name or property..." value="{{ search_query }}" class="search-input">
        <select name="department" class="filter-select">
          <option value="">All Departments</option>
          {% for department in departments %}
            <option value="{{ department.name }}" {% if department_filter == department.name %}selected{% endif %}>{{ department.name }}</option>
          {% endfor %}
        </select>
        <input type="date" name="date_from" placeholder="From Date" value="{{ date_from }}" class="date-input">
        <input type="date" name="date_to" placeholder="To Date" value="{{ date_to }}" class="date-input">
        <button type="submit" class="filter-btn">
          <i class="fas fa-filter"></i> Filter
        </button>
        <a href="{% url 'user_borrow_requests' %}" class="clear-btn">
          <i class="fas fa-times"></i> Clear
        </a>
      </form>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button class="tab-button {% if current_tab == 'pending' %}active{% endif %}" data-tab="pending">
        <i class="fas fa-clock"></i> Pending
      </button>
      <button class="tab-button {% if current_tab == 'for_claiming' %}active{% endif %}" data-tab="for_claiming">
        <i class="fas fa-hand-paper"></i> For Claiming
      </button>
      {% if perms.app.view_admin_module %}
      <button class="tab-button {% if current_tab == 'resource_allocation' %}active{% endif %}" data-tab="resource_allocation">
        <i class="fas fa-box-open"></i> Resource Allocation
      </button>
      {% endif %}
      <button class="tab-button {% if current_tab == 'active' %}active{% endif %}" data-tab="active">
        <i class="fas fa-play-circle"></i> Active
      </button>
      <button class="tab-button {% if current_tab == 'returned' %}active{% endif %}" data-tab="returned">
        <i class="fas fa-check-circle"></i> Returned
      </button>
      <button class="tab-button {% if current_tab == 'overdue' %}active{% endif %}" data-tab="overdue">
        <i class="fas fa-exclamation-circle"></i> Overdue
      </button>
      <button class="tab-button {% if current_tab == 'rejected' %}active{% endif %}" data-tab="rejected">
        <i class="fas fa-times-circle"></i> Rejected
      </button>
      <button class="tab-button {% if current_tab == 'expired' %}active{% endif %}" data-tab="expired">
        <i class="fas fa-calendar-times"></i> Expired
      </button>
    </div>

    <!-- Request Container -->

    <!-- Pending Requests Tab -->
    <div id="pending" class="tab-content {% if current_tab == 'pending' %}active{% endif %}">
      <div class="requests-table">
        <table>
          <thead>
            <tr>
              <th>Request ID</th>
              <th>Requester</th>
              <th>Purpose</th>
              <th>Total Items</th>
              <th>Status</th>
              <th>Request Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for batch_request in pending_requests %}
            <tr class="expandable-row" data-request-id="{{ batch_request.id }}">
              <td>
                <i class="fas fa-chevron-right expand-icon" id="icon-{{ batch_request.id }}"></i>
                BRW-{{ batch_request.id|stringformat:"03d" }}
              </td>
              <td>
                <strong>
                  {% if batch_request.user.first_name or batch_request.user.last_name %}
                    {{ batch_request.user.first_name }} {{ batch_request.user.last_name }}
                  {% else %}
                    {{ batch_request.user.username }}
                  {% endif %}
                </strong>
                <br>
                <small class="text-muted">{{ batch_request.user.userprofile.department }}</small>
              </td>
              <td>{{ batch_request.purpose|truncatechars:50 }}</td>
              <td>{{ batch_request.total_items }}</td>
              <td>
                <span class="status-badge status-pending">
                  <i class="fas fa-clock"></i> {{ batch_request.get_status_display }}
                </span>
              </td>
              <td>{{ batch_request.request_date|date:"M d, Y" }}</td>
              <td>
                <a href="{% url 'borrow_batch_request_detail' batch_request.id %}" class="detail-link">
                  <i class="fas fa-external-link-alt"></i> View
                </a>
              </td>
            </tr>
            <tr class="details-row" id="details-{{ batch_request.id }}">
              <td colspan="7">
                <div class="details-content">
                  <div class="details-grid">
                    <div class="detail-item">
                      <span class="detail-label">Request Date:</span>
                      <span class="detail-value">{{ batch_request.request_date|date:"M d, Y H:i" }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">Department:</span>
                      <span class="detail-value">{{ batch_request.user.userprofile.department }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">Full Purpose:</span>
                      <span class="detail-value">{{ batch_request.purpose }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">Total Items:</span>
                      <span class="detail-value">{{ batch_request.total_items }}</span>
                    </div>
                  </div>
                  <div class="items-section">
                    <h4>Requested Items</h4>
                    <table class="items-table">
                    <thead>
                      <tr>
                        <th>ITEM NAME</th>
                        <th>QUANTITY</th>
                        <th>RETURN DATE</th>
                        <th>STATUS</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in batch_request.items.all %}
                      <tr>
                        <td>{{ item.property.property_name }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>{{ item.return_date|date:"M d, Y" }}</td>
                        <td>
                          <span class="status-badge status-{{ item.status|lower }}">
                            {{ item.get_status_display }}
                          </span>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                  </div>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" style="text-align: center; padding: 40px 20px; color: #6c757d; font-style: italic;">
                No pending requests found.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      <!-- Pagination for Pending -->
      {% if pending_requests.has_other_pages %}
      <div class="pagination-container">
        <div class="pagination-info">
          Showing {{ pending_requests.start_index }}-{{ pending_requests.end_index }} of {{ pending_requests.paginator.count }} pending requests
        </div>
        <div class="pagination-controls">
          {% if pending_requests.has_previous %}
            <a href="?tab=pending&pending_page={{ pending_requests.previous_page_number }}{{ url_params }}" class="pagination-btn" title="Previous">
              <i class="fas fa-chevron-left"></i>
            </a>
          {% endif %}
          
          <span class="pagination-current">
            Page {{ pending_requests.number }} of {{ pending_requests.paginator.num_pages }}
          </span>
          
          {% if pending_requests.has_next %}
            <a href="?tab=pending&pending_page={{ pending_requests.next_page_number }}{{ url_params }}" class="pagination-btn" title="Next">
              <i class="fas fa-chevron-right"></i>
            </a>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- For Claiming Requests Tab -->
    <div id="for_claiming" class="tab-content {% if current_tab == 'for_claiming' %}active{% endif %}">
      <h3>Ready for Claiming</h3>
      {% if for_claiming_requests %}
        <div class="table-container">
          <table class="requests-table">
            <thead>
              <tr>
                <th>Request ID</th>
                <th>Requester</th>
                <th>Purpose</th>
                <th>Total Items</th>
                <th>Status</th>
                <th>Approved Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for batch_request in for_claiming_requests %}
              <tr class="expandable-row" data-request-id="{{ batch_request.id }}">
                <td>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-chevron-right expand-icon" id="icon-{{ batch_request.id }}"></i>
                    <span class="request-id">{{ batch_request.id|stringformat:"03d" }}</span>
                  </div>
                </td>
                <td>
                  <div class="requester-info">
                    <strong>
                      {% if batch_request.user.first_name or batch_request.user.last_name %}
                        {{ batch_request.user.first_name }} {{ batch_request.user.last_name }}
                      {% else %}
                        {{ batch_request.user.username }}
                      {% endif %}
                    </strong>
                    <small>{{ batch_request.user.userprofile.department }}</small>
                  </div>
                </td>
                <td>{{ batch_request.purpose|truncatechars:50 }}</td>
                <td>{{ batch_request.total_items }}</td>
                <td>
                  <span class="status-badge status-{{ batch_request.status|lower }}">
                    <i class="fas fa-hand-paper"></i>
                    {{ batch_request.get_status_display }}
                  </span>
                </td>
                <td>
                  {% if batch_request.approved_date %}
                    {{ batch_request.approved_date|date:"M d, Y H:i" }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>
                  <div style="display: flex; gap: 5px; align-items: center;">
                    <a href="{% url 'borrow_batch_request_detail' batch_request.id %}" class="btn btn-sm btn-primary">
                      <i class="fas fa-eye"></i> View Details
                    </a>
                    {% if perms.app.view_admin_module %}
                    <form method="post" action="{% url 'claim_borrow_batch_items' batch_request.id %}" class="ajax-action-form" data-confirm="Are you sure you want to claim all approved items in this request?" style="display: inline;">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm claim-btn">
                        <i class="fas fa-check"></i> Claim Items
                      </button>
                    </form>
                    {% endif %}
                  </div>
                </td>
              </tr>
              <tr class="details-row" id="details-{{ batch_request.id }}">
                <td colspan="7">
                  <div class="details-content">
                    <div class="details-grid">
                      <div class="detail-item">
                        <span class="detail-label">Request Date:</span>
                        <span class="detail-value">{{ batch_request.request_date|date:"M d, Y H:i" }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Department:</span>
                        <span class="detail-value">{{ batch_request.user.userprofile.department }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Full Purpose:</span>
                        <span class="detail-value">{{ batch_request.purpose }}</span>
                      </div>
                      {% if batch_request.approved_date %}
                      <div class="detail-item">
                        <span class="detail-label">Approved Date:</span>
                        <span class="detail-value">{{ batch_request.approved_date|date:"M d, Y H:i" }}</span>
                      </div>
                      {% endif %}
                    </div>
                    <div class="items-section">
                      <h4>Requested Items</h4>
                      <table class="items-table">
                        <thead>
                          <tr>
                            <th>ITEM NAME</th>
                            <th>QUANTITY</th>
                            <th>RETURN DATE</th>
                            <th>APPROVED QTY</th>
                            <th>STATUS</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for item in batch_request.items.all %}
                          <tr>
                            <td>{{ item.property.property_name }}</td>
                            <td>{{ item.quantity }}</td>
                            <td>{{ item.return_date|date:"M d, Y" }}</td>
                            <td>
                              {% if item.approved_quantity and item.status == 'approved' %}
                                {{ item.approved_quantity }}
                              {% else %}
                                —
                              {% endif %}
                            </td>
                            <td>
                              <span class="status-badge status-{{ item.status|lower }}">
                                {{ item.get_status_display }}
                              </span>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="no-requests">
          <i class="fas fa-inbox"></i>
          <p>No requests ready for claiming found.</p>
        </div>
      {% endif %}

      <!-- Pagination for For Claiming -->
      {% if for_claiming_requests.has_other_pages %}
      <div class="pagination-container">
        <div class="pagination-info">
          Showing {{ for_claiming_requests.start_index }}-{{ for_claiming_requests.end_index }} of {{ for_claiming_requests.paginator.count }} for claiming requests
        </div>
        <div class="pagination-controls">
          {% if for_claiming_requests.has_previous %}
            <a href="?tab=for_claiming&for_claiming_page={{ for_claiming_requests.previous_page_number }}{{ url_params }}" class="pagination-btn" title="Previous">
              <i class="fas fa-chevron-left"></i>
            </a>
          {% endif %}
          
          <span class="pagination-current">
            Page {{ for_claiming_requests.number }} of {{ for_claiming_requests.paginator.num_pages }}
          </span>
          
          {% if for_claiming_requests.has_next %}
            <a href="?tab=for_claiming&for_claiming_page={{ for_claiming_requests.next_page_number }}{{ url_params }}" class="pagination-btn" title="Next">
              <i class="fas fa-chevron-right"></i>
            </a>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Resource Allocation Tab -->
    {% if perms.app.view_admin_module %}
    <div id="resource_allocation" class="tab-content {% if current_tab == 'resource_allocation' %}active{% endif %}">
      <h3>Resource Allocation Overview</h3>
      <p style="color: #6c757d; font-size: 14px; margin-bottom: 20px;">
        <i class="fas fa-info-circle"></i> This tab shows all items currently allocated/reserved to users through approved borrow requests or reservations.
      </p>
      
      {% if resource_allocations %}
        <div class="table-container">
          <table class="requests-table">
            <thead>
              <tr>
                <th>Type</th>
                <th>Request ID</th>
                <th>Allocated To</th>
                <th>Item Name</th>
                <th>Quantity</th>
                <th>Status</th>
                <th>Request Date</th>
                <th>Return/Needed Date</th>
                <th>Purpose</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for allocation in resource_allocations %}
              <tr>
                <td>
                  <span class="status-badge {% if allocation.type_class == 'borrow' %}status-active{% else %}status-pending{% endif %}">
                    {% if allocation.type_class == 'borrow' %}
                      <i class="fas fa-hand-holding"></i>
                    {% else %}
                      <i class="fas fa-calendar-check"></i>
                    {% endif %}
                    {{ allocation.type }}
                  </span>
                </td>
                <td>
                  {% if allocation.type_class == 'borrow' %}
                    BRW-{{ allocation.request_id|stringformat:"03d" }}
                  {% else %}
                    RSV-{{ allocation.request_id|stringformat:"03d" }}
                  {% endif %}
                </td>
                <td>
                  <div class="requester-info">
                    <strong>
                      {% if allocation.user.first_name or allocation.user.last_name %}
                        {{ allocation.user.first_name }} {{ allocation.user.last_name }}
                      {% else %}
                        {{ allocation.user.username }}
                      {% endif %}
                    </strong>
                    <small>{{ allocation.user.userprofile.department }}</small>
                  </div>
                </td>
                <td>
                  <strong>{{ allocation.property.property_name }}</strong>
                  {% if allocation.property.property_number %}
                    <br><small class="text-muted">{{ allocation.property.property_number }}</small>
                  {% endif %}
                </td>
                <td><strong>{{ allocation.quantity }}</strong></td>
                <td>
                  <span class="status-badge status-{{ allocation.status_value|lower }}">
                    {% if allocation.status_value == 'approved' %}
                      <i class="fas fa-check-circle"></i>
                    {% elif allocation.status_value == 'active' %}
                      <i class="fas fa-play-circle"></i>
                    {% endif %}
                    {{ allocation.status }}
                  </span>
                </td>
                <td>{{ allocation.request_date|date:"M d, Y" }}</td>
                <td>
                  {% if allocation.type_class == 'reservation' and allocation.needed_date %}
                    <strong>Needed:</strong> {{ allocation.needed_date|date:"M d, Y" }}<br>
                  {% endif %}
                  <strong>Return:</strong> {{ allocation.return_date|date:"M d, Y" }}
                </td>
                <td>{{ allocation.purpose|truncatechars:40 }}</td>
                <td>
                  <a href="{% url allocation.detail_url allocation.request_id %}" class="btn btn-sm btn-primary">
                    <i class="fas fa-eye"></i> View
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="no-requests">
          <i class="fas fa-inbox"></i>
          <p>No resource allocations found.</p>
        </div>
      {% endif %}

      <!-- Pagination for Resource Allocation -->
      {% if resource_allocations.has_other_pages %}
      <div class="pagination-container">
        <div class="pagination-info">
          Showing {{ resource_allocations.start_index }}-{{ resource_allocations.end_index }} of {{ resource_allocations.paginator.count }} allocations
        </div>
        <div class="pagination-controls">
          {% if resource_allocations.has_previous %}
            <a href="?tab=resource_allocation&allocations_page={{ resource_allocations.previous_page_number }}{{ url_params }}" class="pagination-btn" title="Previous">
              <i class="fas fa-chevron-left"></i>
            </a>
          {% endif %}
          
          <span class="pagination-current">
            Page {{ resource_allocations.number }} of {{ resource_allocations.paginator.num_pages }}
          </span>
          
          {% if resource_allocations.has_next %}
            <a href="?tab=resource_allocation&allocations_page={{ resource_allocations.next_page_number }}{{ url_params }}" class="pagination-btn" title="Next">
              <i class="fas fa-chevron-right"></i>
            </a>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Active Requests Tab -->
    <div id="active" class="tab-content {% if current_tab == 'active' %}active{% endif %}">
      <h3>Active Borrow Requests</h3>
      {% if active_requests %}
        <div class="table-container">
          <table class="requests-table">
            <thead>
              <tr>
                <th>Request ID</th>
                <th>Requester</th>
                <th>Purpose</th>
                <th>Total Items</th>
                <th>Status</th>
                <th>Expected Return</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for batch_request in active_requests %}
              <tr class="expandable-row" data-request-id="{{ batch_request.id }}">
                <td>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-chevron-right expand-icon" id="icon-{{ batch_request.id }}"></i>
                    <span class="request-id">{{ batch_request.id|stringformat:"03d" }}</span>
                  </div>
                </td>
                <td>
                  <div class="requester-info">
                    <strong>
                      {% if batch_request.user.first_name or batch_request.user.last_name %}
                        {{ batch_request.user.first_name }} {{ batch_request.user.last_name }}
                      {% else %}
                        {{ batch_request.user.username }}
                      {% endif %}
                    </strong>
                    <small>{{ batch_request.user.userprofile.department }}</small>
                  </div>
                </td>
                <td>{{ batch_request.purpose|truncatechars:50 }}</td>
                <td>{{ batch_request.total_items }}</td>
                <td>
                  <span class="status-badge status-{{ batch_request.status|lower }}">
                    <i class="fas fa-play-circle"></i>
                    {{ batch_request.get_status_display }}
                  </span>
                </td>
                <td>
                  {% if batch_request.latest_return_date %}
                    {{ batch_request.latest_return_date|date:"M d, Y" }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>
                  <div style="display: flex; gap: 5px; align-items: center;">
                    <a href="{% url 'borrow_batch_request_detail' batch_request.id %}" class="btn btn-sm btn-primary">
                      <i class="fas fa-eye"></i> View Details
                    </a>
                    {% if perms.app.view_admin_module %}
                    <form method="post" action="{% url 'return_borrow_batch_items' batch_request.id %}" class="ajax-action-form" data-confirm="Are you sure you want to mark all items as returned?" style="display: inline;">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm return-btn">
                        <i class="fas fa-undo"></i> Return Items
                      </button>
                    </form>
                    {% endif %}
                  </div>
                </td>
              </tr>
              <tr class="details-row" id="details-{{ batch_request.id }}">
                <td colspan="7">
                  <div class="details-content">
                    <div class="details-grid">
                      <div class="detail-item">
                        <span class="detail-label">Request Date:</span>
                        <span class="detail-value">{{ batch_request.request_date|date:"M d, Y H:i" }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Department:</span>
                        <span class="detail-value">{{ batch_request.user.userprofile.department }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Full Purpose:</span>
                        <span class="detail-value">{{ batch_request.purpose }}</span>
                      </div>
                      {% if batch_request.claimed_date %}
                      <div class="detail-item">
                        <span class="detail-label">Claimed Date:</span>
                        <span class="detail-value">{{ batch_request.claimed_date|date:"M d, Y H:i" }}</span>
                      </div>
                      {% endif %}
                    </div>
                    <div class="items-section">
                      <h4>Requested Items</h4>
                      <table class="items-table">
                        <thead>
                          <tr>
                            <th>ITEM NAME</th>
                            <th>QUANTITY</th>
                            <th>RETURN DATE</th>
                            <th>STATUS</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for item in batch_request.items.all %}
                          <tr>
                            <td>{{ item.property.property_name }}</td>
                            <td>{{ item.approved_quantity|default:item.quantity }}</td>
                            <td>{{ item.return_date|date:"M d, Y" }}</td>
                            <td>
                              <span class="status-badge status-{{ item.status|lower }}">
                                {{ item.get_status_display }}
                              </span>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="no-requests">
          <i class="fas fa-inbox"></i>
          <p>No active borrow requests found.</p>
        </div>
      {% endif %}

      <!-- Pagination for Active -->
      {% if active_requests.has_other_pages %}
      <div class="pagination-container">
        <div class="pagination-info">
          Showing {{ active_requests.start_index }}-{{ active_requests.end_index }} of {{ active_requests.paginator.count }} active requests
        </div>
        <div class="pagination-controls">
          {% if active_requests.has_previous %}
            <a href="?tab=active&active_page={{ active_requests.previous_page_number }}{{ url_params }}" class="pagination-btn" title="Previous">
              <i class="fas fa-chevron-left"></i>
            </a>
          {% endif %}
          
          <span class="pagination-current">
            Page {{ active_requests.number }} of {{ active_requests.paginator.num_pages }}
          </span>
          
          {% if active_requests.has_next %}
            <a href="?tab=active&active_page={{ active_requests.next_page_number }}{{ url_params }}" class="pagination-btn" title="Next">
              <i class="fas fa-chevron-right"></i>
            </a>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Returned Requests Tab -->
    <div id="returned" class="tab-content {% if current_tab == 'returned' %}active{% endif %}">
      <h3>Returned Borrow Requests</h3>
      {% if returned_requests %}
        <div class="table-container">
          <table class="requests-table">
            <thead>
              <tr>
                <th>Request ID</th>
                <th>Requester</th>
                <th>Purpose</th>
                <th>Total Items</th>
                <th>Status</th>
                <th>Returned Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for batch_request in returned_requests %}
              <tr class="expandable-row" data-request-id="{{ batch_request.id }}">
                <td>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-chevron-right expand-icon" id="icon-{{ batch_request.id }}"></i>
                    <span class="request-id">{{ batch_request.id|stringformat:"03d" }}</span>
                  </div>
                </td>
                <td>
                  <div class="requester-info">
                    <strong>
                      {% if batch_request.user.first_name or batch_request.user.last_name %}
                        {{ batch_request.user.first_name }} {{ batch_request.user.last_name }}
                      {% else %}
                        {{ batch_request.user.username }}
                      {% endif %}
                    </strong>
                    <small>{{ batch_request.user.userprofile.department }}</small>
                  </div>
                </td>
                <td>{{ batch_request.purpose|truncatechars:50 }}</td>
                <td>{{ batch_request.total_items }}</td>
                <td>
                  <span class="status-badge status-{{ batch_request.status|lower }}">
                    <i class="fas fa-check-circle"></i>
                    {{ batch_request.get_status_display }}
                  </span>
                </td>
                <td>
                  {% if batch_request.returned_date %}
                    {{ batch_request.returned_date|date:"M d, Y H:i" }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>
                  <a href="{% url 'borrow_batch_request_detail' batch_request.id %}" class="btn btn-sm btn-primary">
                    <i class="fas fa-eye"></i> View Details
                  </a>
                </td>
              </tr>
              <tr class="details-row" id="details-{{ batch_request.id }}">
                <td colspan="7">
                  <div class="details-content">
                    <div class="details-grid">
                      <div class="detail-item">
                        <span class="detail-label">Request Date:</span>
                        <span class="detail-value">{{ batch_request.request_date|date:"M d, Y H:i" }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Department:</span>
                        <span class="detail-value">{{ batch_request.user.userprofile.department }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Full Purpose:</span>
                        <span class="detail-value">{{ batch_request.purpose }}</span>
                      </div>
                      {% if batch_request.returned_date %}
                      <div class="detail-item">
                        <span class="detail-label">Returned Date:</span>
                        <span class="detail-value">{{ batch_request.returned_date|date:"M d, Y H:i" }}</span>
                      </div>
                      {% endif %}
                    </div>
                    <div class="items-section">
                      <h4>Requested Items</h4>
                      <table class="items-table">
                        <thead>
                          <tr>
                            <th>ITEM NAME</th>
                            <th>QUANTITY</th>
                            <th>RETURN DATE</th>
                            <th>ACTUAL RETURN</th>
                            <th>STATUS</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for item in batch_request.items.all %}
                          <tr>
                            <td>{{ item.property.property_name }}</td>
                            <td>{{ item.approved_quantity|default:item.quantity }}</td>
                            <td>{{ item.return_date|date:"M d, Y" }}</td>
                            <td>
                              {% if item.actual_return_date %}
                                {{ item.actual_return_date|date:"M d, Y" }}
                              {% else %}
                                —
                              {% endif %}
                            </td>
                            <td>
                              <span class="status-badge status-{{ item.status|lower }}">
                                {{ item.get_status_display }}
                              </span>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="no-requests">
          <i class="fas fa-inbox"></i>
          <p>No returned borrow requests found.</p>
        </div>
      {% endif %}

      <!-- Pagination for Returned -->
      {% if returned_requests.has_other_pages %}
      <div class="pagination-container">
        <div class="pagination-info">
          Showing {{ returned_requests.start_index }}-{{ returned_requests.end_index }} of {{ returned_requests.paginator.count }} returned requests
        </div>
        <div class="pagination-controls">
          {% if returned_requests.has_previous %}
            <a href="?tab=returned&returned_page={{ returned_requests.previous_page_number }}{{ url_params }}" class="pagination-btn" title="Previous">
              <i class="fas fa-chevron-left"></i>
            </a>
          {% endif %}
          
          <span class="pagination-current">
            Page {{ returned_requests.number }} of {{ returned_requests.paginator.num_pages }}
          </span>
          
          {% if returned_requests.has_next %}
            <a href="?tab=returned&returned_page={{ returned_requests.next_page_number }}{{ url_params }}" class="pagination-btn" title="Next">
              <i class="fas fa-chevron-right"></i>
            </a>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Overdue Requests Tab -->
    <div id="overdue" class="tab-content {% if current_tab == 'overdue' %}active{% endif %}">
      <h3>Overdue Borrow Requests</h3>
      {% if overdue_requests %}
        <div class="table-container">
          <table class="requests-table">
            <thead>
              <tr>
                <th>Request ID</th>
                <th>Requester</th>
                <th>Purpose</th>
                <th>Total Items</th>
                <th>Status</th>
                <th>Expected Return</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for batch_request in overdue_requests %}
              <tr class="expandable-row" data-request-id="{{ batch_request.id }}">
                <td>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-chevron-right expand-icon" id="icon-{{ batch_request.id }}"></i>
                    <span class="request-id">{{ batch_request.id|stringformat:"03d" }}</span>
                  </div>
                </td>
                <td>
                  <div class="requester-info">
                    <strong>
                      {% if batch_request.user.first_name or batch_request.user.last_name %}
                        {{ batch_request.user.first_name }} {{ batch_request.user.last_name }}
                      {% else %}
                        {{ batch_request.user.username }}
                      {% endif %}
                    </strong>
                    <small>{{ batch_request.user.userprofile.department }}</small>
                  </div>
                </td>
                <td>{{ batch_request.purpose|truncatechars:50 }}</td>
                <td>{{ batch_request.total_items }}</td>
                <td>
                  <span class="status-badge status-{{ batch_request.status|lower }}">
                    <i class="fas fa-exclamation-circle"></i>
                    {{ batch_request.get_status_display }}
                  </span>
                </td>
                <td>
                  <div style="color: #dc3545; font-weight: 600;">
                    {{ batch_request.latest_return_date|date:"M d, Y" }}
                    <small style="display: block; font-size: 11px;">(OVERDUE)</small>
                  </div>
                </td>
                <td>
                  <div style="display: flex; gap: 5px; align-items: center;">
                    <a href="{% url 'borrow_batch_request_detail' batch_request.id %}" class="btn btn-sm btn-primary">
                      <i class="fas fa-eye"></i> View Details
                    </a>
                    {% if perms.app.view_admin_module %}
                    <form method="post" action="{% url 'return_borrow_batch_items' batch_request.id %}" class="ajax-action-form" data-confirm="Are you sure you want to mark all items as returned?" style="display: inline;">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm return-btn">
                        <i class="fas fa-undo"></i> Return Items
                      </button>
                    </form>
                    {% endif %}
                  </div>
                </td>
              </tr>
              <tr class="details-row" id="details-{{ batch_request.id }}">
                <td colspan="7">
                  <div class="details-content">
                    <div class="details-grid">
                      <div class="detail-item">
                        <span class="detail-label">Request Date:</span>
                        <span class="detail-value">{{ batch_request.request_date|date:"M d, Y H:i" }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Department:</span>
                        <span class="detail-value">{{ batch_request.user.userprofile.department }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Full Purpose:</span>
                        <span class="detail-value">{{ batch_request.purpose }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Expected Return Date:</span>
                        <span class="detail-value" style="color: #dc3545; font-weight: 600;">
                          {{ batch_request.latest_return_date|date:"M d, Y" }} (OVERDUE)
                        </span>
                      </div>
                    </div>
                    <div class="items-section">
                      <h4>Requested Items</h4>
                      <table class="items-table">
                        <thead>
                          <tr>
                            <th>ITEM NAME</th>
                            <th>QUANTITY</th>
                            <th>RETURN DATE</th>
                            <th>STATUS</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for item in batch_request.items.all %}
                          <tr>
                            <td>{{ item.property.property_name }}</td>
                            <td>{{ item.approved_quantity|default:item.quantity }}</td>
                            <td>{{ item.return_date|date:"M d, Y" }}</td>
                            <td>
                              <span class="status-badge status-{{ item.status|lower }}">
                                {{ item.get_status_display }}
                              </span>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="no-requests">
          <i class="fas fa-inbox"></i>
          <p>No overdue borrow requests found.</p>
        </div>
      {% endif %}

      <!-- Pagination for Overdue -->
      {% if overdue_requests.has_other_pages %}
      <div class="pagination-container">
        <div class="pagination-info">
          Showing {{ overdue_requests.start_index }}-{{ overdue_requests.end_index }} of {{ overdue_requests.paginator.count }} overdue requests
        </div>
        <div class="pagination-controls">
          {% if overdue_requests.has_previous %}
            <a href="?tab=overdue&overdue_page={{ overdue_requests.previous_page_number }}{{ url_params }}" class="pagination-btn" title="Previous">
              <i class="fas fa-chevron-left"></i>
            </a>
          {% endif %}
          
          <span class="pagination-current">
            Page {{ overdue_requests.number }} of {{ overdue_requests.paginator.num_pages }}
          </span>
          
          {% if overdue_requests.has_next %}
            <a href="?tab=overdue&overdue_page={{ overdue_requests.next_page_number }}{{ url_params }}" class="pagination-btn" title="Next">
              <i class="fas fa-chevron-right"></i>
            </a>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Rejected Requests Tab -->
    <div id="rejected" class="tab-content {% if current_tab == 'rejected' %}active{% endif %}">
      <h3>Rejected Borrow Requests</h3>
      {% if rejected_requests %}
        <div class="table-container">
          <table class="requests-table">
            <thead>
              <tr>
                <th>Request ID</th>
                <th>Requester</th>
                <th>Purpose</th>
                <th>Total Items</th>
                <th>Status</th>
                <th>Request Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for batch_request in rejected_requests %}
              <tr class="expandable-row" data-request-id="{{ batch_request.id }}">
                <td>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-chevron-right expand-icon" id="icon-{{ batch_request.id }}"></i>
                    <span class="request-id">{{ batch_request.id|stringformat:"03d" }}</span>
                  </div>
                </td>
                <td>
                  <div class="requester-info">
                    <strong>
                      {% if batch_request.user.first_name or batch_request.user.last_name %}
                        {{ batch_request.user.first_name }} {{ batch_request.user.last_name }}
                      {% else %}
                        {{ batch_request.user.username }}
                      {% endif %}
                    </strong>
                    <small>{{ batch_request.user.userprofile.department }}</small>
                  </div>
                </td>
                <td>{{ batch_request.purpose|truncatechars:50 }}</td>
                <td>{{ batch_request.total_items }}</td>
                <td>
                  <span class="status-badge status-{{ batch_request.status|lower }}">
                    <i class="fas fa-times-circle"></i>
                    {{ batch_request.get_status_display }}
                  </span>
                </td>
                <td>{{ batch_request.request_date|date:"M d, Y H:i" }}</td>
                <td>
                  <a href="{% url 'borrow_batch_request_detail' batch_request.id %}" class="btn btn-sm btn-primary">
                    <i class="fas fa-eye"></i> View Details
                  </a>
                </td>
              </tr>
              <tr class="details-row" id="details-{{ batch_request.id }}">
                <td colspan="7">
                  <div class="details-content">
                    <div class="details-grid">
                      <div class="detail-item">
                        <span class="detail-label">Request Date:</span>
                        <span class="detail-value">{{ batch_request.request_date|date:"M d, Y H:i" }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Department:</span>
                        <span class="detail-value">{{ batch_request.user.userprofile.department }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Full Purpose:</span>
                        <span class="detail-value">{{ batch_request.purpose }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Total Items:</span>
                        <span class="detail-value">{{ batch_request.total_items }}</span>
                      </div>
                    </div>
                    <div class="items-section">
                      <h4>Requested Items</h4>
                      <table class="items-table">
                        <thead>
                          <tr>
                            <th>ITEM NAME</th>
                            <th>QUANTITY</th>
                            <th>RETURN DATE</th>
                            <th>STATUS</th>
                            {% if batch_request.items.first.remarks %}<th>REMARKS</th>{% endif %}
                          </tr>
                        </thead>
                        <tbody>
                          {% for item in batch_request.items.all %}
                          <tr>
                            <td>{{ item.property.property_name }}</td>
                            <td>{{ item.quantity }}</td>
                            <td>{{ item.return_date|date:"M d, Y" }}</td>
                            <td>
                              <span class="status-badge status-{{ item.status|lower }}">
                                {{ item.get_status_display }}
                              </span>
                            </td>
                            {% if batch_request.items.first.remarks %}<td>{{ item.remarks|default:"—" }}</td>{% endif %}
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="no-requests">
          <i class="fas fa-inbox"></i>
          <p>No rejected borrow requests found.</p>
        </div>
      {% endif %}

      <!-- Pagination for Rejected -->
      {% if rejected_requests.has_other_pages %}
      <div class="pagination-container">
        <div class="pagination-info">
          Showing {{ rejected_requests.start_index }}-{{ rejected_requests.end_index }} of {{ rejected_requests.paginator.count }} rejected requests
        </div>
        <div class="pagination-controls">
          {% if rejected_requests.has_previous %}
            <a href="?tab=rejected&rejected_page={{ rejected_requests.previous_page_number }}{{ url_params }}" class="pagination-btn" title="Previous">
              <i class="fas fa-chevron-left"></i>
            </a>
          {% endif %}
          
          <span class="pagination-current">
            Page {{ rejected_requests.number }} of {{ rejected_requests.paginator.num_pages }}
          </span>
          
          {% if rejected_requests.has_next %}
            <a href="?tab=rejected&rejected_page={{ rejected_requests.next_page_number }}{{ url_params }}" class="pagination-btn" title="Next">
              <i class="fas fa-chevron-right"></i>
            </a>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Expired Requests Tab -->
    <div id="expired" class="tab-content {% if current_tab == 'expired' %}active{% endif %}">
      <h3>Expired Borrow Requests</h3>
      {% if expired_requests %}
        <div class="table-container">
          <table class="requests-table">
            <thead>
              <tr>
                <th>Request ID</th>
                <th>Requester</th>
                <th>Purpose</th>
                <th>Total Items</th>
                <th>Status</th>
                <th>Return Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for batch_request in expired_requests %}
              <tr class="expandable-row" data-request-id="{{ batch_request.id }}">
                <td>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-chevron-right expand-icon" id="icon-{{ batch_request.id }}"></i>
                    <span class="request-id">{{ batch_request.id|stringformat:"03d" }}</span>
                  </div>
                </td>
                <td>
                  <div class="requester-info">
                    <strong>
                      {% if batch_request.user.first_name or batch_request.user.last_name %}
                        {{ batch_request.user.first_name }} {{ batch_request.user.last_name }}
                      {% else %}
                        {{ batch_request.user.username }}
                      {% endif %}
                    </strong>
                    <small>{{ batch_request.user.userprofile.department }}</small>
                  </div>
                </td>
                <td>{{ batch_request.purpose|truncatechars:50 }}</td>
                <td>{{ batch_request.total_items }}</td>
                <td>
                  <span class="status-badge status-{{ batch_request.status|lower }}">
                    <i class="fas fa-calendar-times"></i>
                    {{ batch_request.get_status_display }}
                  </span>
                </td>
                <td>
                  <div style="color: #dc3545; font-weight: 600;">
                    {% if batch_request.latest_return_date %}
                      {{ batch_request.latest_return_date|date:"M d, Y" }}
                    {% else %}
                      —
                    {% endif %}
                    <small style="display: block; font-size: 11px;">(EXPIRED)</small>
                  </div>
                </td>
                <td>
                  <div style="display: flex; gap: 5px; align-items: center;">
                    <a href="{% url 'borrow_batch_request_detail' batch_request.id %}" class="btn btn-sm btn-primary">
                      <i class="fas fa-eye"></i> View Details
                    </a>
                  </div>
                </td>
              </tr>
              <tr class="details-row" id="details-{{ batch_request.id }}">
                <td colspan="7">
                  <div class="details-content">
                    <div class="details-grid">
                      <div class="detail-item">
                        <span class="detail-label">Request Date:</span>
                        <span class="detail-value">{{ batch_request.request_date|date:"M d, Y H:i" }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Department:</span>
                        <span class="detail-value">{{ batch_request.user.userprofile.department }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Full Purpose:</span>
                        <span class="detail-value">{{ batch_request.purpose }}</span>
                      </div>
                      <div class="detail-item">
                        <span class="detail-label">Expected Return Date:</span>
                        <span class="detail-value" style="color: #dc3545; font-weight: 600;">
                          {% if batch_request.latest_return_date %}
                            {{ batch_request.latest_return_date|date:"M d, Y" }}
                          {% else %}
                            —
                          {% endif %}
                        </span>
                      </div>
                    </div>
                    <div class="items-section">
                      <h4>Requested Items</h4>
                      <table class="items-table">
                        <thead>
                          <tr>
                            <th>ITEM NAME</th>
                            <th>QUANTITY</th>
                            <th>RETURN DATE</th>
                            <th>STATUS</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for item in batch_request.items.all %}
                          <tr>
                            <td>{{ item.property.property_name }}</td>
                            <td>{{ item.quantity }}</td>
                            <td>{{ item.return_date|date:"M d, Y" }}</td>
                            <td>
                              <span class="status-badge status-{{ item.status|lower }}">
                                {{ item.get_status_display }}
                              </span>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="no-requests">
          <i class="fas fa-inbox"></i>
          <p>No expired borrow requests found.</p>
        </div>
      {% endif %}

      <!-- Pagination for Expired -->
      {% if expired_requests.has_other_pages %}
      <div class="pagination-container">
        <div class="pagination-info">
          Showing {{ expired_requests.start_index }}-{{ expired_requests.end_index }} of {{ expired_requests.paginator.count }} expired requests
        </div>
        <div class="pagination-controls">
          {% if expired_requests.has_previous %}
            <a href="?tab=expired&expired_page={{ expired_requests.previous_page_number }}{{ url_params }}" class="pagination-btn" title="Previous">
              <i class="fas fa-chevron-left"></i>
            </a>
          {% endif %}
          
          <span class="pagination-current">
            Page {{ expired_requests.number }} of {{ expired_requests.paginator.num_pages }}
          </span>
          
          {% if expired_requests.has_next %}
            <a href="?tab=expired&expired_page={{ expired_requests.next_page_number }}{{ url_params }}" class="pagination-btn" title="Next">
              <i class="fas fa-chevron-right"></i>
            </a>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>

<script>
// Custom Alert Modal Functions
function showCustomAlert(title, message, type = 'info') {
  const modal = document.getElementById('customAlertModal');
  const icon = document.getElementById('alertIcon');
  const titleEl = document.getElementById('alertTitle');
  const messageEl = document.getElementById('alertMessage');
  
  // Set content
  titleEl.textContent = title;
  messageEl.textContent = message;
  
  // Set icon and color based on type
  icon.className = 'fas ';
  if (type === 'success') {
    icon.className += 'fa-check-circle';
    icon.style.color = '#28a745';
  } else if (type === 'error') {
    icon.className += 'fa-exclamation-circle';
    icon.style.color = '#dc3545';
  } else if (type === 'warning') {
    icon.className += 'fa-exclamation-triangle';
    icon.style.color = '#ffc107';
  } else {
    icon.className += 'fa-info-circle';
    icon.style.color = '#17a2b8';
  }
  
  // Show modal
  modal.style.display = 'flex';
}

function closeCustomAlert() {
  const modal = document.getElementById('customAlertModal');
  modal.style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
  // Close modal on outside click
  document.getElementById('customAlertModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeCustomAlert();
    }
  });
  
  // Tab navigation
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');

  tabButtons.forEach(button => {
    button.addEventListener('click', function() {
      const targetTab = this.getAttribute('data-tab');
      
      // Remove active class from all buttons and contents
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      
      // Add active class to clicked button and corresponding content
      this.classList.add('active');
      document.getElementById(targetTab).classList.add('active');
      
      // Update URL parameter
      const url = new URL(window.location);
      url.searchParams.set('tab', targetTab);
      window.history.pushState({}, '', url);
    });
  });

  // Table row expansion (matching supply requests behavior with accordion)
  document.addEventListener('click', function(e) {
    // Only trigger expansion if not clicking on action buttons/links
    if (!e.target.closest('a, button, .detail-link')) {
      const expandableRow = e.target.closest('.expandable-row');
      if (expandableRow) {
        const requestId = expandableRow.getAttribute('data-request-id');
        const expandIcon = document.getElementById('icon-' + requestId);
        const detailsRow = document.getElementById('details-' + requestId);
        
        if (expandIcon && detailsRow) {
          const isCurrentlyExpanded = detailsRow.classList.contains('show');
          
          // Collapse all other rows first (accordion behavior)
          document.querySelectorAll('.details-row.show').forEach(function(row) {
            row.classList.remove('show');
          });
          document.querySelectorAll('.expand-icon.expanded').forEach(function(icon) {
            icon.classList.remove('expanded');
          });
          
          if (!isCurrentlyExpanded) {
            // Show this row's details
            detailsRow.classList.add('show');
            expandIcon.classList.add('expanded');
          }
        }
      }
    }
  });

  // AJAX handler for claim/return forms
  document.addEventListener('submit', function(e) {
    const form = e.target;
    
    // Only handle forms with class 'ajax-action-form'
    if (!form.classList.contains('ajax-action-form')) {
      return;
    }
    
    e.preventDefault();
    
    const actionUrl = form.action;
    const formData = new FormData(form);
    const confirmMsg = form.getAttribute('data-confirm');
    
    // Show confirmation dialog
    if (confirmMsg && !confirm(confirmMsg)) {
      return;
    }
    
    // Get CSRF token
    const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Disable submit button to prevent double submission
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    
    // Send AJAX request
    fetch(actionUrl, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': csrfToken
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Show success modal
        showCustomAlert('Success', data.message, 'success');
        // Reload page after user closes modal
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      } else {
        // Show error modal
        showCustomAlert('Error', data.message, 'error');
        // Re-enable button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showCustomAlert('Error', 'An error occurred while processing your request. Please try again.', 'error');
      // Re-enable button
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalBtnText;
    });
  });
});
</script>
</body>
</html>
