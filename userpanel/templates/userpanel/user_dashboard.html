{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Dashboard</title>
    <link rel="stylesheet" href="{% static 'css/userStyle.css' %}?v=2024110701" />
    <link rel="stylesheet" href="{% static 'css/mobile.css' %}?v=2024110701" />
    <link rel="stylesheet" href="{% static 'css/mobile-cards.css' %}?v=2024110701" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    

  </head>
  <body>
    <!-- Mobile Header -->
    <header class="mobile-header">
      <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle navigation menu">
        <i class="fas fa-bars"></i>
      </button>
      
      <!-- Greeting in Mobile Header -->
      <div class="mobile-header-greeting">
        Hello, <span>{{ request.user.username }}</span>
      </div>
      
      <!-- Notification Bell in Mobile Header -->
      <div
        class="notification-container mobile-notification"
        id="notificationBell"
        aria-label="Notifications"
        tabindex="0"
        role="button"
      >
        <div class="bell-wrapper">
          <i class="far fa-bell bell-icon" title="Notifications"></i>
          {% if unread_count > 0 %}
          <span class="notification-count" id="notificationCount">{{ unread_count }}</span>
          {% endif %}
        </div>

        <div
          class="notifications-dropdown"
          id="notificationsDropdown"
          role="list"
          aria-live="polite"
          aria-relevant="additions"
        >
          <div class="notification-header">
            <h4 class="notification-title">
              <i class="fas fa-bell"></i>
              Notifications
            </h4>
            <div class="notification-actions">
              <button type="button" class="actions-toggle" id="actionsToggle" aria-label="Notification actions">
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <div class="actions-dropdown" id="actionsDropdown">
                <button id="markAllReadBtn" type="button" class="action-btn mark-read-btn">
                  <i class="fas fa-check"></i>
                  Mark all read
                </button>
                <button id="clearAllBtn" type="button" class="action-btn clear-btn">
                  <i class="fas fa-trash"></i>
                  Clear all
                </button>
              </div>
            </div>
          </div>

          <div id="notificationsContainer" class="notifications-body">
            {% if notifications %} {% for notification in notifications %}
            <div
              class="notification-item {% if not notification.is_read %}unread{% endif %} clickable-notification"
              tabindex="0"
              data-id="{{ notification.id }}"
              data-message="{{ notification.message|escape }}"
            >
              <div class="notification-content">
                <div class="notification-message">{{ notification.message }}</div>
                <div class="notification-details">
                  {% if notification.remarks %}
                  <div class="notification-remarks">
                    <strong>Remarks:</strong> <span>{{ notification.remarks }}</span>
                  </div>
                  {% endif %}
                  <div class="notification-timestamp">
                    {{ notification.timestamp|date:"M d, Y H:i" }}
                  </div>
                </div>
              </div>
              {% if not notification.is_read %}
              <div class="unread-indicator"></div>
              {% endif %}
            </div>
            {% endfor %} {% else %}
            <div
              class="notification-item no-notifications"
              id="noNotificationsMsg"
            >
              <div class="empty-state">
                <i class="fas fa-bell-slash"></i>
                <p>No notifications</p>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </header>

    <!-- Desktop Top Header -->
    <div class="top-header">
      <div class="header-greeting">
        Hello, <span>{{ request.user.username }}</span>
      </div>
      
      <!-- Notification Bell for Desktop -->
      <div
        class="notification-container"
        id="notificationBellDesktop"
        aria-label="Notifications"
        tabindex="0"
        role="button"
      >
        <div class="bell-wrapper">
          <i class="far fa-bell bell-icon" title="Notifications"></i>
          {% if unread_count > 0 %}
          <span class="notification-count" id="notificationCountDesktop">{{ unread_count }}</span>
          {% endif %}
        </div>

        <div
          class="notifications-dropdown"
          id="notificationsDropdownDesktop"
          role="list"
          aria-live="polite"
          aria-relevant="additions"
        >
          <div class="notification-header">
            <h4 class="notification-title">
              <i class="far fa-bell"></i>
              Notifications
            </h4>
            <div class="notification-actions">
              <button type="button" class="actions-toggle desktop-actions-toggle" aria-label="Notification actions">
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <div class="actions-dropdown desktop-actions-dropdown">
                <button type="button" class="action-btn mark-read-btn desktop-mark-all">
                  <i class="fas fa-check"></i>
                  Mark all read
                </button>
                <button type="button" class="action-btn clear-btn desktop-clear-all">
                  <i class="fas fa-trash"></i>
                  Clear all
                </button>
              </div>
            </div>
          </div>

          <div class="notifications-body desktop-notifications-body">
            {% if notifications %} {% for notification in notifications %}
            <div
              class="notification-item {% if not notification.is_read %}unread{% endif %} clickable-notification"
              tabindex="0"
              data-id="{{ notification.id }}"
              data-message="{{ notification.message|escape }}"
            >
              <div class="notification-content">
                <div class="notification-message">{{ notification.message }}</div>
                <div class="notification-details">
                  {% if notification.remarks %}
                  <div class="notification-remarks">
                    <strong>Remarks:</strong> <span>{{ notification.remarks }}</span>
                  </div>
                  {% endif %}
                  <div class="notification-timestamp">
                    {{ notification.timestamp|date:"M d, Y H:i" }}
                  </div>
                </div>
              </div>
              {% if not notification.is_read %}
              <div class="unread-indicator"></div>
              {% endif %}
            </div>
            {% endfor %} {% else %}
            <div class="notification-item no-notifications">
              <div class="empty-state">
                <i class="fas fa-bell-slash"></i>
                <p>No notifications</p>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Logout Button for Desktop -->
      <div class="logout-container">
        <div class="logout-wrapper" onclick="handleLogout()" title="Logout">
          <i class="fas fa-sign-out-alt logout-icon"></i>
        </div>
      </div>
    </div>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay"></div>
    
    <!-- Logout Form (Hidden) -->
    <form
      id="logout-form"
      action="{% url 'logout' %}"
      method="post"
      class="hidden"
    >
      {% csrf_token %}
    </form>

    {% block content %} 

    {% include 'userpanel/user_navbar.html' %}

    <div class="parent">

      <!-- Quick Stats Cards -->
      <div class="dashboard-stats">
        <!-- Pending Card -->
        <div class="stat-card stat-card-pending mobile-stat-card-layout">
          <div class="card-header mobile-card-top-row">
            <span class="card-title mobile-card-label">Pending</span>
            <div class="card-menu-wrapper mobile-card-action">
              <button class="card-menu" id="pendingMenuBtn">⋮</button>
              <div class="card-menu-dropdown" id="pendingMenuDropdown">
                <button class="menu-item" data-type="all" selected>All Pending</button>
                <button class="menu-item" data-type="supply">Supply Requests</button>
                <button class="menu-item" data-type="borrow">Borrow Requests</button>
                <button class="menu-item" data-type="reservation">Reservations</button>
              </div>
            </div>
          </div>
          <div class="card-body mobile-card-bottom-row">
            <div class="card-main mobile-card-content-grid">
              <div class="card-amount mobile-card-count" id="pendingCount">{{ pending_count }}</div>
              <div class="card-icon-badge mobile-card-icon">
                <i class="fas fa-clock"></i>
              </div>
            </div>
            <div class="card-subtitle">
              Awaiting Approval
            </div>
          </div>
        </div>

        <!-- Approved Card -->
        <div class="stat-card stat-card-approved mobile-stat-card-layout">
          <div class="card-header mobile-card-top-row">
            <span class="card-title mobile-card-label">Approved</span>
            <div class="card-menu-wrapper mobile-card-action">
              <button class="card-menu" id="approvedMenuBtn">⋮</button>
              <div class="card-menu-dropdown" id="approvedMenuDropdown">
                <button class="menu-item" data-type="all" selected>All Approved</button>
                <button class="menu-item" data-type="supply">Supply Requests</button>
                <button class="menu-item" data-type="borrow">Borrow Requests</button>
                <button class="menu-item" data-type="reservation">Reservations</button>
              </div>
            </div>
          </div>
          <div class="card-body mobile-card-bottom-row">
            <div class="card-main mobile-card-content-grid">
              <div class="card-amount mobile-card-count" id="approvedCount">{{ approved_count }}</div>
              <div class="card-icon-badge mobile-card-icon">
                <i class="fas fa-check-circle"></i>
              </div>
            </div>
            <div class="card-subtitle">
              <span class="approval-rate">{{ approval_rate }}% Approval Rate</span>
            </div>
          </div>
        </div>

        <!-- Overdue Card -->
        <div class="stat-card stat-card-overdue mobile-stat-card-layout">
          <div class="card-header mobile-card-top-row">
            <span class="card-title mobile-card-label">Overdue</span>
            <button class="card-menu mobile-card-action" style="visibility: hidden; pointer-events: none;">⋮</button>
          </div>
          <div class="card-body mobile-card-bottom-row">
            <div class="card-main mobile-card-content-grid">
              <div class="card-amount mobile-card-count">{{ overdue_count }}</div>
              <div class="card-icon-badge mobile-card-icon">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
            </div>
            <div class="card-subtitle">
              <span class="overdue-text">Needs Attention</span>
            </div>
          </div>
        </div>

        <!-- Active Card -->
        <div class="stat-card stat-card-active mobile-stat-card-layout">
          <div class="card-header mobile-card-top-row">
            <span class="card-title mobile-card-label">Active</span>
            <div class="card-menu-wrapper mobile-card-action">
              <button class="card-menu" id="activeMenuBtn">⋮</button>
              <div class="card-menu-dropdown" id="activeMenuDropdown">
                <button class="menu-item" data-type="all" selected>All Active</button>
                <button class="menu-item" data-type="borrow">Borrow Requests</button>
                <button class="menu-item" data-type="reservation">Reservations</button>
              </div>
            </div>
          </div>
          <div class="card-body mobile-card-bottom-row">
            <div class="card-main mobile-card-content-grid">
              <div class="card-amount mobile-card-count" id="activeCount">{{ active_count }}</div>
              <div class="card-icon-badge mobile-card-icon">
                <i class="fas fa-play-circle"></i>
              </div>
            </div>
            <div class="card-subtitle">
              Currently In Use
            </div>
          </div>
        </div>
      </div>

      <!-- Request Status Distribution Horizontal Bar Chart (Modern) -->
      <div class="chart-section">
        <div class="chart-container chart-full-width">
          <h3 style="margin-bottom: 25px; display: flex; align-items: center; gap: 10px; font-weight: 600; color: #1f1f1f;">
            <i class="fas fa-tasks" style="color: #2196F3; font-size: 18px;"></i>
            Request Status Overview
          </h3>
          <div class="chart-wrapper status-chart-wrapper">
            <canvas id="statusBarChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Items for Action Section -->
      <div class="action-items-section">
        <!-- Items for Claiming -->
        {% if items_for_claiming %}
        <div class="action-items-container">
          <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-weight: 600; color: #1f1f1f;">
            <i class="fas fa-clipboard-check" style="color: #FF6B6B; font-size: 18px;"></i>
            Ready for Claiming ({{ items_for_claiming|length }})
          </h3>
          <div class="action-items-list">
            {% for item in items_for_claiming_page %}
            <div class="action-item-card claiming-card">
              <div class="action-item-icon">
                <i class="fas {{ item.icon }}" style="color: #FF6B6B;"></i>
              </div>
              <div class="action-item-content">
                <div class="action-item-title">{{ item.item_name }}</div>
                <div class="action-item-meta">
                  <span class="action-item-type">{{ item.type }}</span>
                  <span class="action-item-qty">Qty: {{ item.quantity }}</span>
                </div>
              </div>
              <div class="action-item-action">
                {% if item.type == 'Supply Request' %}
                  <a href="{% url 'request_detail' 'batch_supply' item.id %}" class="action-btn-small" title="View details">
                    <i class="fas fa-arrow-right"></i>
                  </a>
                {% elif item.type == 'Borrow Request' %}
                  <a href="{% url 'request_detail' 'batch_borrow' item.id %}" class="action-btn-small" title="View details">
                    <i class="fas fa-arrow-right"></i>
                  </a>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
          
          <!-- Mobile-Friendly Pagination -->
          {% if items_for_claiming_page.has_other_pages %}
          <div class="action-items-pagination">
            {% if items_for_claiming_page.has_previous %}
            <a href="?claiming_page={{ items_for_claiming_page.previous_page_number }}" class="pagination-btn">
              <i class="fas fa-chevron-left"></i>
              <span class="pagination-text">Previous</span>
            </a>
            {% else %}
            <span class="pagination-btn disabled">
              <i class="fas fa-chevron-left"></i>
              <span class="pagination-text">Previous</span>
            </span>
            {% endif %}
            
            <span class="pagination-info">
              Page <span class="current-page">{{ items_for_claiming_page.number }}</span> of <span class="total-pages">{{ items_for_claiming_page.paginator.num_pages }}</span>
            </span>
            
            {% if items_for_claiming_page.has_next %}
            <a href="?claiming_page={{ items_for_claiming_page.next_page_number }}" class="pagination-btn">
              <span class="pagination-text">Next</span>
              <i class="fas fa-chevron-right"></i>
            </a>
            {% else %}
            <span class="pagination-btn disabled">
              <span class="pagination-text">Next</span>
              <i class="fas fa-chevron-right"></i>
            </span>
            {% endif %}
          </div>
          {% endif %}
        </div>
        {% endif %}

        <!-- Active Reservations -->
        {% if active_reservations %}
        <div class="action-items-container">
          <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-weight: 600; color: #1f1f1f;">
            <i class="fas fa-calendar-check" style="color: #51CF66; font-size: 18px;"></i>
            Active Reservations ({{ active_reservations|length }})
          </h3>
          <div class="action-items-list">
            {% for item in active_reservations_page %}
            <div class="action-item-card reservation-card">
              <div class="action-item-icon">
                <i class="fas {{ item.icon }}" style="color: #51CF66;"></i>
              </div>
              <div class="action-item-content">
                <div class="action-item-title">{{ item.item_name }}</div>
                <div class="action-item-meta">
                  <span class="action-item-type">{{ item.type }}</span>
                  <span class="action-item-qty">Qty: {{ item.quantity }}</span>
                </div>
                <div class="action-item-dates">
                  <small>Return: {{ item.return_date|date:"M d, Y" }} ({{ item.days_remaining }} days left)</small>
                </div>
              </div>
              <div class="action-item-action">
                <a href="{% url 'request_detail' 'reservation' item.id %}" class="action-btn-small" title="View details">
                  <i class="fas fa-arrow-right"></i>
                </a>
              </div>
            </div>
            {% endfor %}
          </div>

          <!-- Mobile-Friendly Pagination -->
          {% if active_reservations_page.has_other_pages %}
          <div class="action-items-pagination">
            {% if active_reservations_page.has_previous %}
            <a href="?reservations_page={{ active_reservations_page.previous_page_number }}" class="pagination-btn">
              <i class="fas fa-chevron-left"></i>
              <span class="pagination-text">Previous</span>
            </a>
            {% else %}
            <span class="pagination-btn disabled">
              <i class="fas fa-chevron-left"></i>
              <span class="pagination-text">Previous</span>
            </span>
            {% endif %}
            
            <span class="pagination-info">
              Page <span class="current-page">{{ active_reservations_page.number }}</span> of <span class="total-pages">{{ active_reservations_page.paginator.num_pages }}</span>
            </span>
            
            {% if active_reservations_page.has_next %}
            <a href="?reservations_page={{ active_reservations_page.next_page_number }}" class="pagination-btn">
              <span class="pagination-text">Next</span>
              <i class="fas fa-chevron-right"></i>
            </a>
            {% else %}
            <span class="pagination-btn disabled">
              <span class="pagination-text">Next</span>
              <i class="fas fa-chevron-right"></i>
            </span>
            {% endif %}
          </div>
          {% endif %}
        </div>
        {% endif %}

        <!-- Active Borrows -->
        {% if active_borrows %}
        <div class="action-items-container">
          <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-weight: 600; color: #1f1f1f;">
            <i class="fas fa-hand-holding-heart" style="color: #9C27B0; font-size: 18px;"></i>
            Currently Borrowed ({{ active_borrows|length }})
          </h3>
          <div class="action-items-list">
            {% for item in active_borrows_page %}
            <div class="action-item-card borrowed-card">
              <div class="action-item-icon">
                <i class="fas {{ item.icon }}" style="color: #9C27B0;"></i>
              </div>
              <div class="action-item-content">
                <div class="action-item-title">{{ item.item_name }}</div>
                <div class="action-item-meta">
                  <span class="action-item-type">{{ item.type }}</span>
                  <span class="action-item-qty">Qty: {{ item.quantity }}</span>
                </div>
                <div class="action-item-dates">
                  <small>Return: {{ item.return_date|date:"M d, Y" }} ({{ item.days_remaining }} days left)</small>
                </div>
              </div>
              <div class="action-item-action">
                <a href="{% url 'request_detail' 'batch_borrow' item.id %}" class="action-btn-small" title="View details">
                  <i class="fas fa-arrow-right"></i>
                </a>
              </div>
            </div>
            {% endfor %}
          </div>

          <!-- Mobile-Friendly Pagination -->
          {% if active_borrows_page.has_other_pages %}
          <div class="action-items-pagination">
            {% if active_borrows_page.has_previous %}
            <a href="?borrows_page={{ active_borrows_page.previous_page_number }}" class="pagination-btn">
              <i class="fas fa-chevron-left"></i>
              <span class="pagination-text">Previous</span>
            </a>
            {% else %}
            <span class="pagination-btn disabled">
              <i class="fas fa-chevron-left"></i>
              <span class="pagination-text">Previous</span>
            </span>
            {% endif %}
            
            <span class="pagination-info">
              Page <span class="current-page">{{ active_borrows_page.number }}</span> of <span class="total-pages">{{ active_borrows_page.paginator.num_pages }}</span>
            </span>
            
            {% if active_borrows_page.has_next %}
            <a href="?borrows_page={{ active_borrows_page.next_page_number }}" class="pagination-btn">
              <span class="pagination-text">Next</span>
              <i class="fas fa-chevron-right"></i>
            </a>
            {% else %}
            <span class="pagination-btn disabled">
              <span class="pagination-text">Next</span>
              <i class="fas fa-chevron-right"></i>
            </span>
            {% endif %}
          </div>
          {% endif %}
        </div>
        {% endif %}
    
    </div>

    {% endblock content %}
    <script src="{% static 'scripts/notificationBell.js' %}"></script>
    
    <script>
      // User dashboard specific notification handling
      document.addEventListener('DOMContentLoaded', function() {
        // Add click event listeners to both mobile and desktop notification containers
        const mobileContainer = document.getElementById('notificationsContainer');
        const desktopContainer = document.querySelector('.desktop-notifications-body');
        
        if (mobileContainer) {
          mobileContainer.addEventListener('click', function(e) {
            const notificationItem = e.target.closest('.clickable-notification');
            if (notificationItem) {
              const message = notificationItem.dataset.message;
              const notificationId = notificationItem.dataset.id;
              handleNotificationClick(notificationItem, message, parseInt(notificationId));
            }
          });
        }
        
        if (desktopContainer) {
          desktopContainer.addEventListener('click', function(e) {
            const notificationItem = e.target.closest('.clickable-notification');
            if (notificationItem) {
              const message = notificationItem.dataset.message;
              const notificationId = notificationItem.dataset.id;
              handleNotificationClick(notificationItem, message, parseInt(notificationId));
            }
          });
        }
      });

      function handleNotificationClick(element, message, notificationId) {
        console.log('Notification clicked:', message, notificationId);
        
        // Determine redirect URL based on message content
        let redirectUrl = '/userpanel/user_dashboard/'; // default fallback
        
        if (message.toLowerCase().includes('supply request') || message.toLowerCase().includes('request')) {
          localStorage.setItem('activeRequestTab', 'supply');
          redirectUrl = '/userpanel/user_unified_request/';
        } else if (message.toLowerCase().includes('borrow')) {
          localStorage.setItem('activeRequestTab', 'borrow');
          redirectUrl = '/userpanel/user_unified_request/';
        } else if (message.toLowerCase().includes('reservation')) {
          // Extract reservation ID from the message
          const idMatch = message.match(/#(\d+)/i);
          if (idMatch) {
            redirectUrl = `/userpanel/request-detail/reservation/${idMatch[1]}/`;
          } else {
            redirectUrl = '/userpanel/user_reserve/';
          }
        } else if (message.toLowerCase().includes('damage report')) {
          redirectUrl = '/userpanel/user_report/';
        }
        
        // Mark as read visually and update badge count
        if (element.classList.contains('unread')) {
          element.classList.remove('unread');
          const unreadIndicator = element.querySelector('.unread-indicator');
          if (unreadIndicator) {
            unreadIndicator.remove();
          }
          
          // Update both mobile and desktop badge counts
          const mobileBadge = document.getElementById('notificationCount');
          const desktopBadge = document.getElementById('notificationCountDesktop');
          
          [mobileBadge, desktopBadge].forEach(badge => {
            if (badge) {
              let count = parseInt(badge.textContent) || 0;
              if (count > 1) {
                badge.textContent = count - 1;
              } else {
                badge.remove();
              }
            }
          });
          
          // Mark the notification as read in the backend, then redirect
          fetch('/mark-notification-read/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ 'notification_id': notificationId })
          }).then(() => {
            window.location.href = redirectUrl;
          }).catch(error => {
            console.error('Error marking notification as read:', error);
            window.location.href = redirectUrl;
          });
        } else {
          // Already read, just redirect
          window.location.href = redirectUrl;
        }
      }
      
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      function handleLogout() {
        if (confirm('Are you sure you want to log out?')) {
          document.getElementById('logout-form').submit();
        }
      }

      // Mobile logout function
      function handleMobileLogout(event) {
        event.preventDefault();
        if (confirm('Are you sure you want to log out?')) {
          document.getElementById('logout-form').submit();
        }
      }

      // Mobile navigation functionality
      const mobileMenuToggle = document.getElementById("mobileMenuToggle");
      const mobileOverlay = document.getElementById("mobileOverlay");
      const sidebar = document.querySelector(".sidebar");
      
      if (mobileMenuToggle && sidebar) {
        mobileMenuToggle.addEventListener("click", function() {
          sidebar.classList.toggle("mobile-open");
          mobileOverlay.classList.toggle("active");
          document.body.classList.toggle("mobile-menu-open");
        });

        mobileOverlay.addEventListener("click", function() {
          sidebar.classList.remove("mobile-open");
          mobileOverlay.classList.remove("active");
          document.body.classList.remove("mobile-menu-open");
        });

        // Close menu when clicking a sidebar link on mobile
        const sidebarLinks = sidebar.querySelectorAll("a");
        sidebarLinks.forEach(link => {
          link.addEventListener("click", function() {
            if (window.innerWidth <= 768) {
              sidebar.classList.remove("mobile-open");
              mobileOverlay.classList.remove("active");
              document.body.classList.remove("mobile-menu-open");
            }
          });
        });

        // Close sidebar when clicking the close button
        const sidebarClose = document.getElementById("sidebarClose");
        if (sidebarClose) {
          sidebarClose.addEventListener("click", function() {
            sidebar.classList.remove("mobile-open");
            mobileOverlay.classList.remove("active");
            document.body.classList.remove("mobile-menu-open");
          });
        }
      }

      // Desktop notification click handlers (notificationBell.js handles the dropdown toggle)
      const desktopNotifBody = document.querySelector('.desktop-notifications-body');
      if (desktopNotifBody) {
        desktopNotifBody.addEventListener('click', function(e) {
          const notificationItem = e.target.closest('.clickable-notification');
          if (notificationItem && !e.target.closest('.action-btn')) {
            const message = notificationItem.dataset.message;
            const notificationId = notificationItem.dataset.id;
            handleNotificationClick(notificationItem, message, parseInt(notificationId));
          }
        });
      }

      // Card Filter Functionality for Pending Card
      const pendingMenuBtn = document.getElementById('pendingMenuBtn');
      const pendingMenuDropdown = document.getElementById('pendingMenuDropdown');
      const pendingMenuItems = pendingMenuDropdown ? pendingMenuDropdown.querySelectorAll('.menu-item') : [];

      if (pendingMenuBtn && pendingMenuDropdown) {
        pendingMenuBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          pendingMenuDropdown.classList.toggle('active');
          // Close approved dropdown if open
          if (approvedMenuDropdown) approvedMenuDropdown.classList.remove('active');
        });

        pendingMenuItems.forEach(item => {
          item.addEventListener('click', function(e) {
            e.preventDefault();
            const type = this.getAttribute('data-type');
            
            console.log('Pending filter clicked:', type);
            
            // Remove selected attribute from all items
            pendingMenuItems.forEach(m => m.removeAttribute('selected'));
            
            // Add selected attribute to clicked item
            this.setAttribute('selected', '');
            
            // Fetch new count for the selected type
            const url = `/userpanel/api/pending-count/?type=${type}`;
            console.log('Fetching from URL:', url);
            
            fetch(url, {
              method: 'GET',
              credentials: 'same-origin',
              headers: {
                'X-CSRFToken': getCookie('csrftoken')
              }
            })
            .then(response => {
              console.log('Response received:', response.status, response.statusText);
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              console.log('Pending count response:', data);
              const countElement = document.getElementById('pendingCount');
              if (countElement) {
                console.log('Updating count from', countElement.textContent, 'to', data.count);
                countElement.textContent = data.count;
              } else {
                console.error('pendingCount element not found!');
              }
            })
            .catch(error => {
              console.error('Error fetching pending count:', error);
            });
            
            pendingMenuDropdown.classList.remove('active');
          });
        });
      }

      // Card Filter Functionality for Approved Card
      const approvedMenuBtn = document.getElementById('approvedMenuBtn');
      const approvedMenuDropdown = document.getElementById('approvedMenuDropdown');
      const approvedMenuItems = approvedMenuDropdown ? approvedMenuDropdown.querySelectorAll('.menu-item') : [];

      if (approvedMenuBtn && approvedMenuDropdown) {
        approvedMenuBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          approvedMenuDropdown.classList.toggle('active');
          // Close pending dropdown if open
          if (pendingMenuDropdown) pendingMenuDropdown.classList.remove('active');
        });

        approvedMenuItems.forEach(item => {
          item.addEventListener('click', function(e) {
            e.preventDefault();
            const type = this.getAttribute('data-type');
            
            // Remove selected attribute from all items
            approvedMenuItems.forEach(m => m.removeAttribute('selected'));
            
            // Add selected attribute to clicked item
            this.setAttribute('selected', '');
            
            // Fetch new count for the selected type
            fetch(`/userpanel/api/approved-count/?type=${type}`, {
              headers: {
                'X-CSRFToken': getCookie('csrftoken')
              }
            })
            .then(response => response.json())
            .then(data => {
              document.getElementById('approvedCount').textContent = data.count;
            })
            .catch(error => console.error('Error fetching approved count:', error));
            
            approvedMenuDropdown.classList.remove('active');
          });
        });
      }

      // Card Filter Functionality for Active Card
      const activeMenuBtn = document.getElementById('activeMenuBtn');
      const activeMenuDropdown = document.getElementById('activeMenuDropdown');
      const activeMenuItems = activeMenuDropdown ? activeMenuDropdown.querySelectorAll('.menu-item') : [];

      console.log('Active menu setup:', { activeMenuBtn, activeMenuDropdown, itemsCount: activeMenuItems.length });

      if (activeMenuBtn && activeMenuDropdown) {
        activeMenuBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          console.log('Active menu button clicked');
          activeMenuDropdown.classList.toggle('active');
          // Close other dropdowns if open
          if (pendingMenuDropdown) pendingMenuDropdown.classList.remove('active');
          if (approvedMenuDropdown) approvedMenuDropdown.classList.remove('active');
        });

        activeMenuItems.forEach(item => {
          item.addEventListener('click', function(e) {
            e.preventDefault();
            const type = this.getAttribute('data-type');
            console.log('Active menu item clicked:', type);
            
            // Remove selected attribute from all items
            activeMenuItems.forEach(m => m.removeAttribute('selected'));
            
            // Add selected attribute to clicked item
            this.setAttribute('selected', '');
            
            // Fetch new count for the selected type
            const url = `/userpanel/api/active-count/?type=${type}`;
            console.log('Fetching from:', url);
            fetch(url, {
              headers: {
                'X-CSRFToken': getCookie('csrftoken')
              }
            })
            .then(response => {
              console.log('Response status:', response.status);
              return response.json();
            })
            .then(data => {
              console.log('Active count data:', data);
              document.getElementById('activeCount').textContent = data.count;
            })
            .catch(error => console.error('Error fetching active count:', error));
            
            activeMenuDropdown.classList.remove('active');
          });
        });
      }

      // Close card dropdowns when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.card-menu-wrapper')) {
          if (pendingMenuDropdown) pendingMenuDropdown.classList.remove('active');
          if (approvedMenuDropdown) approvedMenuDropdown.classList.remove('active');
          if (activeMenuDropdown) activeMenuDropdown.classList.remove('active');
        }
      });

      // Initialize Modern Horizontal Bar Chart for Status Distribution
      const chartDataStr = '{{ status_chart_data|safe }}';
      if (chartDataStr) {
        try {
          const chartData = JSON.parse(chartDataStr);
          const ctx = document.getElementById('statusBarChart').getContext('2d');
          
          const chart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: chartData.labels,
              datasets: [{
                label: 'Count',
                data: chartData.data,
                backgroundColor: chartData.backgroundColor,
                borderRadius: 6,
                borderSkipped: false,
                barThickness: 'flex',
                maxBarThickness: 45
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  padding: 12,
                  titleFont: {
                    size: 13,
                    weight: 'bold'
                  },
                  bodyFont: {
                    size: 12
                  },
                  callbacks: {
                    label: function(context) {
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = ((context.parsed.x / total) * 100).toFixed(1);
                      return 'Count: ' + context.parsed.x + ' (' + percentage + '%)';
                    }
                  }
                }
              },
              scales: {
                x: {
                  beginAtZero: true,
                  max: Math.max(...chartData.data) + 2,
                  grid: {
                    color: 'rgba(0, 0, 0, 0.05)',
                    drawBorder: false
                  },
                  ticks: {
                    font: {
                      size: 11,
                      weight: '500'
                    },
                    stepSize: 1
                  }
                },
                y: {
                  grid: {
                    display: false,
                    drawBorder: false
                  },
                  ticks: {
                    font: {
                      size: 12,
                      weight: '500'
                    },
                    color: '#333',
                    padding: 8
                  }
                }
              }
            }
          });
        } catch (e) {
          console.error('Error initializing status bar chart:', e);
        }
      }
    </script>
  </body>
</html>

<script>
  // Retain scroll position for action items pagination
  document.addEventListener('DOMContentLoaded', function() {
    // Check if we're returning from pagination
    const scrollPos = sessionStorage.getItem('actionItemsScrollPos');
    if (scrollPos) {
      setTimeout(() => {
        window.scrollTo(0, parseInt(scrollPos));
        sessionStorage.removeItem('actionItemsScrollPos');
      }, 100);
    }

    // Store scroll position before pagination
    const paginationButtons = document.querySelectorAll('.action-items-pagination a');
    paginationButtons.forEach(button => {
      button.addEventListener('click', function() {
        const actionItemsSection = document.querySelector('.action-items-section');
        if (actionItemsSection) {
          const scrollOffset = actionItemsSection.getBoundingClientRect().top + window.pageYOffset - 20;
          sessionStorage.setItem('actionItemsScrollPos', scrollOffset);
        }
      });
    });
  });
</script>
