{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Dashboard</title>
    <link rel="stylesheet" href="{% static 'css/userStyle.css' %}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    
    <style>
      /* Ensure sidebar appears above header */
      .sidebar {
        z-index: 1000 !important;
      }

      /* Top header bar for notifications */
      .top-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: #f5f5f5;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 30px;
        z-index: 500;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-bottom: 1px solid #e0e0e0;
      }

      .header-greeting {
        color: #333;
        font-size: 18px;
        font-weight: 600;
        text-align: center;
      }

      .header-greeting span {
        color: #152d64;
      }

      /* Notification container positioned on the right */
      .notification-container {
        position: absolute;
        right: 80px;
        top: 50%;
        transform: translateY(-50%);
        display: inline-flex;
        align-items: center;
        font-family: Arial, sans-serif;
        cursor: pointer;
      }

      /* Logout container positioned on the far right */
      .logout-container {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        display: inline-flex;
        align-items: center;
        font-family: Arial, sans-serif;
        cursor: pointer;
      }

      /* Adjust main content to account for header */
      .parent {
        margin-left: 250px;
        margin-top: 40px;
        padding: 30px;
      }

      .bell-wrapper {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        background: linear-gradient(135deg, #152d64 0%, #1a3575 100%);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(21, 45, 100, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .logout-wrapper {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .bell-wrapper:hover {
        background: linear-gradient(135deg, #1a3575 0%, #2147a3 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(21, 45, 100, 0.3);
      }

      .logout-wrapper:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      }

      .bell-icon {
        font-size: 18px;
        color: white;
        transition: all 0.3s ease;
      }

      .logout-icon {
        font-size: 18px;
        color: white;
        transition: all 0.3s ease;
      }

      .bell-wrapper:hover .bell-icon {
        color: #fbff00;
        animation: bellShake 0.5s ease-in-out;
      }

      .logout-wrapper:hover .logout-icon {
        animation: iconGlow 0.5s ease-in-out;
      }

      @keyframes iconGlow {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
      }

      @keyframes bellShake {
        0%, 100% { transform: rotate(0deg); }
        25% { transform: rotate(-10deg); }
        75% { transform: rotate(10deg); }
      }

      .notification-count {
        position: absolute;
        top: -6px;
        right: -6px;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        font-size: 11px;
        font-weight: 700;
        padding: 3px 7px;
        border-radius: 12px;
        min-width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid white;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
      }

      .notifications-dropdown {
        display: none;
        position: absolute;
        top: 65px;
        right: 0;
        width: 380px;
        max-height: 480px;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 
          0 20px 40px rgba(0, 0, 0, 0.15),
          0 0 0 1px rgba(0, 0, 0, 0.08);
        z-index: 100;
        overflow: hidden;
        transform: translateY(-15px) scale(0.9);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        border: 1px solid #e5e7eb;
      }

      .notifications-dropdown.active {
        display: block;
        transform: translateY(0) scale(1);
        opacity: 1;
      }

      .notification-header {
        background: #152d64;
        color: white;
        padding: 20px;
        border-radius: 12px 12px 0 0;
      }

      .notification-title {
        margin: 0 0 0 0;
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .notification-title i {
        font-size: 20px;
        color: #fbbf24;
      }

      .notification-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .notification-actions {
        position: relative;
      }

      .actions-toggle {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 8px;
        border-radius: 6px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
      }

      .actions-toggle:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: scale(1.1);
      }

      .actions-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border-radius: 8px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        min-width: 160px;
        z-index: 1000;
        overflow: hidden;
        margin-top: 8px;
        border: 1px solid #e5e7eb;
      }

      .actions-dropdown.active {
        display: block;
        animation: dropdownSlide 0.3s ease;
      }

      @keyframes dropdownSlide {
        from {
          opacity: 0;
          transform: translateY(-10px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .actions-dropdown .action-btn {
        background: none;
        border: none;
        color: #374151;
        padding: 12px 16px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        text-align: left;
        border-bottom: 1px solid #f3f4f6;
      }

      .actions-dropdown .action-btn:last-child {
        border-bottom: none;
      }

      .actions-dropdown .action-btn:hover {
        background: #f9fafb;
        transform: translateX(4px);
      }

      .actions-dropdown .mark-read-btn:hover {
        background: rgba(34, 197, 94, 0.1);
        color: #22c55e;
      }

      .actions-dropdown .clear-btn:hover {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
      }

      .notifications-body {
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
        background: #ffffff;
      }

      .notification-item {
        padding: 18px 20px;
        margin-bottom: 10px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        background: #ffffff;
        border: 1px solid #e5e7eb;
      }

      .notification-item:hover {
        background: #f8fafc;
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        border-color: #cbd5e1;
      }

      .notification-item.unread {
        background: #eff6ff;
        border-left: 4px solid #3b82f6;
        border-color: #bfdbfe;
      }

      .notification-item.unread:hover {
        background: #dbeafe;
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.12);
      }

      .notification-content {
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 100%;
      }

      .notification-message {
        font-size: 15px;
        font-weight: 600;
        color: #1e293b;
        line-height: 1.4;
        letter-spacing: -0.01em;
        margin: 0;
      }

      .notification-details {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .notification-remarks {
        font-size: 13px;
        color: #475569;
        font-style: italic;
        padding: 10px 14px;
        background: linear-gradient(135deg, rgba(241, 245, 249, 0.8) 0%, rgba(248, 250, 252, 0.9) 100%);
        border-radius: 8px;
        border-left: 4px solid #e2e8f0;
        margin: 0;
        line-height: 1.4;
        word-wrap: break-word;
      }

      .notification-remarks span {
        color: #334155;
        font-weight: 500;
      }

      .notification-timestamp {
        font-size: 12px;
        color: #94a3b8;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 4px;
      }

      .notification-timestamp::before {
        content: '‚è∞';
        font-size: 11px;
      }

      .unread-indicator {
        position: absolute;
        top: 22px;
        right: 22px;
        width: 8px;
        height: 8px;
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 12px rgba(59, 130, 246, 0.5);
        animation: pulseGlow 2s infinite;
      }

      @keyframes pulseGlow {
        0%, 100% { 
          transform: scale(1);
          box-shadow: 0 0 15px rgba(59, 130, 246, 0.6);
        }
        50% { 
          transform: scale(1.2);
          box-shadow: 0 0 25px rgba(59, 130, 246, 0.8);
        }
      }

      .no-notifications {
        padding: 40px 24px;
        text-align: center;
        cursor: default;
        background: linear-gradient(135deg, rgba(248,250,252,0.8) 0%, rgba(255,255,255,0.9) 100%);
        border-radius: 16px;
        margin: 8px;
        border: 2px dashed rgba(203, 213, 225, 0.5);
      }

      .no-notifications:hover {
        background: linear-gradient(135deg, rgba(248,250,252,0.8) 0%, rgba(255,255,255,0.9) 100%);
        transform: none;
        box-shadow: none;
      }

      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
        color: #94a3b8;
      }

      .empty-state i {
        font-size: 36px;
        opacity: 0.6;
        color: #cbd5e1;
      }

      .empty-state p {
        margin: 0;
        font-size: 16px;
        font-weight: 500;
        color: #64748b;
      }

      @media (max-width: 768px) {
        .top-header {
          padding: 0 15px;
        }

        .notification-container {
          right: 75px;
        }

        .logout-container {
          right: 15px;
        }

        .parent {
          margin-left: 0;
        }

        .header-greeting {
          font-size: 16px;
        }

        .bell-wrapper {
          width: 40px;
          height: 40px;
        }

        .logout-wrapper {
          width: 40px;
          height: 40px;
        }

        .bell-icon {
          font-size: 16px;
        }

        .logout-icon {
          font-size: 16px;
        }

        .notifications-dropdown {
          width: 320px;
          right: -10px;
        }

        .actions-dropdown {
          min-width: 140px;
          right: -10px;
        }

        .notification-item {
          padding: 14px 16px;
        }

        .notification-message {
          font-size: 14px;
        }

        .notification-remarks {
          padding: 8px 12px;
          font-size: 12px;
        }
      }

      @media (max-width: 480px) {
        .notifications-dropdown {
          width: calc(100vw - 30px);
          right: -15px;
        }

        .notification-item {
          padding: 12px 14px;
        }

        .notification-message {
          font-size: 13px;
        }
      }
    </style>
  </head>
  <body>
    {% block content %} 
    
    <!-- Top Header with Notifications -->
    <div class="top-header">
      <div class="header-greeting">
        Hello, <span>{{ request.user.username }}</span>
      </div>
      
      <!-- Notification Bell -->
      <div
        class="notification-container"
        id="notificationBell"
        aria-label="Notifications"
        tabindex="0"
        role="button"
      >
        <div class="bell-wrapper">
          <i class="fas fa-bell bell-icon" title="Notifications"></i>
          {% if unread_count > 0 %}
          <span class="notification-count" id="notificationCount">{{ unread_count }}</span>
          {% endif %}
        </div>

        <div
          class="notifications-dropdown"
          id="notificationsDropdown"
          role="list"
          aria-live="polite"
          aria-relevant="additions"
        >
          <div class="notification-header">
            <h4 class="notification-title">
              <i class="fas fa-bell"></i>
              Notifications
            </h4>
            <div class="notification-actions">
              <button type="button" class="actions-toggle" id="actionsToggle" aria-label="Notification actions">
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <div class="actions-dropdown" id="actionsDropdown">
                <button id="markAllReadBtn" type="button" class="action-btn mark-read-btn">
                  <i class="fas fa-check"></i>
                  Mark all read
                </button>
                <button id="clearAllBtn" type="button" class="action-btn clear-btn">
                  <i class="fas fa-trash"></i>
                  Clear all
                </button>
              </div>
            </div>
          </div>

          <div id="notificationsContainer" class="notifications-body">
            {% if notifications %} {% for notification in notifications %}
            <div
              class="notification-item {% if not notification.is_read %}unread{% endif %} clickable-notification"
              tabindex="0"
              data-id="{{ notification.id }}"
              data-message="{{ notification.message|escape }}"
            >
              <div class="notification-content">
                <div class="notification-message">{{ notification.message }}</div>
                <div class="notification-details">
                  {% if notification.remarks %}
                  <div class="notification-remarks">
                    <strong>Remarks:</strong> <span>{{ notification.remarks }}</span>
                  </div>
                  {% endif %}
                  <div class="notification-timestamp">
                    {{ notification.timestamp|date:"M d, Y H:i" }}
                  </div>
                </div>
              </div>
              {% if not notification.is_read %}
              <div class="unread-indicator"></div>
              {% endif %}
            </div>
            {% endfor %} {% else %}
            <div
              class="notification-item no-notifications"
              id="noNotificationsMsg"
            >
              <div class="empty-state">
                <i class="fas fa-bell-slash"></i>
                <p>No notifications</p>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Logout Button -->
      <div class="logout-container">
        <form
          id="logout-form"
          action="{% url 'logout' %}"
          method="post"
          style="display: none"
        >
          {% csrf_token %}
        </form>
        <div class="logout-wrapper" onclick="handleLogout()" title="Logout">
          <i class="fas fa-sign-out-alt logout-icon"></i>
        </div>
      </div>
    </div>

    {% include 'userpanel/user_navbar.html' %}

    <div class="parent">

      <!-- Quick Stats Cards -->
      <div class="dashboard-stats">
        <div class="stat-card">
          <div class="stat-title">Requests</div>
          <div class="stat-value">{{ request_count }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Borrows</div>
          <div class="stat-value">{{ borrow_count }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Reservations</div>
          <div class="stat-value">{{ reservation_count }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Damage Reports</div>
          <div class="stat-value">{{ damage_count }}</div>
        </div>
      </div>

      <!-- User Profile Summary -->
      <div class="user-profile-summary">
        <h3><i class="fas fa-user"></i> Profile</h3>
        <ul>
          <li><strong>Username:</strong> {{ request.user.username }}</li>
          <li><strong>Email:</strong> {{ request.user.email }}</li>
          <li><strong>Last Login:</strong> {{ request.user.last_login|date:"M d, Y H:i" }}</li>
        </ul>
      </div>

      <!-- Recent Activity Feed -->
      <div class="recent-activity">
        <h3><i class="fas fa-history"></i> Recent Activity</h3>
        <ul>
          {% if recent_activity %}
            {% for activity in recent_activity %}
              <li>
                <span class="activity-message">{{ activity.message }}</span>
                <span class="activity-timestamp">{{ activity.timestamp|date:"M d, Y H:i" }}</span>
              </li>
            {% endfor %}
          {% else %}
            <li>No recent activity.</li>
          {% endif %}
        </ul>
      </div>
    </div>

    <!-- History Tables Section -->
    <div class="history-section">
      <!-- Request History -->
      <div class="history-table-container">
        <h3><i class="fas fa-file-alt"></i> Request History</h3>
        {% if request_history %}
        <div class="table-wrapper">
          <table class="history-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Qty</th>
                <th>Status</th>
                <th>Date</th>
                <th>Purpose</th>
              </tr>
            </thead>
            <tbody>
              {% for request in request_history %}
              <tr>
                <td>{{ request.item|truncatechars:30 }}</td>
                <td>{{ request.quantity }}</td>
                <td>
                  <span
                    class="status-badge status-{{ request.status|lower|cut:' ' }}"
                  >
                    {{ request.status }}
                  </span>
                </td>
                <td>{{ request.date|date:"M d, Y" }}</td>
                <td>{{ request.purpose|truncatechars:40 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="pagination">
            {% if request_history_page.has_previous %}
            <a
              href="?request_page={{ request_history_page.previous_page_number }}"
              >&laquo; Previous</a
            >
            {% endif %}

            <span
              >Page {{ request_history_page.number }} of
              <!-- comment wag alisin pls-->
              {{ request_history_page.paginator.num_pages }}</span
            >

            {% if request_history_page.has_next %}
            <a href="?request_page={{ request_history_page.next_page_number }}"
              >Next &raquo;</a
            >
            {% endif %}
          </div>
        </div>
        {% else %}
        <div class="no-history">
          <i class="fas fa-inbox"></i>
          <p>No request history found.</p>
        </div>
        {% endif %}
      </div>

      <!-- Borrow History -->
      <div class="history-table-container">
        <h3><i class="fas fa-hand-holding"></i> Borrow History</h3>
        {% if borrow_history %}
        <div class="table-wrapper">
          <table class="history-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Qty</th>
                <th>Status</th>
                <th>Borrow Date</th>
                <th>Return Date</th>
              </tr>
            </thead>
            <tbody>
              {% for borrow in borrow_history %}
              <tr>
                <td>{{ borrow.item|truncatechars:30 }}</td>
                <td>{{ borrow.quantity }}</td>
                <td>
                  <span
                    class="status-badge status-{{ borrow.status|lower|cut:' ' }}"
                  >
                    {{ borrow.status }}
                  </span>
                </td>
                <td>{{ borrow.borrow_date|date:"M d, Y" }}</td>
                <td>{{ borrow.return_date|date:"M d, Y" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="pagination">
            {% if borrow_history_page.has_previous %}
            <a
              href="?borrow_page={{ borrow_history_page.previous_page_number }}"
              >&laquo; Previous</a
            >
            {% endif %}

            <span>
              Page {{ borrow_history_page.number }} of
              <!-- comment wag alisin pls-->
              {{ borrow_history_page.paginator.num_pages }}
            </span>

            {% if borrow_history_page.has_next %}
            <a href="?borrow_page={{ borrow_history_page.next_page_number }}"
              >Next &raquo;</a
            >
            {% endif %}
          </div>
        </div>
        {% else %}
        <div class="no-history">
          <i class="fas fa-inbox"></i>
          <p>No borrow history found.</p>
        </div>
        {% endif %}
      </div>

      <!-- Reservation History -->
      <div class="history-table-container">
        <h3><i class="fas fa-calendar-alt"></i> Reservation History</h3>
        {% if reservation_history %}
        <div class="table-wrapper">
          <table class="history-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Qty</th>
                <th>Status</th>
                <th>Needed Date</th>
                <th>Return Date</th>
                <th>Purpose</th>
              </tr>
            </thead>
            <tbody>
              {% for reservation in reservation_history %}
              <tr>
                <td>{{ reservation.item|truncatechars:30 }}</td>
                <td>{{ reservation.quantity }}</td>
                <td>
                  <span
                    class="status-badge status-{{ reservation.status|lower|cut:' ' }}"
                  >
                    {{ reservation.status }}
                  </span>
                </td>
                <td>{{ reservation.needed_date|date:"M d, Y" }}</td>
                <td>{{ reservation.return_date|date:"M d, Y" }}</td>
                <td>{{ reservation.purpose|truncatechars:40 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="pagination">
            {% if reservation_history_page.has_previous %}
            <a
              href="?reservation_page={{ reservation_history_page.previous_page_number }}"
              >&laquo; Previous</a
            >
            {% endif %}

            <span>
              Page {{ reservation_history_page.number }} of
              <!-- comment wag alisin pls-->
              {{ reservation_history_page.paginator.num_pages }}
            </span>

            {% if reservation_history_page.has_next %}
            <a
              href="?reservation_page={{ reservation_history_page.next_page_number }}"
              >Next &raquo;</a
            >
            {% endif %}
          </div>
        </div>
        {% else %}
        <div class="no-history">
          <i class="fas fa-inbox"></i>
          <p>No reservation history found.</p>
        </div>
        {% endif %}
      </div>

      <!-- Damage Report History -->
      <div class="history-table-container">
        <h3>
          <i class="fas fa-exclamation-triangle"></i> Damage Report History
        </h3>
        {% if damage_history %}
        <div class="table-wrapper">
          <table class="history-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Status</th>
                <th>Report Date</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              {% for report in damage_history %}
              <tr>
                <td>{{ report.item|truncatechars:30 }}</td>
                <td>
                  <span
                    class="status-badge status-{{ report.status|lower|cut:' ' }}"
                  >
                    {{ report.status }}
                  </span>
                </td>
                <td>{{ report.date|date:"M d, Y" }}</td>
                <td>{{ report.description|truncatechars:50 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="pagination">
            {% if damage_history_page.has_previous %}
            <a
              href="?damage_page={{ damage_history_page.previous_page_number }}"
              >&laquo; Previous</a
            >
            {% endif %}

            <span>
              Page {{ damage_history_page.number }} of
              <!-- comment wag alisin pls-->
              {{ damage_history_page.paginator.num_pages }}
            </span>

            {% if damage_history_page.has_next %}
            <a href="?damage_page={{ damage_history_page.next_page_number }}"
              >Next &raquo;</a
            >
            {% endif %}
          </div>
        </div>
        {% else %}
        <div class="no-history">
          <i class="fas fa-inbox"></i>
          <p>No damage report history found.</p>
        </div>
        {% endif %}
      </div>
    </div>

    {% endblock content %}
    <script src="{% static 'scripts/notificationBell.js' %}"></script>
    
    <script>
      // User dashboard specific notification handling
      document.addEventListener('DOMContentLoaded', function() {
        // Add click event listeners to notification items
        document.getElementById('notificationsContainer').addEventListener('click', function(e) {
          const notificationItem = e.target.closest('.clickable-notification');
          if (notificationItem) {
            const message = notificationItem.dataset.message;
            const notificationId = notificationItem.dataset.id;
            handleNotificationClick(notificationItem, message, parseInt(notificationId));
          }
        });

        // Handle three-dot actions dropdown
        const actionsToggle = document.getElementById('actionsToggle');
        const actionsDropdown = document.getElementById('actionsDropdown');
        
        if (actionsToggle && actionsDropdown) {
          actionsToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            actionsDropdown.classList.toggle('active');
          });

          // Close dropdown when clicking outside
          document.addEventListener('click', function(e) {
            if (!actionsToggle.contains(e.target) && !actionsDropdown.contains(e.target)) {
              actionsDropdown.classList.remove('active');
            }
          });

          // Close dropdown when an action is clicked
          actionsDropdown.addEventListener('click', function() {
            actionsDropdown.classList.remove('active');
          });
        }
      });

      function handleNotificationClick(element, message, notificationId) {
        console.log('Notification clicked:', message, notificationId);
        
        // Mark as read visually
        if (element.classList.contains('unread')) {
          element.classList.remove('unread');
          const unreadIndicator = element.querySelector('.unread-indicator');
          if (unreadIndicator) {
            unreadIndicator.remove();
          }
          
          // Update count
          const currentBadge = document.getElementById('notificationCount');
          let count = currentBadge ? parseInt(currentBadge.textContent) : 0;
          if (count > 1) {
            currentBadge.textContent = count - 1;
          } else {
            if (currentBadge) currentBadge.remove();
          }
        }
        
        // Determine redirect URL based on message content
        let redirectUrl = '/userpanel/user_dashboard/'; // default fallback
        
        if (message.toLowerCase().includes('supply request') || message.toLowerCase().includes('request')) {
          redirectUrl = '/userpanel/user_request/';
        } else if (message.toLowerCase().includes('borrow')) {
          redirectUrl = '/userpanel/user_borrow/';
        } else if (message.toLowerCase().includes('reservation')) {
          redirectUrl = '/userpanel/user_reserve/';
        } else if (message.toLowerCase().includes('damage report')) {
          redirectUrl = '/userpanel/user_report/';
        }
        
        // Mark notification as read and redirect
        fetch('/mark-notification-read/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ 'notification_id': notificationId })
        }).then(() => {
          window.location.href = redirectUrl;
        }).catch(error => {
          console.error('Error marking notification as read:', error);
          window.location.href = redirectUrl;
        });
      }
      
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      function handleLogout() {
        if (confirm('Are you sure you want to log out?')) {
          document.getElementById('logout-form').submit();
        }
      }
    </script>
  </body>
</html>
