{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Dashboard</title>
    <link rel="stylesheet" href="{% static 'css/userStyle.css' %}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    

  </head>
  <body>
    {% block content %} 
    
    <!-- Top Header with Notifications -->
    <div class="top-header">
      <div class="header-greeting">
        Hello, <span>{{ request.user.username }}</span>
      </div>
      
      <!-- Notification Bell -->
      <div
        class="notification-container"
        id="notificationBell"
        aria-label="Notifications"
        tabindex="0"
        role="button"
      >
        <div class="bell-wrapper">
          <i class="fas fa-bell bell-icon" title="Notifications"></i>
          {% if unread_count > 0 %}
          <span class="notification-count" id="notificationCount">{{ unread_count }}</span>
          {% endif %}
        </div>

        <div
          class="notifications-dropdown"
          id="notificationsDropdown"
          role="list"
          aria-live="polite"
          aria-relevant="additions"
        >
          <div class="notification-header">
            <h4 class="notification-title">
              <i class="fas fa-bell"></i>
              Notifications
            </h4>
            <div class="notification-actions">
              <button type="button" class="actions-toggle" id="actionsToggle" aria-label="Notification actions">
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <div class="actions-dropdown" id="actionsDropdown">
                <button id="markAllReadBtn" type="button" class="action-btn mark-read-btn">
                  <i class="fas fa-check"></i>
                  Mark all read
                </button>
                <button id="clearAllBtn" type="button" class="action-btn clear-btn">
                  <i class="fas fa-trash"></i>
                  Clear all
                </button>
              </div>
            </div>
          </div>

          <div id="notificationsContainer" class="notifications-body">
            {% if notifications %} {% for notification in notifications %}
            <div
              class="notification-item {% if not notification.is_read %}unread{% endif %} clickable-notification"
              tabindex="0"
              data-id="{{ notification.id }}"
              data-message="{{ notification.message|escape }}"
            >
              <div class="notification-content">
                <div class="notification-message">{{ notification.message }}</div>
                <div class="notification-details">
                  {% if notification.remarks %}
                  <div class="notification-remarks">
                    <strong>Remarks:</strong> <span>{{ notification.remarks }}</span>
                  </div>
                  {% endif %}
                  <div class="notification-timestamp">
                    {{ notification.timestamp|date:"M d, Y H:i" }}
                  </div>
                </div>
              </div>
              {% if not notification.is_read %}
              <div class="unread-indicator"></div>
              {% endif %}
            </div>
            {% endfor %} {% else %}
            <div
              class="notification-item no-notifications"
              id="noNotificationsMsg"
            >
              <div class="empty-state">
                <i class="fas fa-bell-slash"></i>
                <p>No notifications</p>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Logout Button -->
      <div class="logout-container">
        <form
          id="logout-form"
          action="{% url 'logout' %}"
          method="post"
          class="hidden"
        >
          {% csrf_token %}
        </form>
        <div class="logout-wrapper" onclick="handleLogout()" title="Logout">
          <i class="fas fa-sign-out-alt logout-icon"></i>
        </div>
      </div>
    </div>

    {% include 'userpanel/user_navbar.html' %}

    <div class="parent">

      <!-- Quick Stats Cards -->
      <div class="dashboard-stats">
        <div class="stat-card">
          <div class="stat-title">Requests</div>
          <div class="stat-value">{{ request_count }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Borrows</div>
          <div class="stat-value">{{ borrow_count }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Reservations</div>
          <div class="stat-value">{{ reservation_count }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Damage Reports</div>
          <div class="stat-value">{{ damage_count }}</div>
        </div>
      </div>

      <!-- Recent Activity Feed -->
      <div class="recent-activity">
        <h3><i class="fas fa-history"></i> Recent Activity</h3>
        <ul>
          {% if recent_activity %}
            {% for activity in recent_activity %}
              <li>
                <span class="activity-message">{{ activity.message }}</span>
                <span class="activity-timestamp">{{ activity.timestamp|date:"M d, Y H:i" }}</span>
              </li>
            {% endfor %}
          {% else %}
            <li>No recent activity.</li>
          {% endif %}
        </ul>
      </div>
    </div>

    <!-- History Tables Section -->
    <div class="history-section">
      <!-- Request History -->
      <div class="history-table-container">
        <h3><i class="fas fa-file-alt"></i> Request History</h3>
        {% if request_history %}
        <div class="table-wrapper">
          <table class="history-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Qty</th>
                <th>Status</th>
                <th>Date</th>
                <th>Purpose</th>
              </tr>
            </thead>
            <tbody>
              {% for request in request_history %}
              <tr>
                <td>{{ request.item|truncatechars:30 }}</td>
                <td>{{ request.quantity }}</td>
                <td>
                  <span
                    class="status-badge status-{{ request.status|lower|cut:' ' }}"
                  >
                    {{ request.status }}
                  </span>
                </td>
                <td>{{ request.date|date:"M d, Y" }}</td>
                <td>{{ request.purpose|truncatechars:40 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="pagination">
            {% if request_history_page.has_previous %}
            <a
              href="?request_page={{ request_history_page.previous_page_number }}"
              >&laquo; Previous</a
            >
            {% endif %}

            <span
              >Page {{ request_history_page.number }} of
              <!-- comment wag alisin pls-->
              {{ request_history_page.paginator.num_pages }}</span
            >

            {% if request_history_page.has_next %}
            <a href="?request_page={{ request_history_page.next_page_number }}"
              >Next &raquo;</a
            >
            {% endif %}
          </div>
        </div>
        {% else %}
        <div class="no-history">
          <i class="fas fa-inbox"></i>
          <p>No request history found.</p>
        </div>
        {% endif %}
      </div>

      <!-- Borrow History -->
      <div class="history-table-container">
        <h3><i class="fas fa-hand-holding"></i> Borrow History</h3>
        {% if borrow_history %}
        <div class="table-wrapper">
          <table class="history-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Qty</th>
                <th>Status</th>
                <th>Borrow Date</th>
                <th>Return Date</th>
              </tr>
            </thead>
            <tbody>
              {% for borrow in borrow_history %}
              <tr>
                <td>{{ borrow.item|truncatechars:30 }}</td>
                <td>{{ borrow.quantity }}</td>
                <td>
                  <span
                    class="status-badge status-{{ borrow.status|lower|cut:' ' }}"
                  >
                    {{ borrow.status }}
                  </span>
                </td>
                <td>{{ borrow.borrow_date|date:"M d, Y" }}</td>
                <td>{{ borrow.return_date|date:"M d, Y" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="pagination">
            {% if borrow_history_page.has_previous %}
            <a
              href="?borrow_page={{ borrow_history_page.previous_page_number }}"
              >&laquo; Previous</a
            >
            {% endif %}

            <span>
              Page {{ borrow_history_page.number }} of
              <!-- comment wag alisin pls-->
              {{ borrow_history_page.paginator.num_pages }}
            </span>

            {% if borrow_history_page.has_next %}
            <a href="?borrow_page={{ borrow_history_page.next_page_number }}"
              >Next &raquo;</a
            >
            {% endif %}
          </div>
        </div>
        {% else %}
        <div class="no-history">
          <i class="fas fa-inbox"></i>
          <p>No borrow history found.</p>
        </div>
        {% endif %}
      </div>

      <!-- Reservation History -->
      <div class="history-table-container">
        <h3><i class="fas fa-calendar-alt"></i> Reservation History</h3>
        {% if reservation_history %}
        <div class="table-wrapper">
          <table class="history-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Qty</th>
                <th>Status</th>
                <th>Needed Date</th>
                <th>Return Date</th>
                <th>Purpose</th>
              </tr>
            </thead>
            <tbody>
              {% for reservation in reservation_history %}
              <tr>
                <td>{{ reservation.item|truncatechars:30 }}</td>
                <td>{{ reservation.quantity }}</td>
                <td>
                  <span
                    class="status-badge status-{{ reservation.status|lower|cut:' ' }}"
                  >
                    {{ reservation.status }}
                  </span>
                </td>
                <td>{{ reservation.needed_date|date:"M d, Y" }}</td>
                <td>{{ reservation.return_date|date:"M d, Y" }}</td>
                <td>{{ reservation.purpose|truncatechars:40 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="pagination">
            {% if reservation_history_page.has_previous %}
            <a
              href="?reservation_page={{ reservation_history_page.previous_page_number }}"
              >&laquo; Previous</a
            >
            {% endif %}

            <span>
              Page {{ reservation_history_page.number }} of
              <!-- comment wag alisin pls-->
              {{ reservation_history_page.paginator.num_pages }}
            </span>

            {% if reservation_history_page.has_next %}
            <a
              href="?reservation_page={{ reservation_history_page.next_page_number }}"
              >Next &raquo;</a
            >
            {% endif %}
          </div>
        </div>
        {% else %}
        <div class="no-history">
          <i class="fas fa-inbox"></i>
          <p>No reservation history found.</p>
        </div>
        {% endif %}
      </div>

      <!-- Damage Report History -->
      <div class="history-table-container">
        <h3>
          <i class="fas fa-exclamation-triangle"></i> Damage Report History
        </h3>
        {% if damage_history %}
        <div class="table-wrapper">
          <table class="history-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Status</th>
                <th>Report Date</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              {% for report in damage_history %}
              <tr>
                <td>{{ report.item|truncatechars:30 }}</td>
                <td>
                  <span
                    class="status-badge status-{{ report.status|lower|cut:' ' }}"
                  >
                    {{ report.status }}
                  </span>
                </td>
                <td>{{ report.date|date:"M d, Y" }}</td>
                <td>{{ report.description|truncatechars:50 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="pagination">
            {% if damage_history_page.has_previous %}
            <a
              href="?damage_page={{ damage_history_page.previous_page_number }}"
              >&laquo; Previous</a
            >
            {% endif %}

            <span>
              Page {{ damage_history_page.number }} of
              <!-- comment wag alisin pls-->
              {{ damage_history_page.paginator.num_pages }}
            </span>

            {% if damage_history_page.has_next %}
            <a href="?damage_page={{ damage_history_page.next_page_number }}"
              >Next &raquo;</a
            >
            {% endif %}
          </div>
        </div>
        {% else %}
        <div class="no-history">
          <i class="fas fa-inbox"></i>
          <p>No damage report history found.</p>
        </div>
        {% endif %}
      </div>
    </div>

    {% endblock content %}
    <script src="{% static 'scripts/notificationBell.js' %}"></script>
    
    <script>
      // User dashboard specific notification handling
      document.addEventListener('DOMContentLoaded', function() {
        // Add click event listeners to notification items
        document.getElementById('notificationsContainer').addEventListener('click', function(e) {
          const notificationItem = e.target.closest('.clickable-notification');
          if (notificationItem) {
            const message = notificationItem.dataset.message;
            const notificationId = notificationItem.dataset.id;
            handleNotificationClick(notificationItem, message, parseInt(notificationId));
          }
        });

        // Handle three-dot actions dropdown
        const actionsToggle = document.getElementById('actionsToggle');
        const actionsDropdown = document.getElementById('actionsDropdown');
        
        if (actionsToggle && actionsDropdown) {
          actionsToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            actionsDropdown.classList.toggle('active');
          });

          // Close dropdown when clicking outside
          document.addEventListener('click', function(e) {
            if (!actionsToggle.contains(e.target) && !actionsDropdown.contains(e.target)) {
              actionsDropdown.classList.remove('active');
            }
          });

          // Close dropdown when an action is clicked
          actionsDropdown.addEventListener('click', function() {
            actionsDropdown.classList.remove('active');
          });
        }
      });

      function handleNotificationClick(element, message, notificationId) {
        console.log('Notification clicked:', message, notificationId);
        
        // Mark as read visually
        if (element.classList.contains('unread')) {
          element.classList.remove('unread');
          const unreadIndicator = element.querySelector('.unread-indicator');
          if (unreadIndicator) {
            unreadIndicator.remove();
          }
          
          // Update count
          const currentBadge = document.getElementById('notificationCount');
          let count = currentBadge ? parseInt(currentBadge.textContent) : 0;
          if (count > 1) {
            currentBadge.textContent = count - 1;
          } else {
            if (currentBadge) currentBadge.remove();
          }
        }
        
        // Determine redirect URL based on message content
        let redirectUrl = '/userpanel/user_dashboard/'; // default fallback
        
        if (message.toLowerCase().includes('supply request') || message.toLowerCase().includes('request')) {
          redirectUrl = '/userpanel/user_request/';
        } else if (message.toLowerCase().includes('borrow')) {
          redirectUrl = '/userpanel/user_borrow/';
        } else if (message.toLowerCase().includes('reservation')) {
          redirectUrl = '/userpanel/user_reserve/';
        } else if (message.toLowerCase().includes('damage report')) {
          redirectUrl = '/userpanel/user_report/';
        }
        
        // Mark notification as read and redirect
        fetch('/mark-notification-read/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ 'notification_id': notificationId })
        }).then(() => {
          window.location.href = redirectUrl;
        }).catch(error => {
          console.error('Error marking notification as read:', error);
          window.location.href = redirectUrl;
        });
      }
      
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      function handleLogout() {
        if (confirm('Are you sure you want to log out?')) {
          document.getElementById('logout-form').submit();
        }
      }
    </script>
  </body>
</html>
