{% extends 'userpanel/user_base.html' %}

{% block title %}Damage Report{% endblock %}

{% block content %}
<style>
    /* Required field asterisk */
    .required-asterisk {
        color: #dc3545;
        margin-left: 3px;
    }

    /* ===== MOBILE MODAL STYLES (from unified request) ===== */
    .modal-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.3);
        z-index: 999998;
        animation: fadeIn 0.2s ease-out;
        pointer-events: none;
    }

    .modal-backdrop.active {
        display: block;
        pointer-events: auto;
    }

    .item-selection-modal {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        max-height: 50vh;
        height: auto;
        z-index: 999999;
        background: white;
        border-radius: 16px 16px 0 0;
        box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.15);
        animation: slideUpFromBottom 0.4s ease-out;
        overflow: hidden;
        display: none;
        flex-direction: column;
        touch-action: none;
    }

    @keyframes slideUpFromBottom {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes slideDownToBottom {
        from {
            transform: translateY(0);
            opacity: 1;
        }
        to {
            transform: translateY(100%);
            opacity: 0;
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    .item-selection-modal.active {
        display: flex;
    }

    .item-selection-modal.closing {
        animation: slideDownToBottom 0.3s ease-out forwards;
    }

    .modal-header {
        background: #152d64;
        color: white;
        padding: 12px 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex-shrink: 0;
        cursor: grab;
        cursor: -webkit-grab;
        user-select: none;
        -webkit-user-select: none;
        -webkit-user-drag: none;
        touch-action: none;
    }

    .modal-header.dragging {
        cursor: grabbing;
        cursor: -webkit-grabbing;
    }

    .modal-handle {
        width: 40px;
        height: 4px;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 2px;
        margin: 4px auto 0;
        transition: background 0.2s;
    }

    .modal-header:active .modal-handle {
        background: rgba(255, 255, 255, 0.8);
    }

    .modal-header h2 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .modal-search-wrapper {
        padding: 12px;
        background: #f8f9fa;
        border-bottom: 1px solid #e0e4e9;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .modal-search-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        background-color: white;
        box-sizing: border-box;
    }

    .modal-search-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
    }

    .modal-category-filter {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        background-color: white;
        box-sizing: border-box;
        min-height: 38px;
    }

    .modal-category-filter:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
    }

    .modal-content {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
    }

    .modal-items-list {
        display: flex;
        flex-direction: column;
        gap: 0;
    }

    .modal-item-option {
        padding: 14px 12px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
        transition: background-color 0.15s;
        -webkit-user-select: none;
        user-select: none;
    }

    .modal-item-option:active {
        background-color: #f0f7ff;
    }

    .modal-item-info {
        flex: 1;
        min-width: 0;
    }

    .modal-item-name {
        font-weight: 600;
        color: #2c3e50;
        font-size: 15px;
        margin-bottom: 4px;
    }

    .modal-item-details {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        font-size: 12px;
    }

    .modal-item-category {
        background-color: #e7f3ff;
        color: #0056b3;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 11px;
    }

    .modal-item-code {
        color: #6c757d;
        font-size: 11px;
    }

    .modal-item-stock {
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        white-space: nowrap;
    }

    .modal-item-stock.available {
        color: #28a745;
        background-color: #d4edda;
    }

    .modal-item-stock.low-stock {
        color: #dc3545;
        background-color: #f8d7da;
    }

    .modal-no-results {
        padding: 40px 16px;
        text-align: center;
        color: #6c757d;
    }

    .modal-no-results i {
        font-size: 48px;
        color: #ccc;
        margin-bottom: 10px;
    }

    /* ===== DESKTOP DROPDOWN STYLES ===== */
    .select-option {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.15s;
    }

    .select-option:hover {
        background-color: #f0f7ff;
    }

    .select-option:first-child {
        color: #999;
        font-style: italic;
    }

    .searchable-select-container {
        position: relative;
    }

    /* ===== MOBILE MEDIA QUERIES ===== */
    @media (max-width: 768px) {
        .select-dropdown {
            display: none !important;
        }

        .supply-search-input {
            font-size: 16px;
            min-height: 44px;
            cursor: pointer;
        }

        .supply-search-input[readonly] {
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
        }

        .modal-category-filter {
            min-height: 44px;
            font-size: 16px;
        }

        .item-selection-modal {
            max-height: 60vh;
        }
    }

    @media (max-width: 480px) {
        .modal-header h2 {
            font-size: 15px;
        }

        .modal-search-wrapper {
            padding: 8px;
            gap: 6px;
        }

        .modal-item-option {
            padding: 10px 8px;
        }

        .item-selection-modal {
            max-height: 65vh;
        }
    }

    .modal-content::-webkit-scrollbar {
        width: 6px;
    }

    .modal-content::-webkit-scrollbar-track {
        background: transparent;
    }

    .modal-content::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
    }

    .modal-content::-webkit-scrollbar-thumb:hover {
        background: #999;
    }

    body.modal-open {
        overflow: hidden;
    }

    /* Loading Overlay */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10001;
        justify-content: center;
        align-items: center;
    }

    .loading-overlay.active {
        display: flex;
    }

    .loading-content {
        background: white;
        padding: 30px 40px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #152d64;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        color: #152d64;
        font-size: 16px;
        font-weight: 600;
    }

    /* Tab Styles */
    .report-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        border-bottom: 2px solid #e1e5e9;
    }

    .tab-button {
        padding: 12px 24px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        color: #6c757d;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        bottom: -2px;
    }

    .tab-button:hover {
        color: #152d64;
        background: #f8f9fa;
    }

    .tab-button.active {
        color: #152d64;
        border-bottom-color: #152d64;
        background: #f8f9fa;
    }

    .tab-button i {
        margin-right: 8px;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    @media (max-width: 768px) {
        .report-tabs {
            gap: 5px;
        }

        .tab-button {
            padding: 10px 16px;
            font-size: 14px;
        }
    }
</style>
<div class="request-page-layout">
    <main class="request-form-container">
        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <div class="loading-text">Submitting report...</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="report-tabs">
            <button class="tab-button active" data-tab="damage-report">
                <i class="fas fa-exclamation-triangle"></i> Damage Report
            </button>
            <button class="tab-button" data-tab="lost-item-report">
                <i class="fas fa-search"></i> Lost Item Report
            </button>
        </div>

        <!-- Mobile Modal Backdrop -->
        <div id="modal-backdrop" class="modal-backdrop"></div>

        <!-- Properties Data (stored as JSON in data attribute) -->
        <div id="supplies-json-data" style="display:none;" data-supplies='[
            {% for supply in available_supplies %}
            {
                "id": {{ supply.id }},
                "name": "{{ supply.property_name|escapejs }}",
                "category_id": {{ supply.category.id|default:"0" }},
                "category_name": "{{ supply.category.name|default:"Equipment"|escapejs }}",
                "code": "{% if supply.property_number %}{{ supply.property_number|escapejs }}{% elif supply.barcode %}{{ supply.barcode|escapejs }}{% else %}ID-{{ supply.id }}{% endif %}",
                "description": "{{ supply.property_name|escapejs }}",
                "available": {{ supply.quantity }},
                "condition": "{{ supply.condition|escapejs }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]'></div>

        <!-- Item Selection Modal (Mobile) - For Damage Report -->
        <div id="item-selection-modal" class="item-selection-modal">
            <div class="modal-header" id="item-modal-handle">
                <div class="modal-handle"></div>
                <h2 id="modal-title"><i class="fas fa-exclamation-triangle"></i> Select Equipment to Report</h2>
            </div>
            <div class="modal-search-wrapper">
                <input type="text" id="item-modal-search" class="modal-search-input" 
                       placeholder="Search by name or code..." autocomplete="off">
                <select id="item-modal-category" class="modal-category-filter">
                    <option value="">All Categories</option>
                    {% for category in supply_categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="modal-content">
                <div id="item-modal-items-list" class="modal-items-list">
                    <!-- Items will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Damage Report Tab Content -->
        <div id="damage-report-content" class="tab-content active">
            <h1><i class="fas fa-exclamation-triangle"></i> Damage Report</h1>
            <p class="form-description">Please fill out the form below to report damaged items. Make sure to provide accurate information for faster processing.</p>

            {% if form.errors %}
            <ul class="errorlist form-top-errors">
                {% for field in form %}
                    {% for error in field.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
            {% endif %}

            <form id="damage-report-form" method="post" action="{% url 'user_report' %}" class="request-form" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- Item Search for Damage Report -->
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label for="supply-search" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Equipment/Item Damaged:<span class="required-asterisk">*</span></label>
                    <div class="searchable-select-container">
                        <input type="text" id="supply-search" class="form-control supply-search-input" 
                               placeholder="Search for the damaged item..." autocomplete="off">
                        <input type="hidden" id="supply-select" name="item">
                        <div id="supply-dropdown" class="select-dropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #e1e5e9; max-height: 300px; overflow-y: auto; z-index: 9999; display: none;">
                            <div class="select-option" data-value="">Select an item...</div>
                            {% for supply in available_supplies %}
                            <div class="select-option" data-value="{{ supply.id }}" data-available="{{ supply.quantity }}">
                                {{ supply.property_name }} - {% if supply.property_number %}{{ supply.property_number }}{% elif supply.barcode %}{{ supply.barcode }}{% else %}ID-{{ supply.id }}{% endif %} ({{ supply.category.name }})
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Form fields excluding 'item' since we handle it above -->
                <div class="form-group">
                    <label for="{{ form.description.id_for_label }}">{{ form.description.label|safe }}</label>
                    {{ form.description }}
                    {% if form.description.errors %}<span class="field-error">{{ form.description.errors }}</span>{% endif %}
                </div>
                <div class="form-group">
                    {{ form.image.label_tag }}
                    {{ form.image }}
                    {% if form.image.help_text %}<small class="form-text">{{ form.image.help_text }}</small>{% endif %}
                    {% if form.image.errors %}<span class="field-error">{{ form.image.errors }}</span>{% endif %}
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-submit">
                        <i class="fas fa-paper-plane"></i> Submit Report
                    </button>
                    <button type="reset" class="btn-reset">
                        <i class="fas fa-undo"></i> Clear Form
                    </button>
                </div>
            </form>
        </div>

        <!-- Lost Item Report Tab Content -->
        <div id="lost-item-report-content" class="tab-content">
            <h1><i class="fas fa-search"></i> Lost Item Report</h1>
            <p class="form-description">Report a lost or missing item. Provide as much detail as possible to help locate the item.</p>

            <form id="lost-item-report-form" method="post" action="{% url 'report_lost_item_user' %}" class="request-form" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- Item Search for Lost Item Report -->
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label for="lost-item-search" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Lost Equipment/Item:<span class="required-asterisk">*</span></label>
                    <div class="searchable-select-container">
                        <input type="text" id="lost-item-search" class="form-control supply-search-input" 
                               placeholder="Search for the lost item..." autocomplete="off">
                        <input type="hidden" id="lost-item-select" name="item">
                        <div id="lost-item-dropdown" class="select-dropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #e1e5e9; max-height: 300px; overflow-y: auto; z-index: 9999; display: none;">
                            <div class="select-option" data-value="">Select an item...</div>
                            {% for supply in available_supplies %}
                            <div class="select-option" data-value="{{ supply.id }}" data-available="{{ supply.quantity }}">
                                {{ supply.property_name }} - {% if supply.property_number %}{{ supply.property_number }}{% elif supply.barcode %}{{ supply.barcode }}{% else %}ID-{{ supply.id }}{% endif %} ({{ supply.category.name }})
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="lost-item-description">Description of Loss:<span class="required-asterisk">*</span></label>
                    <textarea id="lost-item-description" name="description" class="form-control" rows="4" 
                              placeholder="Describe the circumstances of the loss..." required></textarea>
                </div>

                <div class="form-group">
                    <label for="last-seen-location">Last Seen Location:</label>
                    <input type="text" id="last-seen-location" name="last_seen_location" class="form-control" 
                           placeholder="Where was the item last seen?">
                </div>

                <div class="form-group">
                    <label for="last-seen-date">Last Seen Date:</label>
                    <input type="date" id="last-seen-date" name="last_seen_date" class="form-control">
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-submit">
                        <i class="fas fa-paper-plane"></i> Submit Report
                    </button>
                    <button type="reset" class="btn-reset">
                        <i class="fas fa-undo"></i> Clear Form
                    </button>
                </div>
            </form>
        </div>
    </main>

    <aside class="recent-requests">
        <h2><i class="fas fa-history"></i> Recent Reports</h2>
        
        <!-- Recent Damage Reports -->
        <div id="recent-damage-reports" class="recent-section" style="display: block;">
            <h3 style="font-size: 14px; color: #6c757d; margin-bottom: 10px;">Damage Reports</h3>
            {% if recent_requests %}
                <div class="requests-list">
                    {% for request in recent_requests %}
                    <div class="request-card" data-request-id="{{ request.id }}">
                        <div class="request-header">
                            <span class="request-date">{{ request.date|date:"M d, Y" }}</span>
                            <span class="status-badge status-{{ request.status|lower }}">{{ request.status|title }}</span>
                        </div>
                        <div class="request-details">
                            <p class="supply-name">{{ request.item }}</p>
                            <p class="description">Description: {{ request.description|truncatechars:100 }}</p>
                            {% if request.status == 'pending' %}
                            <button class="btn-cancel-request" data-request-id="{{ request.id }}" data-request-type="damage-report">
                                <i class="fas fa-times"></i> Cancel Report
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-requests">
                    <i class="fas fa-inbox"></i>
                    <p>No recent damage reports</p>
                </div>
            {% endif %}
        </div>

        <!-- Recent Lost Item Reports -->
        <div id="recent-lost-reports" class="recent-section" style="display: none;">
            <h3 style="font-size: 14px; color: #6c757d; margin-bottom: 10px;">Lost Item Reports</h3>
            {% if recent_lost_items %}
                <div class="requests-list">
                    {% for item in recent_lost_items %}
                    <div class="request-card" data-request-id="{{ item.id }}">
                        <div class="request-header">
                            <span class="request-date">{{ item.date|date:"M d, Y" }}</span>
                            <span class="status-badge status-{{ item.status|lower }}">{{ item.status|title }}</span>
                        </div>
                        <div class="request-details">
                            <p class="supply-name">{{ item.item }}</p>
                            <p class="description">{{ item.description|truncatechars:100 }}</p>
                            {% if item.last_seen_location %}
                            <p class="description"><small>Last seen: {{ item.last_seen_location }}</small></p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-requests">
                    <i class="fas fa-inbox"></i>
                    <p>No recent lost item reports</p>
                </div>
            {% endif %}
        </div>
    </aside>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching functionality
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            
            // Remove active class from all tabs and contents
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            this.classList.add('active');
            document.getElementById(tabName + '-content').classList.add('active');
            
            // Switch recent reports section
            if (tabName === 'damage-report') {
                document.getElementById('recent-damage-reports').style.display = 'block';
                document.getElementById('recent-lost-reports').style.display = 'none';
            } else if (tabName === 'lost-item-report') {
                document.getElementById('recent-damage-reports').style.display = 'none';
                document.getElementById('recent-lost-reports').style.display = 'block';
            }
        });
    });

    // Event delegation for cancel buttons
    const requestsList = document.querySelector('.requests-list');
    if (requestsList) {
        requestsList.addEventListener('click', function(e) {
            const cancelButton = e.target.closest('.btn-cancel-request');
            if (cancelButton) {
                const requestId = cancelButton.dataset.requestId;
                const requestType = cancelButton.dataset.requestType;
                cancelRequest(requestId, requestType);
            }
        });
    }

    // File input enhancement
    const fileInput = document.querySelector('input[type="file"]');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Check file size (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    showToast('File size too large. Please choose an image under 5MB.', 'error');
                    e.target.value = '';
                    return;
                }

                // Check file type
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    showToast('Please upload a valid image file (JPG, PNG, GIF, BMP, WebP).', 'error');
                    e.target.value = '';
                    return;
                }

                // Show success message
                showToast(`Image "${file.name}" selected successfully.`, 'success');
            }
        });
    }

    // Form submission loading handlers
    const damageReportForm = document.getElementById('damage-report-form');
    const lostItemReportForm = document.getElementById('lost-item-report-form');
    const loadingOverlay = document.getElementById('loading-overlay');

    function showLoading() {
        loadingOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function hideLoading() {
        loadingOverlay.classList.remove('active');
        document.body.style.overflow = '';
    }

    if (damageReportForm) {
        damageReportForm.addEventListener('submit', function(e) {
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
            }
            showLoading();
            
            // If form validation fails, re-enable button and hide loading
            setTimeout(() => {
                if (!this.checkValidity()) {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                    }
                    hideLoading();
                }
            }, 100);
        });
    }

    if (lostItemReportForm) {
        lostItemReportForm.addEventListener('submit', function(e) {
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
            }
            showLoading();
            
            // If form validation fails, re-enable button and hide loading
            setTimeout(() => {
                if (!this.checkValidity()) {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                    }
                    hideLoading();
                }
            }, 100);
        });
    }
});

function showToast(message, type = 'success') {
    // Create toast with inline styles to override any CSS conflicts
    const toast = document.createElement('div');
    
    // Apply inline styles directly for maximum control
    Object.assign(toast.style, {
        position: 'fixed',
        top: '20px',
        right: '20px',
        maxWidth: '280px',
        padding: '10px 14px',
        borderRadius: '6px',
        backgroundColor: type === 'success' ? '#28a745' : '#dc3545',
        color: 'white',
        fontSize: '13px',
        fontWeight: '500',
        display: 'flex',
        alignItems: 'center',
        gap: '10px',
        boxShadow: '0 4px 12px rgba(0, 0, 0, 0.15)',
        zIndex: '10000',
        opacity: '0',
        transform: 'translateX(100%)',
        transition: 'all 0.3s ease'
    });
    
    // Add icon and message
    const icon = document.createElement('i');
    icon.className = `fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}`;
    icon.style.fontSize = '16px';
    icon.style.flexShrink = '0';
    
    const span = document.createElement('span');
    span.textContent = message;
    span.style.flex = '1';
    span.style.wordBreak = 'break-word';
    
    toast.appendChild(icon);
    toast.appendChild(span);
    document.body.appendChild(toast);

    // Trigger animation
    requestAnimationFrame(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateX(0)';
    });

    // Remove after 6 seconds with fade-out
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 6000);
}

function cancelRequest(requestId, type) {
    if (!confirm('Are you sure you want to cancel this report?')) {
        return;
    }

    const url = `/userpanel/cancel-${type}/${requestId}/`;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Update the status badge
            const requestCard = document.querySelector(`[data-request-id="${requestId}"]`);
            const statusBadge = requestCard.querySelector('.status-badge');
            statusBadge.className = 'status-badge status-cancelled';
            statusBadge.textContent = 'cancelled';
            
            // Remove the cancel button
            const cancelButton = requestCard.querySelector('.btn-cancel-request');
            if (cancelButton) {
                cancelButton.remove();
            }

            showToast(data.message);
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        showToast('An error occurred while cancelling the report', 'error');
    });
}
</script>

<script>
// ===== LOAD MODAL DATA FROM DATA ATTRIBUTE =====
let allSupplies = [];
document.addEventListener('DOMContentLoaded', function() {
    const suppliesDataElement = document.getElementById('supplies-json-data');
    console.log('[REPORT] supplies-json-data element:', suppliesDataElement);
    if (suppliesDataElement) {
        try {
            const jsonString = suppliesDataElement.getAttribute('data-supplies');
            console.log('[REPORT] Raw JSON string:', jsonString);
            allSupplies = JSON.parse(jsonString);
            console.log('[REPORT] Loaded supplies:', allSupplies.length, 'items');
            console.log('[REPORT] First item:', allSupplies[0]);
        } catch (e) {
            console.error('[REPORT] Failed to parse supplies data:', e);
            console.error('[REPORT] Raw data:', suppliesDataElement.getAttribute('data-supplies'));
            allSupplies = [];
        }
    } else {
        console.error('[REPORT] supplies-json-data element not found');
    }
});

// ===== MOBILE MODAL FUNCTIONS (from unified request) =====
function closeModal(animate = true) {
    const modal = document.getElementById('item-selection-modal');
    const backdrop = document.getElementById('modal-backdrop');
    
    if (animate) {
        modal.classList.add('closing');
        setTimeout(() => {
            modal.classList.remove('active', 'closing');
            backdrop.classList.remove('active');
            document.body.classList.remove('modal-open');
        }, 300);
    } else {
        modal.classList.remove('active', 'closing');
        backdrop.classList.remove('active');
        document.body.classList.remove('modal-open');
    }
}

function openModal(modalType = 'damage') {
    const isMobile = window.innerWidth <= 768;
    if (!isMobile) return;
    
    const modal = document.getElementById('item-selection-modal');
    const backdrop = document.getElementById('modal-backdrop');
    const modalTitle = document.getElementById('modal-title');
    
    // Update modal title based on type
    if (modalType === 'lost') {
        modalTitle.innerHTML = '<i class="fas fa-search"></i> Select Lost Item';
    } else {
        modalTitle.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Select Equipment to Report';
    }
    
    modal.classList.add('active');
    backdrop.classList.add('active');
    document.body.classList.add('modal-open');
    
    populateModalItems(modalType);
    setupDragToDismiss();
}

function setupDragToDismiss() {
    const modal = document.getElementById('item-selection-modal');
    const handle = document.getElementById('item-modal-handle');
    
    let startY = 0;
    let currentY = 0;
    let isDragging = false;
    
    function onTouchStart(e) {
        startY = e.touches[0].clientY;
        currentY = startY;
        isDragging = true;
        handle.classList.add('dragging');
    }
    
    function onTouchMove(e) {
        if (!isDragging) return;
        currentY = e.touches[0].clientY;
        const diff = currentY - startY;
        
        if (diff > 0) {
            modal.style.transform = `translateY(${diff}px)`;
            modal.style.borderRadius = `${16 - (diff / 50) * 4}px ${16 - (diff / 50) * 4}px 0 0`;
        }
    }
    
    function onTouchEnd(e) {
        if (!isDragging) return;
        isDragging = false;
        handle.classList.remove('dragging');
        
        const diff = currentY - startY;
        const threshold = 100;
        
        if (diff > threshold) {
            modal.style.transform = '';
            modal.style.borderRadius = '';
            closeModal(true);
        } else {
            modal.style.transform = '';
            modal.style.borderRadius = '';
        }
    }
    
    handle.removeEventListener('touchstart', onTouchStart);
    handle.removeEventListener('touchmove', onTouchMove);
    document.removeEventListener('touchend', onTouchEnd);
    
    handle.addEventListener('touchstart', onTouchStart, { passive: true });
    handle.addEventListener('touchmove', onTouchMove, { passive: true });
    document.addEventListener('touchend', onTouchEnd, { passive: true });
}

function populateModalItems(modalType = 'damage') {
    const listContainer = document.getElementById('item-modal-items-list');
    const searchInput = document.getElementById('item-modal-search');
    const categoryFilter = document.getElementById('item-modal-category');
    
    window.currentModalType = modalType;
    
    function filterAndRender() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const selectedCategory = categoryFilter.value.trim();
        
        const filtered = allSupplies.filter(item => {
            const matchesSearch = !searchTerm || 
                item.name.toLowerCase().includes(searchTerm) ||
                item.code.toLowerCase().includes(searchTerm) ||
                item.description.toLowerCase().includes(searchTerm);
            
            const matchesCategory = !selectedCategory || 
                String(item.category_id) === String(selectedCategory);
            
            return matchesSearch && matchesCategory;
        });
        
        if (filtered.length === 0) {
            listContainer.innerHTML = `
                <div class="modal-no-results">
                    <div><i class="fas fa-inbox"></i></div>
                    <p>No items found</p>
                </div>
            `;
            return;
        }
        
        listContainer.innerHTML = filtered.map(item => `
            <div class="modal-item-option" onclick="selectItemFromModal(${item.id}, '${(item.name + ' - ' + item.code).replace(/'/g, "\\'")}', ${item.available})">
                <div class="modal-item-info">
                    <div class="modal-item-name">${item.name} - ${item.code}</div>
                    <div class="modal-item-details">
                        <span class="modal-item-category">${item.category_name}</span>
                    </div>
                </div>
                <div class="modal-item-stock ${item.available < 10 ? 'low-stock' : 'available'}">
                    ${item.available} available
                </div>
            </div>
        `).join('');
    }
    
    filterAndRender();
    
    searchInput.removeEventListener('input', filterAndRender);
    categoryFilter.removeEventListener('change', filterAndRender);
    searchInput.addEventListener('input', filterAndRender);
    categoryFilter.addEventListener('change', filterAndRender);
}

function selectItemFromModal(itemId, itemName, available) {
    closeModal(false);
    
    const modalType = window.currentModalType || 'damage';
    
    if (modalType === 'lost') {
        document.getElementById('lost-item-search').value = itemName;
        document.getElementById('lost-item-select').value = itemId;
    } else {
        document.getElementById('supply-search').value = itemName;
        document.getElementById('supply-select').value = itemId;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('modal-backdrop').addEventListener('click', function() {
        if (document.getElementById('item-selection-modal').classList.contains('active')) {
            closeModal();
        }
    });
    
    // ===== DESKTOP DROPDOWN HANDLER =====
    const supplySearch = document.getElementById('supply-search');
    const supplyDropdown = document.getElementById('supply-dropdown');
    const supplySelect = document.getElementById('supply-select');
    const selectOptions = document.querySelectorAll('.select-option');
    
    if (window.innerWidth > 768) {
        // Desktop: Show dropdown on input focus
        supplySearch.addEventListener('focus', function() {
            supplyDropdown.style.display = 'block';
        });
        
        // Filter and search functionality
        supplySearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const options = supplyDropdown.querySelectorAll('.select-option');
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                if (text.includes(searchTerm) || searchTerm === '') {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        });
        
        // Handle option selection
        supplyDropdown.addEventListener('click', function(e) {
            const option = e.target.closest('.select-option');
            if (option) {
                const value = option.dataset.value;
                const text = option.textContent.trim();
                
                supplySearch.value = text === 'Select an item...' ? '' : text;
                supplySelect.value = value;
                supplyDropdown.style.display = 'none';
            }
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target !== supplySearch && e.target !== supplyDropdown) {
                supplyDropdown.style.display = 'none';
            }
        });
    } else {
        // Mobile: Use modal
        supplySearch.setAttribute('readonly', 'readonly');
        
        supplySearch.addEventListener('focus', function(e) {
            e.preventDefault();
            this.blur();
        });
        
        supplySearch.addEventListener('click', function(e) {
            e.preventDefault();
            openModal('damage');
        });
    }

    // ===== LOST ITEM SEARCH SETUP =====
    const lostItemSearch = document.getElementById('lost-item-search');
    const lostItemDropdown = document.getElementById('lost-item-dropdown');
    const lostItemSelect = document.getElementById('lost-item-select');
    
    if (window.innerWidth > 768) {
        // Desktop: Show dropdown on input focus
        lostItemSearch.addEventListener('focus', function() {
            lostItemDropdown.style.display = 'block';
        });
        
        // Filter and search functionality
        lostItemSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const options = lostItemDropdown.querySelectorAll('.select-option');
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                if (text.includes(searchTerm) || searchTerm === '') {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        });
        
        // Handle option selection
        lostItemDropdown.addEventListener('click', function(e) {
            const option = e.target.closest('.select-option');
            if (option) {
                const value = option.dataset.value;
                const text = option.textContent.trim();
                
                lostItemSearch.value = text === 'Select an item...' ? '' : text;
                lostItemSelect.value = value;
                lostItemDropdown.style.display = 'none';
            }
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target !== lostItemSearch && e.target !== lostItemDropdown) {
                lostItemDropdown.style.display = 'none';
            }
        });
    } else {
        // Mobile: Use modal
        lostItemSearch.setAttribute('readonly', 'readonly');
        
        lostItemSearch.addEventListener('focus', function(e) {
            e.preventDefault();
            this.blur();
        });
        
        lostItemSearch.addEventListener('click', function(e) {
            e.preventDefault();
            openModal('lost');
        });
    }
});
</script>
{% endblock %}
